--list of transactions
SELECT DISTINCT
       fcb.booking_id,
       stmc.touch_mkt_channel,
       stmc.affiliate,
       stmc.utm_source,
       stmc.utm_medium,
       stmc.utm_campaign,
       fcb.margin_gross_of_toms_gbp_constant_currency AS margin

FROM se.data.scv_touch_basic_attributes stba
    INNER JOIN se.data.scv_touched_transactions stt ON stba.touch_id = stt.touch_id
    LEFT JOIN  se.data.fact_complete_booking fcb ON stt.booking_id = fcb.booking_id
    INNER JOIN se.data.scv_touch_marketing_channel stmc ON stba.touch_id = stmc.touch_id
WHERE fcb.transaction_id IN ('A26988-18666-5745435',
                             'A15184-14508-5744943',
                             'A11112-12431-5744804',
                             'A12299-13086-5744309',
                             'A37246-22216-5744229',
                             'A32632-20457-5744132',
                             'A29812-19568-5743997',
                             'A11061-12385-5743993',
                             'A15738-14784-5743595',
                             'A31033-19957-5743027',
                             'A13359-13598-5742732',
                             'A13625-13732-5742486',
                             'A11006-12325-5742423',
                             'A17306-15513-5742169',
                             'A11536-20982-5742156',
                             'A11873-12888-5742025',
                             'A11650-20433-5741765',
                             'A14524-16810-5741415',
                             'A27479-18846-5741332',
                             'A28321-19128-5741355',
                             'A15653-14730-5741315',
                             'A31911-20276-5741092',
                             'A10803-12205-5740657',
                             'A32198-20356-5740437',
                             'A28511-20823-5740418',
                             'A15616-14647-5740361',
                             'A14647-14212-5740020',
                             'A28973-19328-5739744',
                             'A11543-12720-5739666',
                             'A14079-20879-5739556',
                             'A16197-14957-5739491',
                             'A29479-19436-5739217',
                             'A14051-13927-5738980',
                             'A32421-20412-5738930',
                             'A16625-15171-5738563',
                             'A17826-15709-5738234',
                             'A10846-12232-5738075',
                             'A16589-15149-5738096',
                             'A16934-15308-5737960',
                             'A11061-12385-5737991',
                             'A15164-14495-5737609',
                             'A12620-13218-5737063',
                             'A12620-13218-5736101',
                             'A30316-19762-5736055',
                             'A27582-18848-5735701',
                             'A32198-20356-5735133',
                             'A33057-20631-5734578',
                             'A16341-15041-5734509',
                             'A11683-12795-5734407',
                             'A36324-21850-5734131',
                             'A13452-13636-5733935',
                             'A23595-17452-5733716',
                             'A16642-15180-5733578',
                             'A11776-12841-5733613',
                             'A11077-12399-5733493',
                             'A26046-18323-5733424',
                             'A19602-16224-5732423',
                             'A17607-15627-5732451',
                             'A31097-19980-5732139',
                             'A36014-21707-5731354',
                             'A11645-12775-5731096',
                             'A12696-13260-5731093',
                             'A36860-22061-5730712',
                             'A21947-16857-5730318',
                             'A32198-20356-5730294',
                             'A11240-12544-5730094',
                             'A30877-19866-5729953',
                             'A11620-12761-5729879',
                             'A21500-16773-5729413',
                             'A22365-17059-5729328',
                             'A10762-12176-5759981',
                             'A19924-16327-5759835',
                             'A11107-2744-5759643',
                             'A37445-22283-5759518',
                             'A26988-18667-5759472',
                             'A22763-16104-5759138',
                             'A32614-20454-5759069',
                             'A14094-13948-5759017',
                             'A13359-13598-5758962',
                             'A25822-18263-5758890',
                             'A12201-13039-5758611',
                             'A13415-13629-5758633',
                             'A14079-20879-5758500',
                             'A29772-19586-5758288',
                             'A12515-13174-5758098',
                             'A11346-12576-5757753',
                             'A32421-20411-5757678',
                             'A11509-12685-5757651',
                             'A16866-17387-5757580',
                             'A35138-11845-5757539',
                             'A10884-12269-5757058',
                             'A11616-12741-5756693',
                             'A37445-22283-5756558',
                             'A34932-21251-5756376',
                             'A11764-17501-5756309',
                             'A12137-12891-5756251',
                             'A35838-21706-5756245',
                             'A33654-20838-5756205',
                             'A34932-21253-5756115',
                             'A13017-13433-5755948',
                             'A29899-19614-5755896',
                             'A12299-13086-5755766',
                             'A32632-20457-5755624',
                             'A19025-16028-5755110',
                             'A11492-20-5754912',
                             'A19639-16240-5754706',
                             'A21822-18529-5754635',
                             'A14593-14197-5754430',
                             'A26062-18285-5754284',
                             'A20792-16599-5754208',
                             'A12318-13104-5754264',
                             'A13060-13249-5754095',
                             'A34051-20900-5754017',
                             'A12916-13394-5753767',
                             'A10648-12121-5753485',
                             'A14647-14212-5753092',
                             'A11038-21214-5752780',
                             'A15266-19315-5752661',
                             'A27947-18968-5752595',
                             'A14634-14209-5752610',
                             'A16041-14911-5752482',
                             'A19818-16307-5752158',
                             'A28557-19200-5752162',
                             'A16792-15245-5752014',
                             'A13162-13517-5751879',
                             'A23667-20712-5751757',
                             'A11670-12788-5751785',
                             'A21004-17694-5751582',
                             'A12264-13062-5751471',
                             'A10727-12157-5751442',
                             'A14628-14156-5751210',
                             'A29383-19445-5751194',
                             'A14649-16810-5751029',
                             'A12515-13173-5750930',
                             '113178-919047-54886914',
                             'A11444-12397-5750746',
                             'A19916-16345-5750679',
                             'A26301-18115-5750342',
                             'A11151-12465-5749980',
                             'A37167-22186-5749876',
                             'A15491-14620-5749433',
                             'A14501-14151-5749578',
                             'A33070-20643-5748786',
                             'A34022-20954-5748726',
                             'A19265-16073-5748653',
                             'A11443-12649-5748433',
                             'A10980-12308-5747894',
                             'A15153-14483-5747755',
                             'A31306-20089-5747303',
                             'A22983-17326-5747102',
                             'A25669-19874-5746802',
                             'A20246-16476-5746635',
                             'A16848-15278-5746323',
                             'A32030-20297-5745606',
                             'A32030-20297-5745594',
                             'A16194-14960-5745592',
                             'A36351-21683-5773545',
                             'A16197-14957-5773411',
                             'A22248-17017-5772842',
                             'A35631-21582-5772817',
                             'A15299-14389-5772464',
                             'A11509-12685-5772380',
                             'A20597-16558-5772340',
                             'A12154-13008-5772175',
                             'A26555-18478-5772211',
                             'A11509-12687-5772180',
                             'A20168-16455-5771988',
                             'A33276-20725-5772022',
                             'A21734-17806-5771997',
                             'A16061-14917-5771954',
                             'A13425-13635-5771934',
                             'A19948-16365-5771745',
                             'A17329-22100-5771729',
                             'A25933-18277-5771681',
                             'A11317-18930-5771690',
                             'A19824-16311-5771263',
                             'A14131-13961-5771185',
                             'A16242-14984-5770637',
                             'A28128-19083-5770517',
                             'A11791-12845-5770440',
                             'A11084-12410-5770046',
                             'A11232-21912-5770187',
                             'A11776-12841-5769029',
                             'A16343-15044-5768645',
                             'A18864-15983-5768818',
                             'A36240-21818-5768765',
                             'A35153-21241-5768714',
                             'A22122-18529-5768669',
                             'A32464-20427-5768707',
                             'A12302-414-5768693',
                             'A12916-13394-5768511',
                             'A11491-17215-5768431',
                             'A37793-22387-5768421',
                             'A32696-20468-5768414',
                             'A14158-13986-5767958',
                             'A11992-12941-5767792',
                             'A28973-19327-5767836',
                             'A32142-20330-5767594',
                             'A17001-15334-5767486',
                             'A14600-20550-5767192',
                             'A11939-16335-5767026',
                             'A31876-20085-5766958',
                             'A11481-12662-5766789',
                             'A13027-13434-5766408',
                             'A12007-12959-5766304',
                             'A20727-16583-5765879',
                             'A16589-15151-5765891',
                             'A17654-15634-5765888',
                             'A13025-16372-5765818',
                             'A11491-17215-5765774',
                             'A37400-22189-5765719',
                             'A19660-16235-5765709',
                             'A13412-13623-5765519',
                             'A26988-18666-5765530',
                             'A37445-22283-5765399',
                             'A35045-21312-5765252',
                             'A25492-18089-5765170',
                             'A32632-20457-5764965',
                             'A26988-18667-5764959',
                             'A13038-13440-5764941',
                             'A16258-14999-5764913',
                             'A16258-14999-5764841',
                             'A14791-14300-5764724',
                             'A14734-14264-5764412',
                             'A12982-13419-5764221',
                             'A14959-14395-5763807',
                             'A17382-18814-5763258',
                             'A29947-19625-5763086',
                             'A36035-21735-5763012',
                             'A12117-12959-5762772',
                             'A17880-15715-5762664',
                             'A37445-22283-5762435',
                             'A11934-12889-5762441',
                             'A35894-21650-5762055',
                             'A24325-396-5761900',
                             'A30708-19867-5761822',
                             'A31436-20104-5761708',
                             'A13025-16372-5761286',
                             'A29441-19488-5760938',
                             'A17654-15635-5760936',
                             'A21822-16846-5760307',
                             'A14700-14245-5760247',
                             'A28128-19083-5760163',
                             'A12788-18237-5760120',
                             'A11904-12876-5788087',
                             'A11498-12674-5787965',
                             'A16968-21316-5787824',
                             'A35463-21315-5787618',
                             'A37445-22283-5787382',
                             'A26988-18666-5787093',
                             'A24320-17809-5786856',
                             'A18195-15790-5786738',
                             'A27917-19004-5786632',
                             'A35613-21575-5786389',
                             'A20786-16595-5786277',
                             'A22763-16104-5785979',
                             'A19287-16116-5785666',
                             'A27947-18968-5785657',
                             'A12207-13046-5785336',
                             'A37359-22264-5785328',
                             'A15263-14680-5785217',
                             'A15263-14533-5785052',
                             'A35478-21540-5784347',
                             'A11882-12895-5783716',
                             'A14793-14306-5783496',
                             'A28802-19263-5783106',
                             'A14793-14305-5783328',
                             'A37451-22291-5782774',
                             'A14647-14212-5782669',
                             'A16740-15217-5782438',
                             'A29363-19434-5782357',
                             'A25319-18035-5782224',
                             'A11776-12841-5781995',
                             'A26988-18667-5781459',
                             'A12620-13218-5781189',
                             'A16589-15151-5780846',
                             'A10918-20414-5780753',
                             'A13572-13713-5780393',
                             'A21822-18529-5780192',
                             'A37246-22216-5780181',
                             'A29790-16948-5780067',
                             'A32169-20344-5779724',
                             'A12270-13068-5779562',
                             'A29242-19392-5779476',
                             'A13412-13625-5779441',
                             'A11708-12812-5779273',
                             'A16031-14910-5779274',
                             'A32773-20493-5778922',
                             'A18195-15790-5778843',
                             'A35011-21293-5778807',
                             'A21822-18529-5778750',
                             'A21822-18529-5778722',
                             'A18893-16000-5778583',
                             'A14165-13992-5778562',
                             'A29345-19414-5778551',
                             'A21822-18529-5777969',
                             'A12299-13086-5777693',
                             '113184-920609-54889008',
                             'A18893-16000-5777646',
                             'A17911-15724-5777548',
                             'A33896-20908-5777362',
                             'A12554-13094-5777069',
                             'A13494-13664-5777085',
                             'A34374-21067-5777029',
                             'A26036-18320-5776833',
                             'A12894-13378-5776734',
                             'A16304-15024-5776648',
                             'A19930-16354-5776552',
                             'A29393-19443-5776473',
                             'A36741-21979-5775988',
                             'A11612-12762-5775705',
                             'A15939-16111-5774741',
                             'A12707-20873-5774230',
                             'A10936-12289-5774159',
                             'A15208-14512-5801135',
                             'A12620-13219-5800901',
                             'A22570-17179-5800759',
                             'A30635-19857-5800764',
                             'A20892-16606-5800752',
                             'A27479-18846-5800595',
                             'A27330-18787-5799513',
                             'A37445-22283-5799212',
                             'A12864-13372-5798530',
                             'A11061-12385-5798922',
                             'A14524-18499-5798720',
                             'A10732-12164-5798619',
                             'A29360-19433-5798507',
                             'A33784-20875-5798329',
                             'A13776-13750-5798246',
                             'A13625-13732-5798227',
                             'A21674-16796-5798131',
                             'A14524-14161-5797850',
                             'A31306-20089-5797677',
                             'A29673-19562-5797283',
                             'A10975-12303-5797274',
                             'A32395-20413-5797020',
                             'A12148-13006-5796393',
                             'A18893-16000-5796422',
                             'A37246-22216-5796460',
                             'A37246-22216-5796405',
                             'A32395-20411-5796364',
                             'A22181-16995-5796104',
                             'A15164-14495-5795945',
                             'A19287-16116-5795820',
                             'A11397-12615-5795708',
                             'A10632-12109-5795649',
                             'A29504-19513-5795016',
                             'A11235-12508-5794918',
                             'A25845-18283-5794771',
                             'A14331-14792-5794707',
                             'A21292-16713-5794354',
                             'A33654-20840-5794299',
                             'A32632-20457-5794207',
                             'A37246-22216-5794141',
                             'A17464-15521-5793629',
                             'A11939-12924-5793814',
                             'A10648-15444-5793539',
                             'A14894-14176-5793203',
                             'A15765-14803-5793463',
                             'A11151-12465-5793289',
                             'A14524-16810-5793053',
                             'A12458-13153-5792725',
                             'A10799-12203-5792779',
                             'A35216-21379-5792551',
                             'A15761-14795-5792362',
                             'A13552-13700-5792278',
                             'A36146-21809-5792233',
                             'A37867-22415-5792169',
                             'A31780-20131-5792202',
                             'A17382-20429-5792039',
                             'A21822-16846-5790919',
                             'A14260-14029-5790771',
                             'A31681-20799-5790588',
                             'A21822-16846-5790428',
                             'A20745-16558-5790121',
                             'A14791-14304-5789898',
                             'A30603-19854-5789220',
                             'A10660-20182-5789111',
                             'A20020-16252-5814539',
                             'A29772-19586-5814493',
                             'A29360-19433-5814468',
                             'A11346-12576-5814108',
                             'A12812-13214-5813530',
                             'A12124-12862-5813214',
                             'A14959-14395-5812808',
                             'A11200-18467-5812718',
                             'A36860-22065-5812707',
                             'A21677-16811-5812205',
                             'A10648-15444-5812122',
                             'A10775-12184-5811789',
                             'A34932-21253-5811782',
                             'A11238-12509-5811433',
                             'A17405-12466-5811485',
                             'A20114-16413-5811392',
                             'A26102-18347-5811017',
                             'A15738-14786-5810955',
                             'A13793-13804-5810736',
                             'A12620-13219-5810592',
                             'A13272-13552-5810593',
                             'A11072-12046-5810210',
                             'A33654-20840-5810139',
                             'A20969-16642-5810000',
                             'A28498-19188-5809852',
                             'A14524-18499-5809659',
                             'A13502-13667-5809349',
                             'A35643-21599-5809207',
                             'A31908-20255-5809215',
                             'A18361-15852-5809202',
                             'A13025-16372-5809097',
                             'A11072-12045-5808861',
                             'A15263-14680-5808705',
                             'A14430-22236-5808555',
                             'A30622-19855-5808482',
                             'A10648-12121-5808499',
                             'A19797-16292-5808366',
                             'A36634-21915-5808163',
                             'A26050-18324-5808001',
                             'A13793-13804-5807920',
                             'A11437-349-5807892',
                             'A11129-12450-5807816',
                             'A12788-19365-5807818',
                             'A12414-13143-5807769',
                             'A11240-20545-5807550',
                             'A36762-21998-5807250',
                             'A11240-12544-5807004',
                             'A23741-17472-5806486',
                             'A11708-12811-5806098',
                             'A13359-13598-5806011',
                             'A15044-14439-5805875',
                             'A37246-22216-5805832',
                             'A16852-15098-5805630',
                             'A16194-14960-5805597',
                             'A16591-17879-5805610',
                             'A30567-19807-5805587',
                             'A16574-15143-5805400',
                             'A38118-22438-5805282',
                             'A31893-20226-5805164',
                             'A29245-19393-5805140',
                             'A11708-12812-5804564',
                             'A30975-19960-5804371',
                             'A20979-16645-5804310',
                             'A11904-12876-5803816',
                             'A14524-18499-5802939',
                             'A28052-15708-5802718',
                             'A37246-22216-5801678',
                             'A13359-13598-5834549',
                             'A19696-22220-5834465',
                             'A29772-19586-5834440',
                             'A16774-19674-5834367',
                             'A21547-16777-5833808',
                             'A15407-14597-5833597',
                             'A14560-17541-5833424',
                             'A33322-20752-5833019',
                             'A11673-16321-5832930',
                             'A10796-19028-5832790',
                             'A11670-12790-5832445',
                             'A16653-15188-5832228',
                             'A29504-19513-5832247',
                             'A16589-15151-5831983',
                             'A17654-15634-5831472',
                             'A13283-13575-5831225',
                             'A23846-17598-5830405',
                             'A26574-18520-5830849',
                             'A33878-20900-5830396',
                             'A28877-19298-5829917',
                             'A12764-13317-5830103',
                             'A12849-13362-5829864',
                             'A10948-12299-5829921',
                             'A35619-21547-5829830',
                             'A33654-20838-5829296',
                             'A29232-17059-5829516',
                             'A19025-16027-5829424',
                             'A12170-13022-5829411',
                             'A10819-12214-5829206',
                             'A19696-22220-5829085',
                             'A25875-18241-5829103',
                             'A12707-13268-5828778',
                             'A31204-20061-5828751',
                             'A34688-21166-5828552',
                             'A13025-16372-5828517',
                             'A17178-15453-5827688',
                             'A16305-15016-5827469',
                             'A16031-14910-5827342',
                             'A19818-16308-5826854',
                             'A32632-20457-5826796',
                             'A12554-13094-5826703',
                             'A12052-12979-5826361',
                             'A16649-20422-5826317',
                             'A13094-13493-5826253',
                             'A12183-13026-5825967',
                             'A30815-19867-5825687',
                             'A11346-12577-5825641',
                             'A14307-19169-5825538',
                             'A10884-12269-5825315',
                             'A26684-18566-5824849',
                             'A10873-12258-5824503',
                             'A32142-20331-5824211',
                             'A27330-18787-5823689',
                             'A21822-18529-5823481',
                             'A26067-18328-5823442',
                             'A11397-10-5823222',
                             'A34855-21229-5822982',
                             'A16070-14921-5822943',
                             'A10632-12109-5822914',
                             'A21677-16811-5822952',
                             'A12888-13223-5822761',
                             'A10649-12123-5822751',
                             'A15263-14532-5822372',
                             'A14700-14245-5822299',
                             'A17000-15349-5822118',
                             'A17000-15349-5822036',
                             'A17000-15349-5821941',
                             'A14734-14264-5821829',
                             'A37445-22283-5821626',
                             'A14083-13944-5821553',
                             'A17000-15349-5821510',
                             'A15263-14532-5821298',
                             'A29199-19383-5820669',
                             'A26590-18532-5820320',
                             'A11740-12806-5820171',
                             'A29199-19382-5819764',
                             'A15208-15702-5819323',
                             'A29790-16948-5819081',
                             'A22521-16991-5818979',
                             'A11579-12586-5818935',
                             'A12142-12999-5818099',
                             'A16968-15323-5817952',
                             'A16642-15180-5817649',
                             'A29242-19392-5817386',
                             'A12916-13394-5817528',
                             'A31385-20125-5817439',
                             'A16589-15149-5816960',
                             'A30318-19753-5816943',
                             'A15263-14533-5816685',
                             'A14734-14264-5816444',
                             'A14391-14099-5816147',
                             'A12499-13167-5815194'
    ) --list of booking transactions from impact de platform
;
USE WAREHOUSE pipe_2xlarge;

-- check we're tracking this booking:
SELECT *
FROM se.data.scv_touched_transactions stt
WHERE stt.booking_id = 'A5742169';

--find user id from a booking not coming through as affiliate programe.
SELECT *
FROM se.data.scv_touched_transactions stt
    INNER JOIN se.data.scv_touch_marketing_channel stmc ON stt.touch_id = stmc.touch_id
    INNER JOIN se.data_pii.scv_touch_basic_attributes stba ON stt.touch_id = stba.touch_id
WHERE stt.booking_id = 'A5742169';

--look at sessions for this user before the transaction
SELECT *
FROM se.data_pii.scv_touch_basic_attributes stba
    INNER JOIN se.data.scv_touch_marketing_channel stmc ON stba.touch_id = stmc.touch_id
WHERE stba.attributed_user_id = '75612993'
  AND stba.touch_start_tstamp >= '2021-01-01';

--found no sessions with input params so look at events for this user
SELECT *
FROM se.data_pii.scv_session_events_link ssel
INNER JOIN se.data_pii.scv_event_stream ses ON ssel.event_hash = ses.event_hash
WHERE ssel.attributed_user_id = '75612993'
AND ssel.event_tstamp >= '2021-07-01'