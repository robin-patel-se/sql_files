WITH complete_customer_ids AS(
    SELECT DISTINCT * FROM (
    VALUES ('69358633'),
        ('69349360'),
        ('69321437'),
        ('69301530'),
        ('69295681'),
        ('69190752'),
        ('69156415'),
        ('69156415'),
        ('69143222'),
        ('69136800'),
        ('68898701'),
        ('68884412'),
        ('68726546'),
        ('68726546'),
        ('68700255'),
        ('68699035'),
        ('68683207'),
        ('68676856'),
        ('68661928'),
        ('68606699'),
        ('68603580'),
        ('68565067'),
        ('68552883'),
        ('68548695'),
        ('68471279'),
        ('68380062'),
        ('68379658'),
        ('68375614'),
        ('68370390'),
        ('68370390'),
        ('68358481'),
        ('68331746'),
        ('68328872'),
        ('68300338'),
        ('68230224'),
        ('68224001'),
        ('68217353'),
        ('68216466'),
        ('68103128'),
        ('68103128'),
        ('68061889'),
        ('68059656'),
        ('68054719'),
        ('68038879'),
        ('68038879'),
        ('68037164'),
        ('68037164'),
        ('67985341'),
        ('67984621'),
        ('67979090'),
        ('67972941'),
        ('67963186'),
        ('67930708'),
        ('67922018'),
        ('67921574'),
        ('67921068'),
        ('67919105'),
        ('67868678'),
        ('67857812'),
        ('67856908'),
        ('67854693'),
        ('67853909'),
        ('67845007'),
        ('67844742'),
        ('67843512'),
        ('67839875'),
        ('67826645'),
        ('67824105'),
        ('67814522'),
        ('67809229'),
        ('67808916'),
        ('67796862'),
        ('67785758'),
        ('67781542'),
        ('67730591'),
        ('67718294'),
        ('67711889'),
        ('67567827'),
        ('67545298'),
        ('67516546'),
        ('67420109'),
        ('67407483'),
        ('67407483'),
        ('67370547'),
        ('67284440'),
        ('67251710'),
        ('67249887'),
        ('67195085'),
        ('67112983'),
        ('67065623'),
        ('67034729'),
        ('66878614'),
        ('66820200'),
        ('66757392'),
        ('66673885'),
        ('66559092'),
        ('66408634'),
        ('66228510'),
        ('66199008'),
        ('66110318'),
        ('66023779'),
        ('65839722'),
        ('65822453'),
        ('65686116'),
        ('65675332'),
        ('65610180'),
        ('65609688'),
        ('65556383'),
        ('65547230'),
        ('65539028'),
        ('65443472'),
        ('65386085'),
        ('65316113'),
        ('65065210'),
        ('64966883'),
        ('64856327'),
        ('64852488'),
        ('64834894'),
        ('64714249'),
        ('64635450'),
        ('64503536'),
        ('64478521'),
        ('64456322'),
        ('64364066'),
        ('64305118'),
        ('64284688'),
        ('63648521'),
        ('63555084'),
        ('63516036'),
        ('63399172'),
        ('63322182'),
        ('63263646'),
        ('63217457'),
        ('63187190'),
        ('63153038'),
        ('63049887'),
        ('62855921'),
        ('58653345'),
        ('58504949'),
        ('58310816'),
        ('58299435'),
        ('58180215'),
        ('58147237'),
        ('58125538'),
        ('57894930'),
        ('57809936'),
        ('57758160'),
        ('57619604'),
        ('57583966'),
        ('57448732'),
        ('57336879'),
        ('57305630'),
        ('57293340'),
        ('57171873'),
        ('57097508'),
        ('57088463'),
        ('57084029'),
        ('57080136'),
        ('56994169'),
        ('56924788'),
        ('56882762'),
        ('56786549'),
        ('56724251'),
        ('56387896'),
        ('56328359'),
        ('56287047'),
        ('56187747'),
        ('56176230'),
        ('56134065'),
        ('56127047'),
        ('56058608'),
        ('55956696'),
        ('55868084'),
        ('55631913'),
        ('55557149'),
        ('55557149'),
        ('55541155'),
        ('55516663'),
        ('55352661'),
        ('55343238'),
        ('55325907'),
        ('55289992'),
        ('55242498'),
        ('55169429'),
        ('54999106'),
        ('54995807'),
        ('54905399'),
        ('54878578'),
        ('54769617'),
        ('54637078'),
        ('54578106'),
        ('54277051'),
        ('54071481'),
        ('53997131'),
        ('53763354'),
        ('53719690'),
        ('53528325'),
        ('53391792'),
        ('53374480'),
        ('53036508'),
        ('52954601'),
        ('52909230'),
        ('52787411'),
        ('52702558'),
        ('52586224'),
        ('52456677'),
        ('52419127'),
        ('52351338'),
        ('51982673'),
        ('51795197'),
        ('51670055'),
        ('51670055'),
        ('51299471'),
        ('51246308'),
        ('51106820'),
        ('51093147'),
        ('49185398'),
        ('49146053'),
        ('48429639'),
        ('48203743'),
        ('47880549'),
        ('47868396'),
        ('47631495'),
        ('47548984'),
        ('47333519'),
        ('47304778'),
        ('47264238'),
        ('47258799'),
        ('47070960'),
        ('47033980'),
        ('47033980'),
        ('46896030'),
        ('46896030'),
        ('46886734'),
        ('46803851'),
        ('46567346'),
        ('45818812'),
        ('45537746'),
        ('45190396'),
        ('44585236'),
        ('44316729'),
        ('44256818'),
        ('44130316'),
        ('43620240'),
        ('43576718'),
        ('43518756'),
        ('43518756'),
        ('43514095'),
        ('43403204'),
        ('43359477'),
        ('43297353'),
        ('43166754'),
        ('43135775'),
        ('43135775'),
        ('43124528'),
        ('43119839'),
        ('43116722'),
        ('41740108'),
        ('41589350'),
        ('41553094'),
        ('41536321'),
        ('41515255'),
        ('41490481'),
        ('41375411'),
        ('41273866'),
        ('41237017'),
        ('41021603'),
        ('40877168'),
        ('40756301'),
        ('40704956'),
        ('40647187'),
        ('40551160'),
        ('40551160'),
        ('40499136'),
        ('40249481'),
        ('39992064'),
        ('39836603'),
        ('39601457'),
        ('39455911'),
        ('39444101'),
        ('39353798'),
        ('39340045'),
        ('39325477'),
        ('39320544'),
        ('39295474'),
        ('39126934'),
        ('38729473'),
        ('38704185'),
        ('38469890'),
        ('38466415'),
        ('38377025'),
        ('38338505'),
        ('37800003'),
        ('37789819'),
        ('37789819'),
        ('37781409'),
        ('37744243'),
        ('37710358'),
        ('37683969'),
        ('37653598'),
        ('37653598'),
        ('37650695'),
        ('37650695'),
        ('37571902'),
        ('37500277'),
        ('37468299'),
        ('37428601'),
        ('37405320'),
        ('37033558'),
        ('37016860'),
        ('36945095'),
        ('36945095'),
        ('36889821'),
        ('36793889'),
        ('36758138'),
        ('36509543'),
        ('36419379'),
        ('36367029'),
        ('36364163'),
        ('36316501'),
        ('36272428'),
        ('36219880'),
        ('36215233'),
        ('36139522'),
        ('36138437'),
        ('36016178'),
        ('35984551'),
        ('35949374'),
        ('35949374'),
        ('35906758'),
        ('35809029'),
        ('35786029'),
        ('35786029'),
        ('35643503'),
        ('35391084'),
        ('35339555'),
        ('35317347'),
        ('35317347'),
        ('35182278'),
        ('35174979'),
        ('35101003'),
        ('34757356'),
        ('34620044'),
        ('34572959'),
        ('34571249'),
        ('34476735'),
        ('34457157'),
        ('34374591'),
        ('34333175'),
        ('34280863'),
        ('34209864'),
        ('34207546'),
        ('34171211'),
        ('34008567'),
        ('33938677'),
        ('33918737'),
        ('33849451'),
        ('33838913'),
        ('33612371'),
        ('33604684'),
        ('33604684'),
        ('33541632'),
        ('33523577'),
        ('33458412'),
        ('33458341'),
        ('33302409'),
        ('33121589'),
        ('32994639'),
        ('32986371'),
        ('32825296'),
        ('32693590'),
        ('32673639'),
        ('32578894'),
        ('32523466'),
        ('32515035'),
        ('32421286'),
        ('32357566'),
        ('32357200'),
        ('32222764'),
        ('32165804'),
        ('32146677'),
        ('32102693'),
        ('32074818'),
        ('32074818'),
        ('32049669'),
        ('32049669'),
        ('32036537'),
        ('32014687'),
        ('31967936'),
        ('31866800'),
        ('31773790'),
        ('31050930'),
        ('31050930'),
        ('30654921'),
        ('30615553'),
        ('30611472'),
        ('30586723'),
        ('30542342'),
        ('30535817'),
        ('30338757'),
        ('30316552'),
        ('30316552'),
        ('30294462'),
        ('30237176'),
        ('30193865'),
        ('30124631'),
        ('30124631'),
        ('30091561'),
        ('30055294'),
        ('30012493'),
        ('29987041'),
        ('29972501'),
        ('29958240'),
        ('29914863'),
        ('29693341'),
        ('29656482'),
        ('29591875'),
        ('29510226'),
        ('29451130'),
        ('29451130'),
        ('29435253'),
        ('29424252'),
        ('29263973'),
        ('29179233'),
        ('29063662'),
        ('29003982'),
        ('28793527'),
        ('28761971'),
        ('28735807'),
        ('28735807'),
        ('28581847'),
        ('28540908'),
        ('28502464'),
        ('28492703'),
        ('28314492'),
        ('28216358'),
        ('28216358'),
        ('28209140'),
        ('28201099'),
        ('28163773'),
        ('28162457'),
        ('28032154'),
        ('27960712'),
        ('27803614'),
        ('27785190'),
        ('27758930'),
        ('27758930'),
        ('27715177'),
        ('27688513'),
        ('27688513'),
        ('27660945'),
        ('27630249'),
        ('27550988'),
        ('27545199'),
        ('27506943'),
        ('27501646'),
        ('27446278'),
        ('27438048'),
        ('27437686'),
        ('27419339'),
        ('27419339'),
        ('27183051'),
        ('27011694'),
        ('26959588'),
        ('26901799'),
        ('26891146'),
        ('26786473'),
        ('26696657'),
        ('26693768'),
        ('26669652'),
        ('26585198'),
        ('26585198'),
        ('26582899'),
        ('26532167'),
        ('26519030'),
        ('26486892'),
        ('26486892'),
        ('26479363'),
        ('26471835'),
        ('26468667'),
        ('26454757'),
        ('26396618'),
        ('26346210'),
        ('26335961'),
        ('26262425'),
        ('26262425'),
        ('26258814'),
        ('26253477'),
        ('26220170'),
        ('26137919'),
        ('26130539'),
        ('26130539'),
        ('26121427'),
        ('26100138'),
        ('26079714'),
        ('25881948'),
        ('25875295'),
        ('25858295'),
        ('25844820'),
        ('25829786'),
        ('25807694'),
        ('25807694'),
        ('25768236'),
        ('25552249'),
        ('25446189'),
        ('25311756'),
        ('25249593'),
        ('25223290'),
        ('25223290'),
        ('25223290'),
        ('25146761'),
        ('24974268'),
        ('24963607'),
        ('24914078'),
        ('24776187'),
        ('24527088'),
        ('24337531'),
        ('24324948'),
        ('24204015'),
        ('24196798'),
        ('24152563'),
        ('23808674'),
        ('23434090'),
        ('23430409'),
        ('23413293'),
        ('23402446'),
        ('23399925'),
        ('23360902'),
        ('23281376'),
        ('23261827'),
        ('23168789'),
        ('23105942'),
        ('23075335'),
        ('22881395'),
        ('22866904'),
        ('22828188'),
        ('22771437'),
        ('22766848'),
        ('22726501'),
        ('22701699'),
        ('22692196'),
        ('22539018'),
        ('22496837'),
        ('22491318'),
        ('22491318'),
        ('22478809'),
        ('22461736'),
        ('22458989'),
        ('22443538'),
        ('22392276'),
        ('22371347'),
        ('22308527'),
        ('22294059'),
        ('22248161'),
        ('22199791'),
        ('22175697'),
        ('22171903'),
        ('22075194'),
        ('22006069'),
        ('21963518'),
        ('21940569'),
        ('21853436'),
        ('21849855'),
        ('21806553'),
        ('21800673'),
        ('21759405'),
        ('21755118'),
        ('21683507'),
        ('21641193'),
        ('21616372'),
        ('21615029'),
        ('21614629'),
        ('21546366'),
        ('21501192'),
        ('21382189'),
        ('21372262'),
        ('21372262'),
        ('21093247'),
        ('20987285'),
        ('20987285'),
        ('20748352'),
        ('20680844'),
        ('20661250'),
        ('20609004'),
        ('20597377'),
        ('20224689'),
        ('20108165'),
        ('20049296'),
        ('19947067'),
        ('19842739'),
        ('19615240'),
        ('19406652'),
        ('19381173'),
        ('19256536'),
        ('19233156'),
        ('19233156'),
        ('19183070'),
        ('19137928'),
        ('19131786'),
        ('19082787'),
        ('19057934'),
        ('19049812'),
        ('18978280'),
        ('18977388'),
        ('18975234'),
        ('18975234'),
        ('18909083'),
        ('18878505'),
        ('18778353'),
        ('18763369'),
        ('18720065'),
        ('18666738'),
        ('18550712'),
        ('18548824'),
        ('18501574'),
        ('18500874'),
        ('18490283'),
        ('18469945'),
        ('18453641'),
        ('18437736'),
        ('18433049'),
        ('18424803'),
        ('18424803'),
        ('14109102'),
        ('12932579'),
        ('12368839'),
        ('8237079'),
        ('8185096')
    ) AS c(customer_id)
)
   , customer_info AS (
    SELECT
    dc.customer_id,
    dc.key_date_user_joined
    FROM dim_customers dc
    WHERE customer_id IN (SELECT distinct customer_id FROM complete_customer_ids)
--     AND customer_id='14109102'
)

, customer_bookings AS (
    SELECT
    fb.key_booking,
    fb.key_customer,
    fb.key_date_booked,
    dc.customer_id,
    db.booking_id,
    ds.status

FROM fact_bookings fb

INNER JOIN dim_customers dc on fb.key_customer = dc.key_customer
INNER JOIN dim_bookings db on fb.key_booking = db.key_booking
INNER JOIN dim_status ds on db.key_status = ds.key_status AND status='Booked'

WHERE
      customer_id IN (SELECT distinct customer_id FROM complete_customer_ids)
)

SELECT c.customer_id,
       ci.key_date_user_joined AS SIGN_UP_DATE,
--        count(distinct lbe.booking_id) AS post_jul_19, -- BOOKINGS THAT OCCURRED AFTER JUL 2019
       count(distinct lb.booking_id) AS lifetime_bookings_to_jul_19, -- LIFETIME BOOKINGS UP TO JUL 2019
       count(distinct pr.booking_id) AS prior_12m_jul_19, -- BOOKINGS THAT OCCURRED WITHIN 12M PRIOR TO JUL 2019,
        CASE
            WHEN count(distinct lb.booking_id) = 0 THEN 'Never Booked'
            WHEN count(distinct lb.booking_id) = 1 THEN '1 Booking Made'
            WHEN count(distinct lb.booking_id) > 1 THEN '2+ Booking Made'
        END AS status_prior_jul_19


FROM complete_customer_ids AS c
LEFT JOIN customer_info AS ci ON c.customer_id=ci.customer_id
LEFT JOIN customer_bookings AS lbe ON c.customer_id=lbe.customer_id AND lbe.key_date_booked > '2019-07-01'-- Bookings made after July 2019
LEFT JOIN customer_bookings AS lb ON c.customer_id=lb.customer_id AND lb.key_date_booked < '2019-07-01'-- ALL bookings up until July 2019
LEFT JOIN customer_bookings AS pr ON c.customer_id=pr.customer_id AND pr.key_date_booked > '2018-07-01' AND pr.key_date_booked < '2019-07-01'-- Bookings prior 12m to July 2019

GROUP BY c.customer_id, ci.key_date_user_joined

--no affiliate id found in chiasma data
