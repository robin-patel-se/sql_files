CREATE SCHEMA hygiene_vault_mvp_dev_robin.cms_mongodb;
CREATE OR REPLACE TABLE hygiene_vault_mvp_dev_robin.cms_mongodb.booking_summary CLONE hygiene_vault_mvp.cms_mongodb.booking_summary;
CREATE OR REPLACE TABLE raw_vault_mvp_dev_robin.cms_mongodb.booking_summary CLONE raw_vault_mvp.cms_mongodb.booking_summary;

SELECT bs.record__o['_id']::VARCHAR AS booking_id,
       bs.record__o['flightAmount'],
       bs.record__o['flightCommission'],
       bs.record__o['creditsUsed'],
       bs.date_time_booked,
       bs.sale_id
FROM hygiene_vault_mvp.cms_mongodb.booking_summary bs
WHERE bs.record__o['flightAmount']::VARCHAR IS NOT NULL
  AND bs.date_time_booked >= '2020-03-11';


SELECT bs.booking_id,
       bs.gross_booking_value_cc,
       bs.customer_total_price_cc,
       bs.flight_amount_cc,
       bs.record__o['saleDimension'],
       bs.record__o['creditsUsed'],
       bs.record__o
FROM hygiene_vault_mvp_dev_robin.cms_mongodb.booking_summary bs;

------------------------------------------------------------------------------------------------------------------------
--populate hygiene historic data

DROP TABLE hygiene_vault_mvp_dev_robin.cms_mongodb.booking_summary;
self_describing_task --include 'task_catalogue/staging/hygiene/cms_mongodb/booking_summary.py'  --method 'run' --start '2020-08-11 00:00:00' --end '2020-08-11 00:00:00'

CREATE OR REPLACE TABLE hygiene_vault_mvp_dev_robin.cms_mongodb.booking_summary_temp
(
    schedule_tstamp                                              TIMESTAMP,
    run_tstamp                                                   TIMESTAMP,
    operation_id                                                 VARCHAR,
    created_at                                                   TIMESTAMP,
    updated_at                                                   TIMESTAMP,
    row_dataset_name                                             VARCHAR,
    row_dataset_source                                           VARCHAR,
    row_loaded_at                                                TIMESTAMP,
    row_schedule_tstamp                                          TIMESTAMP,
    row_run_tstamp                                               TIMESTAMP,
    row_filename                                                 VARCHAR,
    row_file_row_number                                          NUMBER,
    no_nights                                                    NUMBER,
    rooms                                                        NUMBER,
    adult_guests                                                 NUMBER,
    child_guests                                                 NUMBER,
    infant_guests                                                NUMBER,
    rate_to_gbp                                                  DOUBLE,
    cc_rate_to_sc                                                DOUBLE,
    gbp_rate_to_sc                                               DOUBLE,
    last_updated                                                 TIMESTAMP,
    date_time_booked                                             TIMESTAMP,
    booking_date                                                 DATE,
    check_in_timestamp                                           TIMESTAMP,
    check_in_date                                                DATE,
    check_out_timestamp                                          TIMESTAMP,
    check_out_date                                               DATE,
    booking_lead_time_days                                       NUMBER,

    margin_gross_of_toms_cc                                      DOUBLE,
    customer_total_price_cc                                      DOUBLE,
    gross_booking_value_cc                                       DOUBLE,
    vat_on_commission_cc                                         DOUBLE,
    booking_fee_net_rate_cc                                      DOUBLE,
    payment_surcharge_net_rate_cc                                DOUBLE,
    commission_ex_vat_cc                                         DOUBLE,
    insurance_commission_cc                                      DOUBLE,
    flight_amount_cc                                             DOUBLE,
    flight_commission_cc                                         DOUBLE,
    credits_used_cc                                              DOUBLE,

    margin_gross_of_toms_gbp                                     DOUBLE,
    customer_total_price_gbp                                     DOUBLE,
    gross_booking_value_gbp                                      DOUBLE,
    vat_on_commission_gbp                                        DOUBLE,
    booking_fee_net_rate_gbp                                     DOUBLE,
    payment_surcharge_net_rate_gbp                               DOUBLE,
    commission_ex_vat_gbp                                        DOUBLE,
    insurance_commission_gbp                                     DOUBLE,
    flight_amount_gbp                                            DOUBLE,
    flight_commission_gbp                                        DOUBLE,
    credits_used_gbp                                             DOUBLE,

    margin_gross_of_toms_sc                                      DOUBLE,
    customer_total_price_sc                                      DOUBLE,
    gross_booking_value_sc                                       DOUBLE,
    vat_on_commission_sc                                         DOUBLE,
    booking_fee_net_rate_sc                                      DOUBLE,
    payment_surcharge_net_rate_sc                                DOUBLE,
    commission_ex_vat_sc                                         DOUBLE,
    insurance_commission_sc                                      DOUBLE,
    flight_amount_sc                                             DOUBLE,
    flight_commission_sc                                         DOUBLE,
    credits_used_sc                                              DOUBLE,

    is_new_model_booking                                         NUMBER,
    affiliate_user_id                                            NUMBER,
    shiro_user_id                                                NUMBER,
    device_platform                                              VARCHAR,
    booking_id                                                   VARCHAR,
    customer_id                                                  VARCHAR,
    currency                                                     VARCHAR,
    sale_base_currency                                           VARCHAR,
    territory                                                    VARCHAR,
    last_updated_v1                                              VARCHAR,
    last_updated_v2                                              VARCHAR,
    date_time_booked_v1                                          VARCHAR,
    date_time_booked_v2                                          VARCHAR,
    check_in_date_v1                                             VARCHAR,
    check_in_date_v2                                             VARCHAR,
    check_out_date_v1                                            VARCHAR,
    check_out_date_v2                                            VARCHAR,
    booking_type                                                 VARCHAR,
    no_nights__o                                                 VARCHAR,
    rooms__o                                                     VARCHAR,
    adult_guests__o                                              VARCHAR,
    child_guests__o                                              VARCHAR,
    infant_guests__o                                             VARCHAR,
    vat_on_commission_cc_100                                     VARCHAR,
    customer_total_price_cc_100                                  VARCHAR,
    gross_booking_value_cc_100                                   VARCHAR,
    gross_booking_value_cc__o                                    VARCHAR,
    gross_booking_value_gbp__o                                   VARCHAR,
    gross_booking_value_sc__o                                    VARCHAR,
    commission_ex_vat_cc_100                                     VARCHAR,
    commission_ex_vat_sc_100                                     VARCHAR,
    booking_fee_net_rate_cc_100                                  VARCHAR,
    payment_surcharge_net_rate_cc_100                            VARCHAR,
    insurance_commission_cc_100                                  VARCHAR,
    flight_amount_cc_100                                         VARCHAR,
    flight_commission_cc_100                                     VARCHAR,
    rate_to_gbp_100000                                           VARCHAR,
    customer_email                                               VARCHAR,
    sale_product                                                 VARCHAR,
    sale_type                                                    VARCHAR,
    booking_status                                               VARCHAR,
    affiliate                                                    VARCHAR,
    affiliate_domain                                             VARCHAR,
    booking_class                                                VARCHAR,
    affiliate_id                                                 VARCHAR,
    sale_id                                                      VARCHAR,
    offer_id                                                     VARCHAR,
    offer_name                                                   VARCHAR,
    transaction_id                                               VARCHAR,
    bundle_id                                                    VARCHAR,
    unique_transaction_reference                                 VARCHAR,
    has_flights                                                  VARCHAR,
    supplier                                                     VARCHAR,
    platform_name__o                                             VARCHAR,
    credits_used_cc_100                                          VARCHAR,
    record__o                                                    VARIANT,
    failed_some_validation                                       NUMBER,
    fails_validation__booking_id__expected_nonnull               NUMBER,
    fails_validation__customer_id__expected_nonnull              NUMBER,
    fails_validation_new_model_sale_type_expected_a              NUMBER,
    fails_validation__booking_date__expected_nonnull             NUMBER,
    fails_validation__margin_gross_of_toms_gbp__expected_nonzero NUMBER
);

USE WAREHOUSE pipe_xlarge;

INSERT INTO hygiene_vault_mvp_dev_robin.cms_mongodb.booking_summary_temp
SELECT bs.schedule_tstamp,
       bs.run_tstamp,
       bs.operation_id,
       bs.created_at,
       bs.updated_at,
       bs.row_dataset_name,
       bs.row_dataset_source,
       bs.row_loaded_at,
       bs.row_schedule_tstamp,
       bs.row_run_tstamp,
       bs.row_filename,
       bs.row_file_row_number,
       bs.no_nights,
       bs.rooms,
       bs.adult_guests,
       bs.child_guests,
       bs.infant_guests,
       bs.rate_to_gbp,
       bs.cc_rate_to_sc,
       bs.gbp_rate_to_sc,
       bs.last_updated,
       bs.date_time_booked,
       bs.booking_date,
       bs.check_in_timestamp,
       bs.check_in_date,
       bs.check_out_timestamp,
       bs.check_out_date,
       bs.booking_lead_time_days,

       bs.margin_gross_of_toms_cc,
       (COALESCE(TRY_TO_NUMBER(bs.record__o['customerTotalPrice']::VARCHAR), 0) / 100) AS customer_total_price_cc,
       bs.gross_booking_value_cc +
       (COALESCE(TRY_TO_NUMBER(bs.record__o['flightAmount']::VARCHAR), 0) / 100)       AS gross_booking_value_cc,
       bs.vat_on_commission_cc,
       bs.booking_fee_net_rate_cc,
       bs.payment_surcharge_net_rate_cc,
       bs.commission_ex_vat_cc,
       bs.insurance_commission_cc,
       COALESCE(TRY_TO_NUMBER(bs.record__o['flightAmount']::VARCHAR), 0) / 100         AS flight_amount_cc,
       bs.flight_commission_cc,
       COALESCE(TRY_TO_NUMBER(bs.record__o['creditsUsed']::VARCHAR), 0) / 100          AS credits_used_cc,

       bs.margin_gross_of_toms_gbp,
       customer_total_price_cc * bs.rate_to_gbp                                        AS customer_total_price_gbp,
       bs.gross_booking_value_gbp + (flight_amount_cc * bs.rate_to_gbp)                AS gross_booking_value_gbp,
       bs.vat_on_commission_gbp,
       bs.booking_fee_net_rate_gbp,
       bs.payment_surcharge_net_rate_gbp,
       bs.commission_ex_vat_gbp,
       bs.insurance_commission_gbp,
       flight_amount_cc * bs.rate_to_gbp                                               AS flight_amount_gbp,
       bs.flight_commission_gbp,
       credits_used_cc * bs.rate_to_gbp                                                AS credits_used_gbp,

       bs.margin_gross_of_toms_sc,
       customer_total_price_cc * bs.cc_rate_to_sc                                      AS customer_total_price_sc,
       bs.gross_booking_value_sc + (flight_amount_cc * bs.cc_rate_to_sc)               AS gross_booking_value_sc,
       bs.vat_on_commission_sc,
       bs.booking_fee_net_rate_sc,
       bs.payment_surcharge_net_rate_sc,
       bs.commission_ex_vat_sc,
       bs.insurance_commission_sc,
       flight_amount_cc * bs.cc_rate_to_sc                                             AS flight_amount_sc,
       bs.flight_commission_sc,
       credits_used_cc * bs.cc_rate_to_sc                                              AS credits_used_sc,

       bs.is_new_model_booking,
       bs.affiliate_user_id,
       bs.shiro_user_id,
       bs.device_platform,
       bs.booking_id,
       bs.customer_id,
       bs.currency,
       bs.sale_base_currency,
       bs.territory,
       bs.last_updated_v1,
       bs.last_updated_v2,
       bs.date_time_booked_v1,
       bs.date_time_booked_v2,
       bs.check_in_date_v1,
       bs.check_in_date_v2,
       bs.check_out_date_v1,
       bs.check_out_date_v2,
       bs.booking_type,
       bs.no_nights__o,
       bs.rooms__o,
       bs.adult_guests__o,
       bs.child_guests__o,
       bs.infant_guests__o,
       bs.vat_on_commission_cc_100,
       bs.record__o['customerTotalPrice']::VARCHAR                                     AS customer_total_price_cc_100,
       bs.gross_booking_value_cc_100,
       bs.gross_booking_value_cc                                                       AS gross_booking_value_cc__o,
       bs.gross_booking_value_gbp                                                      AS gross_booking_value_gbp__o,
       bs.gross_booking_value_sc                                                       AS gross_booking_values_sc__o,
       bs.commission_ex_vat_cc_100,
       bs.commission_ex_vat_sc_100,
       bs.booking_fee_net_rate_cc_100,
       bs.payment_surcharge_net_rate_cc_100,
       bs.insurance_commission_cc_100,
       bs.record__o['flightAmount']::VARCHAR                                           AS flight_amount_cc_100,
       bs.flight_commission_cc_100,
       bs.rate_to_gbp_100000,
       bs.customer_email,
       bs.sale_type                                                                    AS sale_product,
       bs.record__o['saleDimension']::VARCHAR                                          AS sale_type,
       bs.booking_status,
       bs.affiliate,
       bs.affiliate_domain,
       bs.booking_class,
       bs.affiliate_id,
       bs.sale_id,
       bs.offer_id,
       bs.offer_name,
       bs.transaction_id,
       bs.bundle_id,
       bs.unique_transaction_reference,
       bs.has_flights,
       bs.supplier,
       bs.platform_name__o,
       bs.record__o['creditsUsed']::VARCHAR                                            AS credits_used_cc_100,
       bs.record__o,
       bs.failed_some_validation,
       bs.fails_validation__booking_id__expected_nonnull,
       bs.fails_validation__customer_id__expected_nonnull,
       bs.fails_validation_new_model_sale_type_expected_a,
       bs.fails_validation__booking_date__expected_nonnull,
       bs.fails_validation__margin_gross_of_toms_gbp__expected_nonzero
FROM hygiene_vault_mvp.cms_mongodb.booking_summary bs;

CREATE OR REPLACE TABLE hygiene_vault_mvp_dev_robin.cms_mongodb.booking_summary CLONE hygiene_vault_mvp_dev_robin.cms_mongodb.booking_summary_temp;

SELECT *
FROM hygiene_vault_mvp_dev_robin.cms_mongodb.booking_summary bs;

------------------------------------------------------------------------------------------------------------------------
--hygiene snapshot
DROP TABLE hygiene_snapshot_vault_mvp_dev_robin.cms_mongodb.booking_summary;
CREATE OR REPLACE TABLE hygiene_snapshot_vault_mvp.cms_mongodb.booking_summary_bkup CLONE hygiene_snapshot_vault_mvp.cms_mongodb.booking_summary;

self_describing_task --include 'staging/hygiene_snapshots/cms_mongodb/booking_summary.py'  --method 'run' --start '2020-04-13 00:00:00' --end '2020-04-13 00:00:00'

CREATE OR REPLACE TABLE hygiene_snapshot_vault_mvp_dev_robin.cms_mongodb.booking_summary_temp
(
    schedule_tstamp                   TIMESTAMP,
    run_tstamp                        TIMESTAMP,
    operation_id                      VARCHAR,
    created_at                        TIMESTAMP,
    updated_at                        TIMESTAMP,
    row_dataset_name                  VARCHAR,
    row_dataset_source                VARCHAR,
    row_loaded_at                     TIMESTAMP,
    row_schedule_tstamp               TIMESTAMP,
    row_run_tstamp                    TIMESTAMP,
    row_filename                      VARCHAR,
    row_file_row_number               NUMBER,
    no_nights                         NUMBER,
    rooms                             NUMBER,
    adult_guests                      NUMBER,
    child_guests                      NUMBER,
    infant_guests                     NUMBER,
    rate_to_gbp                       DOUBLE,
    cc_rate_to_sc                     DOUBLE,
    gbp_rate_to_sc                    DOUBLE,
    last_updated                      TIMESTAMP,
    date_time_booked                  TIMESTAMP,
    booking_date                      DATE,
    check_in_timestamp                TIMESTAMP,
    check_in_date                     DATE,
    check_out_timestamp               TIMESTAMP,
    check_out_date                    DATE,
    booking_lead_time_days            NUMBER,

    margin_gross_of_toms_cc           DOUBLE,
    customer_total_price_cc           DOUBLE,
    gross_booking_value_cc            DOUBLE,
    vat_on_commission_cc              DOUBLE,
    booking_fee_net_rate_cc           DOUBLE,
    payment_surcharge_net_rate_cc     DOUBLE,
    commission_ex_vat_cc              DOUBLE,
    insurance_commission_cc           DOUBLE,
    flight_amount_cc                  DOUBLE,
    flight_commission_cc              DOUBLE,
    credits_used_cc                   DOUBLE,

    margin_gross_of_toms_gbp          DOUBLE,
    customer_total_price_gbp          DOUBLE,
    gross_booking_value_gbp           DOUBLE,
    vat_on_commission_gbp             DOUBLE,
    booking_fee_net_rate_gbp          DOUBLE,
    payment_surcharge_net_rate_gbp    DOUBLE,
    commission_ex_vat_gbp             DOUBLE,
    insurance_commission_gbp          DOUBLE,
    flight_amount_gbp                 DOUBLE,
    flight_commission_gbp             DOUBLE,
    credits_used_gbp                  DOUBLE,

    margin_gross_of_toms_sc           DOUBLE,
    customer_total_price_sc           DOUBLE,
    gross_booking_value_sc            DOUBLE,
    vat_on_commission_sc              DOUBLE,
    booking_fee_net_rate_sc           DOUBLE,
    payment_surcharge_net_rate_sc     DOUBLE,
    commission_ex_vat_sc              DOUBLE,
    insurance_commission_sc           DOUBLE,
    flight_amount_sc                  DOUBLE,
    flight_commission_sc              DOUBLE,
    credits_used_sc                   DOUBLE,

    is_new_model_booking              NUMBER,
    affiliate_user_id                 NUMBER,
    shiro_user_id                     NUMBER,
    device_platform                   VARCHAR,
    booking_id                        VARCHAR NOT NULL PRIMARY KEY,
    customer_id                       VARCHAR,
    currency                          VARCHAR,
    sale_base_currency                VARCHAR,
    territory                         VARCHAR,
    last_updated_v1                   VARCHAR,
    last_updated_v2                   VARCHAR,
    date_time_booked_v1               VARCHAR,
    date_time_booked_v2               VARCHAR,
    check_in_date_v1                  VARCHAR,
    check_in_date_v2                  VARCHAR,
    check_out_date_v1                 VARCHAR,
    check_out_date_v2                 VARCHAR,
    booking_type                      VARCHAR,
    no_nights__o                      VARCHAR,
    rooms__o                          VARCHAR,
    adult_guests__o                   VARCHAR,
    child_guests__o                   VARCHAR,
    infant_guests__o                  VARCHAR,
    vat_on_commission_cc_100          VARCHAR,
    customer_total_price_cc_100       VARCHAR,
    gross_booking_value_cc_100        VARCHAR,
    gross_booking_value_cc__o         VARCHAR,
    gross_booking_value_gbp__o        VARCHAR,
    gross_booking_value_sc__o         VARCHAR,
    commission_ex_vat_cc_100          VARCHAR,
    commission_ex_vat_sc_100          VARCHAR,
    booking_fee_net_rate_cc_100       VARCHAR,
    payment_surcharge_net_rate_cc_100 VARCHAR,
    insurance_commission_cc_100       VARCHAR,
    flight_amount_cc_100              VARCHAR,
    flight_commission_cc_100          VARCHAR,
    rate_to_gbp_100000                VARCHAR,
    customer_email                    VARCHAR,
    sale_product                      VARCHAR,
    sale_type                         VARCHAR,
    booking_status                    VARCHAR,
    affiliate                         VARCHAR,
    affiliate_domain                  VARCHAR,
    booking_class                     VARCHAR,
    affiliate_id                      VARCHAR,
    sale_id                           VARCHAR,
    offer_id                          VARCHAR,
    offer_name                        VARCHAR,
    transaction_id                    VARCHAR,
    bundle_id                         VARCHAR,
    unique_transaction_reference      VARCHAR,
    has_flights                       VARCHAR,
    supplier                          VARCHAR,
    platform_name__o                  VARCHAR,
    credits_used_cc_100               VARCHAR,
    record__o                         VARIANT
);

INSERT INTO hygiene_snapshot_vault_mvp_dev_robin.cms_mongodb.booking_summary_temp
SELECT bs.schedule_tstamp,
       bs.run_tstamp,
       bs.operation_id,
       bs.created_at,
       bs.updated_at,
       bs.row_dataset_name,
       bs.row_dataset_source,
       bs.row_loaded_at,
       bs.row_schedule_tstamp,
       bs.row_run_tstamp,
       bs.row_filename,
       bs.row_file_row_number,
       bs.no_nights,
       bs.rooms,
       bs.adult_guests,
       bs.child_guests,
       bs.infant_guests,
       bs.rate_to_gbp,
       bs.cc_rate_to_sc,
       bs.gbp_rate_to_sc,
       bs.last_updated,
       bs.date_time_booked,
       bs.booking_date,
       bs.check_in_timestamp,
       bs.check_in_date,
       bs.check_out_timestamp,
       bs.check_out_date,
       bs.booking_lead_time_days,

       bs.margin_gross_of_toms_cc,
       (COALESCE(TRY_TO_NUMBER(bs.record__o['customerTotalPrice']::VARCHAR), 0) / 100) AS customer_total_price_cc,
       (COALESCE(TRY_TO_NUMBER(bs.record__o['flightAmount']::VARCHAR), 0) / 100)       AS gross_booking_value_cc,
       bs.vat_on_commission_cc,
       bs.booking_fee_net_rate_cc,
       bs.payment_surcharge_net_rate_cc,
       bs.commission_ex_vat_cc,
       bs.insurance_commission_cc,
       COALESCE(TRY_TO_NUMBER(bs.record__o['flightAmount']::VARCHAR), 0) / 100         AS flight_amount_cc,
       bs.flight_commission_cc,
       COALESCE(TRY_TO_NUMBER(bs.record__o['creditsused']::VARCHAR), 0) / 100          AS credits_used_cc,

       bs.margin_gross_of_toms_gbp,
       customer_total_price_cc * bs.rate_to_gbp                                        AS customer_total_price_gbp,
       bs.gross_booking_value_gbp + (flight_amount_cc * bs.rate_to_gbp)                AS gross_booking_value_gbp,
       bs.vat_on_commission_gbp,
       bs.booking_fee_net_rate_gbp,
       bs.payment_surcharge_net_rate_gbp,
       bs.commission_ex_vat_gbp,
       bs.insurance_commission_gbp,
       flight_amount_cc * bs.rate_to_gbp                                               AS flight_amount_gbp,
       bs.flight_commission_gbp,
       credits_used_cc * bs.rate_to_gbp                                                AS credits_used_gbp,


       bs.margin_gross_of_toms_sc,
       customer_total_price_cc * bs.cc_rate_to_sc                                      AS customer_total_price_sc,
       bs.gross_booking_value_sc + (flight_amount_cc * bs.cc_rate_to_sc)               AS gross_booking_value_sc,
       bs.vat_on_commission_sc,
       bs.booking_fee_net_rate_sc,
       bs.payment_surcharge_net_rate_sc,
       bs.commission_ex_vat_sc,
       bs.insurance_commission_sc,
       flight_amount_cc * bs.cc_rate_to_sc                                             AS flight_amount_sc,
       bs.flight_commission_sc,
       credits_used_cc * bs.cc_rate_to_sc                                              AS credits_used_sc,


       bs.is_new_model_booking,
       bs.affiliate_user_id,
       bs.shiro_user_id,
       bs.device_platform,
       bs.booking_id,
       bs.customer_id,
       bs.currency,
       bs.sale_base_currency,
       bs.territory,
       bs.last_updated_v1,
       bs.last_updated_v2,
       bs.date_time_booked_v1,
       bs.date_time_booked_v2,
       bs.check_in_date_v1,
       bs.check_in_date_v2,
       bs.check_out_date_v1,
       bs.check_out_date_v2,
       bs.booking_type,
       bs.no_nights__o,
       bs.rooms__o,
       bs.adult_guests__o,
       bs.child_guests__o,
       bs.infant_guests__o,
       bs.vat_on_commission_cc_100,
       bs.record__o['customerTotalPrice']::VARCHAR                                     AS customer_total_price_cc_100,
       bs.gross_booking_value_cc_100,
       bs.gross_booking_value_cc                                                       AS gross_booking_value_cc__o,
       bs.gross_booking_value_gbp                                                      AS gross_booking_value_gbp__o,
       bs.gross_booking_value_sc                                                       AS gross_booking_values_sc__o,
       bs.commission_ex_vat_cc_100,
       bs.commission_ex_vat_sc_100,
       bs.booking_fee_net_rate_cc_100,
       bs.payment_surcharge_net_rate_cc_100,
       bs.insurance_commission_cc_100,
       bs.record__o['flightAmount']::VARCHAR                                           AS flight_amount_cc_100,
       bs.flight_commission_cc_100,
       bs.rate_to_gbp_100000,
       bs.customer_email,
       bs.sale_type                                                                    AS sale_product,
       bs.record__o['saleDimension']::VARCHAR                                          AS sale_type,
       bs.booking_status,
       bs.affiliate,
       bs.affiliate_domain,
       bs.booking_class,
       bs.affiliate_id,
       bs.sale_id,
       bs.offer_id,
       bs.offer_name,
       bs.transaction_id,
       bs.bundle_id,
       bs.unique_transaction_reference,
       bs.has_flights,
       bs.supplier,
       bs.platform_name__o,
       bs.record__o['creditsUsed']::VARCHAR                                            AS credits_used_cc_100,
       bs.record__o
FROM hygiene_snapshot_vault_mvp.cms_mongodb.booking_summary bs;
;

SELECT *
FROM hygiene_snapshot_vault_mvp_dev_robin.cms_mongodb.booking_summary bs;


CREATE OR REPLACE TABLE hygiene_snapshot_vault_mvp.cms_mongodb.booking_summary CLONE hygiene_snapshot_vault_mvp.cms_mongodb.booking_summary_temp;
DROP TABLE hygiene_snapshot_vault_mvp_dev_robin.cms_mongodb.booking_summary;



ALTER TABLE hygiene_vault_mvp_dev_robin.cms_mongodb.booking_summary
    RENAME COLUMN gross_booking_values_sc__o TO gross_booking_value_sc__o;

SELECT *
FROM hygiene_snapshot_vault_mvp_dev_robin.cms_mongodb.booking_summary bs;



SELECT bs.booking_id,
       bs.gross_booking_value_cc__o,
       bs.flight_amount_cc_100,
       bs.flight_amount_cc,
       bs.gross_booking_value_cc,
       bs.gross_booking_value_gbp__o,
       bs.flight_amount_gbp,
       bs.gross_booking_value_gbp,
       bs.gross_booking_value_sc__o,
       bs.flight_amount_sc,
       bs.gross_booking_value_sc


FROM hygiene_vault_mvp_dev_robin.cms_mongodb.booking_summary_temp bs
WHERE bs.flight_amount_cc_100 > 0;



SELECT sb.booking_id,
       sb.gross_booking_value_cc,
       (bs.record__o['flightAmount']::VARCHAR / 100)::DOUBLE       AS flight_amount,
       (bs.record__o['customerTotalPrice']::VARCHAR / 100)::DOUBLE AS customer_total_price,
       bs.record__o
FROM data_vault_mvp.dwh.se_booking sb
         LEFT JOIN hygiene_snapshot_vault_mvp.cms_mongodb.booking_summary bs ON sb.booking_id = bs.booking_id
WHERE sb.booking_status = 'COMPLETE'



------------------------------------------------------------------------------------------------------------------------
self_describing_task --include 'dv/dwh/transactional/se_booking.py'  --method 'run' --start '2020-04-13 00:00:00' --end '2020-04-13 00:00:00'


SELECT *
FROM data_vault_mvp_dev_robin.dwh.se_booking sb;





