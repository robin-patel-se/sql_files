CREATE OR REPLACE VIEW collab.covid_pii.covid_master_list_all
    COPY GRANTS
AS
WITH se_masterlist
         AS
         (
             SELECT 'SE'                                                                           AS platform,
                    transactionid,
                    booking_id,
                    saleid,
                    salename,
                    datebooked,
                    checkin,
                    checkout,
                    currency,
                    territory,
                    customertotalprice,
                    customerpayment,
                    grossbookingvalue,
                    finance_net_amount_paid_fx,
                    finance_net_amount_paid_gbp,
                    finance_non_flight_spls_cash_held,
                    finance_non_flight_vcc_held,
                    finance_flight_refunds_received_gbp,
                    finance_total_held_gbp,
                    finance_perc_held,
                    finance_flight_and_non_flight_components_held,
                    finance_amount_inc_margin_adj,
                    type,
                    supplier,
                    country,
                    customerid,
                    saledimension,
                    dynamicflightbooked,
                    carrier,
                    grossprofit,
                    CASE WHEN refunded OR cancelled THEN 'CANX' ELSE 'LIVE' END                    AS booking_status,
                    world_pay_currency,
                    COALESCE(world_pay_amount, 0)                                                  AS world_pay_refunded,
                    rate_pay_currency,
                    COALESCE(rate_pay_amount_gross, 0)                                             AS rate_pay_refunded,
                    stripe_currency,
                    COALESCE(stripe_amount, 0)                                                     AS stripe_refunded,
                    CASE WHEN lower(cb_se_status) = 'lost' THEN cb_se_payment_amount ELSE 0 END    AS chargeback_amount_lost,
                    CASE WHEN lower(cb_se_status) = 'won' THEN cb_se_payment_amount ELSE 0 END     AS chargeback_amount_won,
                    CASE WHEN lower(cb_se_status) = 'pending' THEN cb_se_payment_amount ELSE 0 END AS chargeback_amount_pending,
                    manual_bacs_customer_currency,
                    COALESCE(manual_bacs_amount_in_customer_currency, 0)                           AS manual_bacs_refund,
                    (world_pay_refunded + rate_pay_refunded + stripe_refunded + manual_bacs_refund
                        + chargeback_amount_lost
                        )                                                                          AS total_refunded_cash,
                    coalesce(credit_active, 0)                                                     AS active_credit,
                    coalesce(credit_deleted, 0)                                                    AS deleted_credit,
                    coalesce(credit_used, 0)                                                       AS used_credit,
                    coalesce(credit_used_tb, 0)                                                    AS used_tb_credit,
                    coalesce(credit_refunded_cash, 0)                                              AS refunded_cash_credit,
                    total_refunded_cash + active_credit                                            AS total_cash_and_active_credit,
                    case_number,
                    case_owner_full_name,
                    transaction_id,
                    sf_unique_transaction_id,
                    subject,
                    opportunity_sale_id,
                    status,
                    number_dup_cases_solved,
                    case_origin,
                    "VIEW",
                    booking_lookup_check_in_date,
                    booking_lookup_check_out_date,
                    requested_rebooking_date,
                    postponed_booking_request,
                    booking_lookup_store_id,
                    booking_lookup_supplier_territory,
                    contact_reason,
                    last_modified_by_full_name,
                    overbooking_rebooking_stage,
                    reason,
                    case_id,
                    date_time_opened,
                    case_name,
                    last_modified_date,
                    last_modified_by_case_overview,
                    priority_type,
                    covid19_member_resolution_cs,
                    case_overview_id,
                    case_thread_id,
                    priority,
                    status_se_ho,
                    status_se_pkg,
                    bk_cnx_refund_channel,
                    rate_pay_amount_gross,
                    world_pay_amount,
                    manual_bacs_amount_in_customer_currency,
                    cb_se_status,
                    cb_se_payment_amount,
                    bk_cnx_refund_type,
                    bk_cnx_who_pays
             FROM collab.covid_pii.covid_master_list_ho_packages
         ),
     ctl_master_list
         AS (
         SELECT 'TB'                                                 AS platform,
                booking_id::VARCHAR                                  AS transactionid,
                booking_id,
                sale_id,
                'n/a'                                                AS salename,
                booking_date,
                travel_date                                          AS checkin,
                return_date                                          AS checkout,
                payment_currency,
                territory_name,
                sold_price_in_currency                               AS customertotalprice,
                payment_amount,
                sold_price_in_currency,
                finance_net_amount_paid_fx,
                finance_net_amount_paid_gbp,
                finance_non_flight_spls_cash_held,
                finance_non_flight_vcc_held,
                finance_flight_refunds_received_gbp,
                finance_total_held_gbp,
                finance_perc_held,
                finance_flight_and_non_flight_components_held,
                finance_amount_inc_margin_adj,
                product_line,
                supplier,
                country,
                'n/a'                                                AS customerid,
                sale_type                                            AS saledimension,
                CASE
                    WHEN lower(flight_transaction_state) IN ('complete', 'manual') THEN 'y'
                    ELSE 'n' END                                     AS dynamicflightbooked,
                airline,
                '0'                                                  AS grossprofit,
                booking_status,
                'n/a'                                                AS world_pay_currency,
                0                                                    AS world_pay_refunded,
                'n/a'                                                AS rate_pay_currency,
                0                                                    AS rate_pay_refunded,
                stripe_currency,
                COALESCE(stripe_refunded_amount, 0)                  AS stripe_refunded,
                COALESCE(cb_ctl_amount_lost, 0)                      AS chargeback_amount_lost,
                COALESCE(cb_ctl_amount_won, 0)                       AS chargeback_amount_won,
                COALESCE(cb_ctl_amount_pending, 0)                   AS chargeback_amount_pending,
                manual_bacs_customer_currency,
                COALESCE(manual_bacs_amount_in_customer_currency, 0) AS manual_bacs_refund,
                (world_pay_refunded + rate_pay_refunded + stripe_refunded + manual_bacs_refund
                    + chargeback_amount_lost
                    )                                                AS total_refunded_cash,
                coalesce(credit_active, 0)                           AS active_credit,
                coalesce(credit_deleted, 0)                          AS deleted_credit,
                coalesce(credit_used, 0)                             AS used_credit,
                coalesce(credit_used_tb, 0)                          AS used_tb_credit,
                coalesce(credit_refunded_cash, 0)                    AS refunded_cash_credit,
                total_refunded_cash + active_credit                  AS total_cash_and_active_credit,
                case_number,
                case_owner_full_name,
                transaction_id,
                sf_unique_transaction_id,
                subject,
                opportunity_sale_id,
                status,
                number_dup_cases_solved,
                case_origin,
                "VIEW",
                booking_lookup_check_in_date,
                booking_lookup_check_out_date,
                requested_rebooking_date,
                postponed_booking_request,
                booking_lookup_store_id,
                booking_lookup_supplier_territory,
                contact_reason,
                last_modified_by_full_name,
                overbooking_rebooking_stage,
                reason,
                case_id,
                date_time_opened,
                case_name,
                last_modified_date,
                last_modified_by_case_overview,
                priority_type,
                covid19_member_resolution_cs,
                case_overview_id,
                case_thread_id,
                priority,
                ''                                                   AS status_se_ho,
                status_se_pkg,
                NULL                                                 AS bk_cnx_refund_channel,
                NULL                                                 AS rate_pay_amount_gross,
                NULL                                                 AS world_pay_amount,
                NULL                                                 AS manual_bacs_amount_in_customer_currency,
                NULL                                                 AS cb_se_status,
                NULL                                                 AS cb_se_payment_amount,
                NULL                                                 AS bk_cnx_refund_type,
                NULL                                                 AS bk_cnx_who_pays
         FROM collab.covid_pii.covid_master_list_catalogue
     )
SELECT *
FROM ctl_master_list
UNION
SELECT *
FROM se_masterlist;

SELECT *
FROM collab.covid_pii.covid_master_list_all cmla;

