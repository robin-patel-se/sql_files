USE WAREHOUSE PIPE_XLARGE;

USE SCHEMA COLLAB.SS_TRACKING_QA;

CREATE OR REPLACE TABLE CS_APP_EVENTS AS (
    SELECT *
    FROM SNOWPLOW.ATOMIC.EVENTS
    WHERE COLLECTOR_TSTAMP::DATE >= '2019-11-01'
      AND EVENT_NAME = 'screen_view'
);

------------------------------------------------------------------------------------------------------------------------

SELECT *
FROM CS_APP_EVENTS
WHERE COLLECTOR_TSTAMP::DATE = '2020-01-22';


SELECT NULLIF(
               COALESCE(CONTEXTS_COM_SECRETESCAPES_SALE_PAGE_CONTEXT_1[0]['sale_id']::VARCHAR, -- prior to SS tracking
                        CONTEXTS_COM_SECRETESCAPES_SECRET_ESCAPES_SALE_CONTEXT_1[0]['id']::VARCHAR -- SS tracking
                   ), '0') --null for when sale id is set to 0.
           AS SE_SALE_ID,
       CONTEXTS_COM_SECRETESCAPES_SALE_PAGE_CONTEXT_1,
       CONTEXTS_COM_SECRETESCAPES_SECRET_ESCAPES_SALE_CONTEXT_1,
       *
FROM CS_APP_EVENTS
WHERE COLLECTOR_TSTAMP::DATE = '2020-02-05';


--content context
SELECT *
FROM CS_APP_EVENTS
WHERE CONTEXTS_COM_SECRETESCAPES_CONTENT_CONTEXT_1 IS NOT NULL;


--user state context
SELECT USER_ID,
       CONTEXTS_COM_SECRETESCAPES_USER_STATE_CONTEXT_1[0]['affiliate_id']::VARCHAR,
       CONTEXTS_COM_SECRETESCAPES_USER_STATE_CONTEXT_1[0]['affiliate_name']::VARCHAR,
       CONTEXTS_COM_SECRETESCAPES_USER_STATE_CONTEXT_1[0]['affiliate_territory']::VARCHAR,
       CONTEXTS_COM_SECRETESCAPES_USER_STATE_CONTEXT_1[0]['affiliate_url_string']::VARCHAR,
       CONTEXTS_COM_SECRETESCAPES_USER_STATE_CONTEXT_1[0]['is_member']::VARCHAR,
       CONTEXTS_COM_SECRETESCAPES_USER_STATE_CONTEXT_1[0]['opt_in_subscription']::VARCHAR,
       CONTEXTS_COM_SECRETESCAPES_USER_STATE_CONTEXT_1[0]['original_affiliate_id']::VARCHAR,
       CONTEXTS_COM_SECRETESCAPES_USER_STATE_CONTEXT_1[0]['original_affiliate_name']::VARCHAR,
       CONTEXTS_COM_SECRETESCAPES_USER_STATE_CONTEXT_1[0]['se_opt_in_cookie']::VARCHAR,
       CONTEXTS_COM_SECRETESCAPES_USER_STATE_CONTEXT_1[0]['se_sign_up_cookie']::VARCHAR,
       CONTEXTS_COM_SECRETESCAPES_USER_STATE_CONTEXT_1[0]['session_login_type']::VARCHAR,
       CONTEXTS_COM_SECRETESCAPES_USER_STATE_CONTEXT_1[0]['signup_date']::VARCHAR,
       CONTEXTS_COM_SECRETESCAPES_USER_STATE_CONTEXT_1[0]['tracking_id']::VARCHAR,
       CONTEXTS_COM_SECRETESCAPES_USER_STATE_CONTEXT_1[0]['user_id']::VARCHAR,
       CONTEXTS_COM_SECRETESCAPES_USER_STATE_CONTEXT_1[0]['user_type']::VARCHAR,
       CONTEXTS_COM_SECRETESCAPES_USER_STATE_CONTEXT_1
FROM CS_APP_EVENTS
WHERE COLLECTOR_TSTAMP::DATE = '2020-02-05'
  AND CONTEXTS_COM_SECRETESCAPES_USER_STATE_CONTEXT_1[0]['user_id'] != '';

SELECT COUNT(CONTEXTS_COM_SECRETESCAPES_USER_STATE_CONTEXT_1[0]['user_type'])
FROM CS_APP_EVENTS
WHERE COLLECTOR_TSTAMP::DATE = '2020-02-05'
  AND USER_ID IS NOT NULL;


--mobile context
SELECT CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_MOBILE_CONTEXT_1
FROM CS_APP_EVENTS
WHERE COLLECTOR_TSTAMP::DATE = '2020-02-05'
;


SELECT CASE
           WHEN CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_MOBILE_CONTEXT_1[0]['appleIdfa'] IS NULL THEN 'idfa_null'
           ELSE 'idfa_not_null' end,
       count(*)
--        CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_MOBILE_CONTEXT_1[0]['appleIdfv']::VARCHAR,
--         CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_MOBILE_CONTEXT_1
FROM CS_APP_EVENTS
WHERE COLLECTOR_TSTAMP::DATE = '2020-02-05'
group by 1;

SELECT CASE
           WHEN CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_MOBILE_CONTEXT_1[0]['appleIdfv'] IS NULL THEN 'idfv_null'
           ELSE 'idfv_not_null' end,
       count(*)
--        CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_MOBILE_CONTEXT_1[0]['appleIdfv']::VARCHAR,
--         CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_MOBILE_CONTEXT_1
FROM CS_APP_EVENTS
WHERE COLLECTOR_TSTAMP::DATE = '2020-02-05'
group by 1;


SELECT CASE
           WHEN CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_MOBILE_CONTEXT_1[0]['appleIdfv'] IS NULL THEN 'idfv_null'
           ELSE 'idfv_not_null' end,
       count(*)
--        CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_MOBILE_CONTEXT_1[0]['appleIdfv']::VARCHAR,
--         CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_MOBILE_CONTEXT_1
FROM CS_APP_EVENTS
WHERE COLLECTOR_TSTAMP::DATE = '2020-02-05'
group by 1;


--screen context
SELECT CONTEXTS_COM_SECRETESCAPES_SCREEN_CONTEXT_1,
       CONTEXTS_COM_SECRETESCAPES_SCREEN_CONTEXT_1[0]['referring_deep_link']::VARCHAR,
       CONTEXTS_COM_SECRETESCAPES_SCREEN_CONTEXT_1[0]['screen_id']::VARCHAR,
       CONTEXTS_COM_SECRETESCAPES_SCREEN_CONTEXT_1[0]['screen_name']::VARCHAR
FROM CS_APP_EVENTS
WHERE COLLECTOR_TSTAMP::DATE = '2020-02-05';

SELECT CASE
           WHEN CONTEXTS_COM_SECRETESCAPES_SCREEN_CONTEXT_1[0]['screen_name']::VARCHAR = '' tHEN 'screen_context_null'
           else 'screen_context_not_null'
           end as screen_context_status,
       count(*)
FROM CS_APP_EVENTS
WHERE COLLECTOR_TSTAMP::DATE = '2020-02-05'
group by 1;


-- sale page context
SELECT CONTEXTS_COM_SECRETESCAPES_SCREEN_CONTEXT_1[0]['screen_name']::VARCHAR,
       CONTEXTS_COM_SECRETESCAPES_SALE_PAGE_CONTEXT_1
FROM CS_APP_EVENTS
WHERE COLLECTOR_TSTAMP::DATE = '2020-02-05';

SELECT CASE
           WHEN CONTEXTS_COM_SECRETESCAPES_SALE_PAGE_CONTEXT_1[0]['travel_type_info']::VARCHAR = ''
               THEN 'sale_id_is_null'
           else 'sale_id_is_not_null' end as sale_id_status,
--        CONTEXTS_COM_SECRETESCAPES_SALE_PAGE_CONTEXT_1[0]['url_string']::VARCHAR
--        CONTEXTS_COM_SECRETESCAPES_SCREEN_CONTEXT_1[0]['screen_name']::VARCHAR,
--        CONTEXTS_COM_SECRETESCAPES_SALE_PAGE_CONTEXT_1
       COUNT(*)
FROM CS_APP_EVENTS
WHERE COLLECTOR_TSTAMP::DATE = '2020-02-05'
  AND CONTEXTS_COM_SECRETESCAPES_SCREEN_CONTEXT_1[0]['screen_name']::VARCHAR = 'sale page'
group by 1
;


-- user context
SELECT CONTEXTS_COM_SECRETESCAPES_USER_CONTEXT_1
FROM CS_APP_EVENTS
WHERE COLLECTOR_TSTAMP::DATE = '2020-02-05'
  AND CONTEXTS_COM_SECRETESCAPES_USER_CONTEXT_1 IS NOT NULL;


--environment context
SELECT CONTEXTS_COM_SECRETESCAPES_ENVIRONMENT_CONTEXT_1
FROM CS_APP_EVENTS
WHERE COLLECTOR_TSTAMP::DATE = '2020-02-05'
  AND CONTEXTS_COM_SECRETESCAPES_ENVIRONMENT_CONTEXT_1 IS NOT NULL;

--product display context
SELECT CONTEXTS_COM_SECRETESCAPES_PRODUCT_DISPLAY_CONTEXT_1
FROM CS_APP_EVENTS
WHERE COLLECTOR_TSTAMP::DATE = '2020-02-05'
  AND CONTEXTS_COM_SECRETESCAPES_PRODUCT_DISPLAY_CONTEXT_1 IS NOT NULL;

--sale context
SELECT CONTEXTS_COM_SECRETESCAPES_SECRET_ESCAPES_SALE_CONTEXT_1
FROM CS_APP_EVENTS
WHERE COLLECTOR_TSTAMP::DATE = '2020-02-05'
  AND CONTEXTS_COM_SECRETESCAPES_SECRET_ESCAPES_SALE_CONTEXT_1 IS NOT NULL;

--new sale context
SELECT CASE
           WHEN CONTEXTS_COM_SECRETESCAPES_SECRET_ESCAPES_SALE_CONTEXT_1[0]['id']::VARCHAR IS NULL
               OR CONTEXTS_COM_SECRETESCAPES_SECRET_ESCAPES_SALE_CONTEXT_1[0]['id']::VARCHAR = ''
               THEN 'sale_id_is_null'
           else 'sale_id_is_not_null' end as sale_id_status,
       count(*)
FROM CS_APP_EVENTS
WHERE COLLECTOR_TSTAMP::DATE = '2020-02-06'
group by 1;

SELECT CONTEXTS_COM_SECRETESCAPES_SECRET_ESCAPES_SALE_CONTEXT_1[0]['id']::VARCHAR,
       CONTEXTS_COM_SECRETESCAPES_SECRET_ESCAPES_SALE_CONTEXT_1
FROM CS_APP_EVENTS
WHERE COLLECTOR_TSTAMP::DATE = '2020-02-06'
  AND CONTEXTS_COM_SECRETESCAPES_SECRET_ESCAPES_SALE_CONTEXT_1 IS NOT NULL;


--old sale context
SELECT CASE
           WHEN CONTEXTS_COM_SECRETESCAPES_SALE_PAGE_CONTEXT_1[0]['sale_id']::VARCHAR IS NULL
               OR CONTEXTS_COM_SECRETESCAPES_SALE_PAGE_CONTEXT_1[0]['sale_id']::VARCHAR = ''
               THEN 'sale_id_is_null'
           else 'sale_id_is_not_null' end as user_id_status,
       count(*)
FROM CS_APP_EVENTS
WHERE COLLECTOR_TSTAMP::DATE = '2020-02-06'
group by 1;

--client session
SELECT CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_CLIENT_SESSION_1
FROM CS_APP_EVENTS
WHERE COLLECTOR_TSTAMP::DATE = '2020-02-05'
  AND CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_CLIENT_SESSION_1 IS NOT NULL;


SELECT CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_CLIENT_SESSION_1,
       CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_CLIENT_SESSION_1[0]['firstEventId']::VARCHAR,
       CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_CLIENT_SESSION_1[0]['previousSessionId']::VARCHAR,
       CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_CLIENT_SESSION_1[0]['sessionId']::VARCHAR,
       CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_CLIENT_SESSION_1[0]['sessionIndex']::VARCHAR,
       CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_CLIENT_SESSION_1[0]['storageMechanism']::VARCHAR,
       CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_CLIENT_SESSION_1[0]['userId']::VARCHAR
FROM CS_APP_EVENTS
WHERE COLLECTOR_TSTAMP::DATE = '2020-02-05';

SELECT CASE
           WHEN CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_CLIENT_SESSION_1[0]['userId']::VARCHAR IS NULL
               OR CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_CLIENT_SESSION_1[0]['userId']::VARCHAR = ''
               THEN 'user_id_null'
           else 'user_id_not_null' end as user_id_status,
       count(*)
FROM CS_APP_EVENTS
WHERE COLLECTOR_TSTAMP::DATE = '2020-02-05'
group by 1;


SELECT EVENT,
       EVENT_NAME,
       CASE
           WHEN CONTEXTS_COM_SECRETESCAPES_CONTENT_CONTEXT_1 IS NULL
               THEN 'content_context_is_null'
           else 'content_context_is_not_null' end                               as content_context_status,
       CONTEXTS_COM_SECRETESCAPES_CONTENT_CONTEXT_1[0]['sub_category']::VARCHAR as PAGE_NAME,
       CASE
           WHEN CONTEXTS_COM_SECRETESCAPES_SECRET_ESCAPES_SALE_CONTEXT_1[0]['id']::VARCHAR IS NULL
               OR CONTEXTS_COM_SECRETESCAPES_SECRET_ESCAPES_SALE_CONTEXT_1[0]['id']::VARCHAR = ''
               THEN 'sale_id_is_null'
           else 'sale_id_is_not_null' end                                       as sale_id_status,
       COUNT(*)                                                                 AS events
FROM SNOWPLOW.ATOMIC.EVENTS
WHERE COLLECTOR_TSTAMP >= to_date('2020.02.06', 'YYYY.MM.DD')
  AND EVENT NOT IN ('page_ping', 'page_view')
--AND PAGE_NAME LIKE '%booking%'
--   AND CONTEXTS_COM_SECRETESCAPES_CONTENT_CONTEXT_1 IS NOT null
  AND V_TRACKER LIKE '%ios-%'
  AND BR_NAME NOT LIKE 'Robot/Spider'
  AND USERAGENT NOT REGEXP
      '.*(bot|crawl|slurp|spider|archiv|spinn|sniff|seo|audit|survey|pingdom|worm|capture|(browser|screen)shots|analyz|index|thumb|check|facebook|PingdomBot|PhantomJS|YandexBot|Twitterbot|a_archiver|facebookexternalhit|Bingbot|BingPreview|Googlebot|Baiduspider|360(Spider|User-agent)|semalt).*'
GROUP BY 1, 2, 3, 4, 5;

SELECT EVENT,
       EVENT_NAME,
       CONTEXTS_COM_SECRETESCAPES_CONTENT_CONTEXT_1[0]['sub_category']::VARCHAR as PAGE_NAME,
       CASE
           WHEN CONTEXTS_COM_SECRETESCAPES_SECRET_ESCAPES_SALE_CONTEXT_1[0]['id']::VARCHAR IS NULL
               OR CONTEXTS_COM_SECRETESCAPES_SECRET_ESCAPES_SALE_CONTEXT_1[0]['id']::VARCHAR = ''
               THEN 'sale_id_is_null'
           else 'sale_id_is_not_null' end                                       as sale_id_status,
       COUNT(*)
FROM SNOWPLOW.ATOMIC.EVENTS
WHERE COLLECTOR_TSTAMP::DATE = '2020-02-06'
  AND EVENT_NAME = 'screen_view'
--   AND CONTEXTS_COM_SECRETESCAPES_CONTENT_CONTEXT_1 IS NOT null
  AND V_TRACKER LIKE '%ios-%'
  AND BR_NAME NOT LIKE 'Robot/Spider'
  AND USERAGENT NOT REGEXP
      '.*(bot|crawl|slurp|spider|archiv|spinn|sniff|seo|audit|survey|pingdom|worm|capture|(browser|screen)shots|analyz|index|thumb|check|facebook|PingdomBot|PhantomJS|YandexBot|Twitterbot|a_archiver|facebookexternalhit|Bingbot|BingPreview|Googlebot|Baiduspider|360(Spider|User-agent)|semalt).*'
GROUP BY 1, 2, 3, 4

SELECT EVENT_NAME,
       EVENT,
       COLLECTOR_TSTAMP,
       CONTEXTS_COM_SECRETESCAPES_CONTENT_CONTEXT_1[0]['sub_category']::VARCHAR   AS sub_category,
       UNSTRUCT_EVENT_COM_SNOWPLOWANALYTICS_MOBILE_SCREEN_VIEW_1,
       UNSTRUCT_EVENT_COM_SNOWPLOWANALYTICS_MOBILE_SCREEN_VIEW_1['name']::VARCHAR AS screen_view_name
FROM SNOWPLOW.ATOMIC.EVENTS
WHERE COLLECTOR_TSTAMP::DATE = '2020-02-06'
  AND EVENT_NAME = 'screen_view'
--AND PAGE_NAME LIKE '%booking%'
  AND V_TRACKER LIKE '%ios-%'
  AND BR_NAME NOT LIKE 'Robot/Spider'
  AND USERAGENT NOT REGEXP
      '.*(bot|crawl|slurp|spider|archiv|spinn|sniff|seo|audit|survey|pingdom|worm|capture|(browser|screen)shots|analyz|index|thumb|check|facebook|PingdomBot|PhantomJS|YandexBot|Twitterbot|a_archiver|facebookexternalhit|Bingbot|BingPreview|Googlebot|Baiduspider|360(Spider|User-agent)|semalt).*'
  AND CONTEXTS_COM_SECRETESCAPES_CONTENT_CONTEXT_1[0]['sub_category']::VARCHAR = 'sale'
  AND CONTEXTS_COM_SECRETESCAPES_SECRET_ESCAPES_SALE_CONTEXT_1[0]['id']::VARCHAR IS NULL;

SELECT *
FROM SNOWPLOW.ATOMIC.EVENTS
WHERE COLLECTOR_TSTAMP::DATE = '2020-02-06'
  AND EVENT_NAME = 'screen_view'
--AND PAGE_NAME LIKE '%booking%'
  AND V_TRACKER LIKE '%ios-%'
  AND BR_NAME NOT LIKE 'Robot/Spider'
  AND USERAGENT NOT REGEXP
      '.*(bot|crawl|slurp|spider|archiv|spinn|sniff|seo|audit|survey|pingdom|worm|capture|(browser|screen)shots|analyz|index|thumb|check|facebook|PingdomBot|PhantomJS|YandexBot|Twitterbot|a_archiver|facebookexternalhit|Bingbot|BingPreview|Googlebot|Baiduspider|360(Spider|User-agent)|semalt).*'
  AND CONTEXTS_COM_SECRETESCAPES_CONTENT_CONTEXT_1 IS NULL
