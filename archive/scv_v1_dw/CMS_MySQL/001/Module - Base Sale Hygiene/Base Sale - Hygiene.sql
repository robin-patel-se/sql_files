USE WAREHOUSE PIPE_XLARGE;
USE SCHEMA SCRATCH.ROBINPATEL;

CREATE OR REPLACE TABLE BASE_SALE_STREAM
(
    sale_id                         VARCHAR,
    id                              NUMBER,
    version                         NUMBER,
    active                          NUMBER,
    commission                      DOUBLE,
    commission_type                 VARCHAR,
    contractor_id                   NUMBER,
    date_created                    TIMESTAMPNTZ,
    destination_type                VARCHAR,
    display_order                   NUMBER,
    editors_pick                    NUMBER,
    end_date                        TIMESTAMPNTZ,
    excluded_from_api               NUMBER,
    joint_contractor_id             NUMBER,
    last_updated                    TIMESTAMPNTZ,
    main_photo_id                   NUMBER,
    mysterious                      NUMBER,
    smart_stay                      NUMBER,
    start_date                      TIMESTAMPNTZ,
    territory_id                    NUMBER,
    class                           VARCHAR,
    default_hotel_offer_id          NUMBER,
    salesforce_opportunity_id       VARCHAR,
    send_summary                    NUMBER,
    "exclusive"                     BOOLEAN,
    sale_ancillary_details_id       NUMBER,
    travel_type                     VARCHAR,
    default_ihp_offer_id            NUMBER,
    ihp_id                          NUMBER,
    has_flights_available           BOOLEAN,
    preferred_departure_id          NUMBER,
    external_reference              VARCHAR,
    redirect_url                    VARCHAR,
    web_redirect_id                 NUMBER,
    external_base_currency          VARCHAR,
    external_max_number_of_adults   NUMBER,
    external_number_of_hotel_nights NUMBER,
    external_price                  DOUBLE,
    is_flashsale                    INT,
    external_discount               INT,
    external_rack_rate              FLOAT,
    top_discount_override           INT
)
    CLUSTER BY (ID, UPDATED_AT);


MERGE INTO BASE_SALE_STREAM AS TARGET
    USING (
        SELECT 'A' || ID         AS SALE_ID,
               ID,
               VERSION,
               ACTIVE,
               COMMISSION,
               COMMISSION_TYPE,
               CONTRACTOR_ID,
               DATE_CREATED,
               DESTINATION_TYPE, --LONDON, MIDDLE_HAUL, UK, EUROPE, LONG_HAUL
               DISPLAY_ORDER,
               EDITORS_PICK,
               END_DATE,
               EXCLUDED_FROM_API,
               JOINT_CONTRACTOR_ID,
               LAST_UPDATED,
               MAIN_PHOTO_ID,
               MYSTERIOUS,
               SMART_STAY,
               START_DATE,
               TERRITORY_ID,
               CLASS,            -- com.flashsales.sale.IhpSale, com.flashsales.sale.HotelSale, com.flashsales.sale.ConnectedWebRedirectSale
               DEFAULT_HOTEL_OFFER_ID,
               SALESFORCE_OPPORTUNITY_ID,
               SEND_SUMMARY,
               "EXCLUSIVE",
               SALE_ANCILLARY_DETAILS_ID,
               TRAVEL_TYPE,
               DEFAULT_IHP_OFFER_ID,
               IHP_ID,
               HAS_FLIGHTS_AVAILABLE,
               PREFERRED_DEPARTURE_ID,
               EXTERNAL_REFERENCE,
               REDIRECT_URL,
               WEB_REDIRECT_ID,
               EXTERNAL_BASE_CURRENCY,
               EXTERNAL_MAX_NUMBER_OF_ADULTS,
               EXTERNAL_NUMBER_OF_HOTEL_NIGHTS,
               EXTERNAL_PRICE,
               FILENAME,
               FILE_ROW_NUMBER,
               SCHEDULE_TSTAMP,
               SCHEDULE,
               FLUX_PERIODS,
               EXTRACTED_AT,
               DATASET_NAME,
               DATA_SOURCE,
               LOADED_AT,
               CURRENT_TIMESTAMP AS UPDATED_AT
        FROM RAW_VAULT.CMS_MYSQL.BASE_SALE
--         WHERE LOADED_AT >= TIMESTAMPADD('hour', -1, '{schedule_tstamp}'::TIMESTAMP) -- TODO: for batch incremental load
    ) AS BATCH ON TARGET.SALE_ID = BATCH.SALE_ID AND TARGET.LOADED_AT = BATCH.LOADED_AT
    WHEN NOT MATCHED
        THEN INSERT (
                     SALE_ID,
                     ID,
                     VERSION,
                     ACTIVE,
                     COMMISSION,
                     COMMISSION_TYPE,
                     CONTRACTOR_ID,
                     DATE_CREATED,
                     DESTINATION_TYPE,
                     DISPLAY_ORDER,
                     EDITORS_PICK,
                     END_DATE,
                     EXCLUDED_FROM_API,
                     JOINT_CONTRACTOR_ID,
                     LAST_UPDATED,
                     MAIN_PHOTO_ID,
                     MYSTERIOUS,
                     SMART_STAY,
                     START_DATE,
                     TERRITORY_ID,
                     CLASS,
                     DEFAULT_HOTEL_OFFER_ID,
                     SALESFORCE_OPPORTUNITY_ID,
                     SEND_SUMMARY,
                     "EXCLUSIVE",
                     SALE_ANCILLARY_DETAILS_ID,
                     TRAVEL_TYPE,
                     DEFAULT_IHP_OFFER_ID,
                     IHP_ID,
                     HAS_FLIGHTS_AVAILABLE,
                     PREFERRED_DEPARTURE_ID,
                     EXTERNAL_REFERENCE,
                     REDIRECT_URL,
                     WEB_REDIRECT_ID,
                     EXTERNAL_BASE_CURRENCY,
                     EXTERNAL_MAX_NUMBER_OF_ADULTS,
                     EXTERNAL_NUMBER_OF_HOTEL_NIGHTS,
                     EXTERNAL_PRICE,
                     FILENAME,
                     FILE_ROW_NUMBER,
                     SCHEDULE_TSTAMP,
                     SCHEDULE,
                     FLUX_PERIODS,
                     EXTRACTED_AT,
                     DATASET_NAME,
                     DATA_SOURCE,
                     LOADED_AT,
                     UPDATED_AT)
        VALUES (BATCH.SALE_ID,
                BATCH.ID,
                BATCH.VERSION,
                BATCH.ACTIVE,
                BATCH.COMMISSION,
                BATCH.COMMISSION_TYPE,
                BATCH.CONTRACTOR_ID,
                BATCH.DATE_CREATED,
                BATCH.DESTINATION_TYPE,
                BATCH.DISPLAY_ORDER,
                BATCH.EDITORS_PICK,
                BATCH.END_DATE,
                BATCH.EXCLUDED_FROM_API,
                BATCH.JOINT_CONTRACTOR_ID,
                BATCH.LAST_UPDATED,
                BATCH.MAIN_PHOTO_ID,
                BATCH.MYSTERIOUS,
                BATCH.SMART_STAY,
                BATCH.START_DATE,
                BATCH.TERRITORY_ID,
                BATCH.CLASS,
                BATCH.DEFAULT_HOTEL_OFFER_ID,
                BATCH.SALESFORCE_OPPORTUNITY_ID,
                BATCH.SEND_SUMMARY,
                BATCH."EXCLUSIVE",
                BATCH.SALE_ANCILLARY_DETAILS_ID,
                BATCH.TRAVEL_TYPE,
                BATCH.DEFAULT_IHP_OFFER_ID,
                BATCH.IHP_ID,
                BATCH.HAS_FLIGHTS_AVAILABLE,
                BATCH.PREFERRED_DEPARTURE_ID,
                BATCH.EXTERNAL_REFERENCE,
                BATCH.REDIRECT_URL,
                BATCH.WEB_REDIRECT_ID,
                BATCH.EXTERNAL_BASE_CURRENCY,
                BATCH.EXTERNAL_MAX_NUMBER_OF_ADULTS,
                BATCH.EXTERNAL_NUMBER_OF_HOTEL_NIGHTS,
                BATCH.EXTERNAL_PRICE,
                BATCH.FILENAME,
                BATCH.FILE_ROW_NUMBER,
                BATCH.SCHEDULE_TSTAMP,
                BATCH.SCHEDULE,
                BATCH.FLUX_PERIODS,
                BATCH.EXTRACTED_AT,
                BATCH.DATASET_NAME,
                BATCH.DATA_SOURCE,
                BATCH.LOADED_AT,
                BATCH.UPDATED_AT);

------------------------------------------------------------------------------------------------------------------------
CREATE OR REPLACE TABLE HYGIENE_VAULT_MVP_DEV_ROBIN.CMS_MYSQL.BASE_SALE
(
    sale_id                         VARCHAR PRIMARY KEY NOT NULL,
    id                              NUMBER,
    version                         NUMBER,
    active                          NUMBER,
    commission                      DOUBLE,
    commission_type                 VARCHAR,
    contractor_id                   NUMBER,
    date_created                    TIMESTAMP,
    destination_type                VARCHAR,
    display_order                   NUMBER,
    editors_pick                    NUMBER,
    end_date                        TIMESTAMP,
    excluded_from_api               NUMBER,
    joint_contractor_id             NUMBER,
    last_updated                    TIMESTAMP,
    main_photo_id                   NUMBER,
    mysterious                      NUMBER,
    smart_stay                      NUMBER,
    start_date                      TIMESTAMP,
    territory_id                    NUMBER,
    class                           VARCHAR,
    default_hotel_offer_id          NUMBER,
    salesforce_opportunity_id       VARCHAR,
    send_summary                    NUMBER,
    exclusive                       BOOLEAN,
    sale_ancillary_details_id       NUMBER,
    travel_type                     VARCHAR,
    default_ihp_offer_id            NUMBER,
    ihp_id                          NUMBER,
    has_flights_available           BOOLEAN,
    preferred_departure_id          NUMBER,
    external_reference              VARCHAR,
    redirect_url                    VARCHAR,
    web_redirect_id                 NUMBER,
    external_base_currency          VARCHAR,
    external_max_number_of_adults   NUMBER,
    external_number_of_hotel_nights NUMBER,
    external_price                  DOUBLE
);


MERGE INTO HYGIENE_VAULT_MVP_DEV_ROBIN.CMS_MYSQL.BASE_SALE AS TARGET
    USING (
        SELECT 'A' || ID AS sale_id,
               id,
               version,
               active,
               commission,
               commission_type,
               contractor_id,
               date_created,
               destination_type,
               display_order,
               editors_pick,
               end_date,
               excluded_from_api,
               joint_contractor_id,
               last_updated,
               main_photo_id,
               mysterious,
               smart_stay,
               start_date,
               territory_id,
               class,
               default_hotel_offer_id,
               salesforce_opportunity_id,
               send_summary,
            exclusive,
            sale_ancillary_details_id,
            travel_type,
            default_ihp_offer_id,
            ihp_id,
            has_flights_available,
            preferred_departure_id,
            external_reference,
            redirect_url,
            web_redirect_id,
            external_base_currency,
            external_max_number_of_adults,
            external_number_of_hotel_nights,
            external_price
        FROM RAW_VAULT.CMS_MYSQL.BASE_SALE
    ) AS BATCH ON TARGET.SALE_ID = BATCH.SALE_ID
    WHEN MATCHED AND target.last_updated < batch.last_updated
        THEN UPDATE SET
        target.sale_id = batch.sale_id,
        target.id = batch.id,
        target.version = batch.version,
        target.active = batch.active,
        target.commission = batch.commission,
        target.commission_type = batch.commission_type,
        target.contractor_id = batch.contractor_id,
        target.date_created = batch.date_created,
        target.destination_type = batch.destination_type,
        target.display_order = batch.display_order,
        target.editors_pick = batch.editors_pick,
        target.end_date = batch.end_date,
        target.excluded_from_api = batch.excluded_from_api,
        target.joint_contractor_id = batch.joint_contractor_id,
        target.last_updated = batch.last_updated,
        target.main_photo_id = batch.main_photo_id,
        target.mysterious = batch.mysterious,
        target.smart_stay = batch.smart_stay,
        target.start_date = batch.start_date,
        target.territory_id = batch.territory_id,
        target.class = batch.class,
        target.default_hotel_offer_id = batch.default_hotel_offer_id,
        target.salesforce_opportunity_id = batch.salesforce_opportunity_id,
        target.send_summary = batch.send_summary,
        target.exclusive = batch.exclusive,
        target.sale_ancillary_details_id = batch.sale_ancillary_details_id,
        target.travel_type = batch.travel_type,
        target.default_ihp_offer_id = batch.default_ihp_offer_id,
        target.ihp_id = batch.ihp_id,
        target.has_flights_available = batch.has_flights_available,
        target.preferred_departure_id = batch.preferred_departure_id,
        target.external_reference = batch.external_reference,
        target.redirect_url = batch.redirect_url,
        target.web_redirect_id = batch.web_redirect_id,
        target.external_base_currency = batch.external_base_currency,
        target.external_max_number_of_adults = batch.external_max_number_of_adults,
        target.external_number_of_hotel_nights = batch.external_number_of_hotel_nights,
        target.external_price = batch.external_price
    WHEN NOT MATCHED
        THEN INSERT VALUES (
                    batch.sale_id,
                    batch.id,
                    batch.version,
                    batch.active,
                    batch.commission,
                    batch.commission_type,
                    batch.contractor_id,
                    batch.date_created,
                    batch.destination_type,
                    batch.display_order,
                    batch.editors_pick,
                    batch.end_date,
                    batch.excluded_from_api,
                    batch.joint_contractor_id,
                    batch.last_updated,
                    batch.main_photo_id,
                    batch.mysterious,
                    batch.smart_stay,
                    batch.start_date,
                    batch.territory_id,
                    batch.class,
                    batch.default_hotel_offer_id,
                    batch.salesforce_opportunity_id,
                    batch.send_summary,
                    batch.exclusive,
                    batch.sale_ancillary_details_id,
                    batch.travel_type,
                    batch.default_ihp_offer_id,
                    batch.ihp_id,
                    batch.has_flights_available,
                    batch.preferred_departure_id,
                    batch.external_reference,
                    batch.redirect_url,
                    batch.web_redirect_id,
                    batch.external_base_currency,
                    batch.external_max_number_of_adults,
                    batch.external_number_of_hotel_nights,
                    batch.external_price
                    );