USE WAREHOUSE PIPE_XLARGE;
USE SCHEMA SCRATCH.ROBINPATEL;

CREATE OR REPLACE TABLE HOTEL_STREAM
(
    ID                             NUMBER,
    VERSION                        NUMBER,
    BASE_CURRENCY                  VARCHAR,
    CITY_DISTRICT_ID               NUMBER,
    COMMISSION                     DOUBLE,
    COMMISSION_TYPE                VARCHAR,
    COMPANY_ID                     NUMBER,
    CONTRACTOR_ID                  NUMBER,
    DEFAULT_PREFERRED_AIRPORT_CODE VARCHAR,
    HOTEL_CODE                     VARCHAR,
    JOINT_CONTRACTOR_ID            NUMBER,
    LATITUDE                       DOUBLE,
    LOCATION_INFO_ID               NUMBER,
    LONGITUDE                      DOUBLE,
    SEND_SUMMARY                   NUMBER,
    TRIP_ADVISOR_RATINGS_IMAGE_URL VARCHAR,
    VAT_EXCLUSIVE                  NUMBER,
    MAP_ZOOM_LEVEL                 NUMBER,
    DATASET_NAME                   VARCHAR,
    DATASET_SOURCE                 VARCHAR,
    SCHEDULE_INTERVAL              VARCHAR,
    SCHEDULE_TSTAMP                TIMESTAMPNTZ,
    RUN_TSTAMP                     TIMESTAMPNTZ,
    LOADED_AT                      TIMESTAMPNTZ,
    FILENAME                       VARCHAR,
    FILE_ROW_NUMBER                NUMBER,
    UPDATED_AT                     TIMESTAMPLTZ
)
    CLUSTER BY (ID, UPDATED_AT);

MERGE INTO HOTEL_STREAM AS TARGET
    USING (
        SELECT ID,
               VERSION,
               BASE_CURRENCY,
               CITY_DISTRICT_ID,
               COMMISSION,
               COMMISSION_TYPE,
               COMPANY_ID,
               CONTRACTOR_ID,
               DEFAULT_PREFERRED_AIRPORT_CODE,
               HOTEL_CODE,
               JOINT_CONTRACTOR_ID,
               LATITUDE,
               LOCATION_INFO_ID,
               LONGITUDE,
               SEND_SUMMARY,
               TRIP_ADVISOR_RATINGS_IMAGE_URL,
               VAT_EXCLUSIVE,
               MAP_ZOOM_LEVEL,
               DATASET_NAME,
               DATASET_SOURCE,
               SCHEDULE_INTERVAL,
               SCHEDULE_TSTAMP,
               RUN_TSTAMP,
               LOADED_AT,
               FILENAME,
               FILE_ROW_NUMBER,
               CURRENT_TIMESTAMP AS UPDATED_AT
        FROM RAW_VAULT_MVP.CMS_MYSQL.HOTEL
--         WHERE LOADED_AT >= TIMESTAMPADD('hour', -1, '{schedule_tstamp}'::TIMESTAMP) -- TODO: for batch incremental load
    ) AS BATCH ON TARGET.ID = BATCH.ID AND TARGET.LOADED_AT = BATCH.LOADED_AT
    WHEN NOT MATCHED
        THEN INSERT (
                     ID,
                     VERSION,
                     BASE_CURRENCY,
                     CITY_DISTRICT_ID,
                     COMMISSION,
                     COMMISSION_TYPE,
                     COMPANY_ID,
                     CONTRACTOR_ID,
                     DEFAULT_PREFERRED_AIRPORT_CODE,
                     HOTEL_CODE,
                     JOINT_CONTRACTOR_ID,
                     LATITUDE,
                     LOCATION_INFO_ID,
                     LONGITUDE,
                     SEND_SUMMARY,
                     TRIP_ADVISOR_RATINGS_IMAGE_URL,
                     VAT_EXCLUSIVE,
                     MAP_ZOOM_LEVEL,
                     DATASET_NAME,
                     DATASET_SOURCE,
                     SCHEDULE_INTERVAL,
                     SCHEDULE_TSTAMP,
                     RUN_TSTAMP,
                     LOADED_AT,
                     FILENAME,
                     FILE_ROW_NUMBER,
                     UPDATED_AT
        )
        VALUES (BATCH.ID,
                BATCH.VERSION,
                BATCH.BASE_CURRENCY,
                BATCH.CITY_DISTRICT_ID,
                BATCH.COMMISSION,
                BATCH.COMMISSION_TYPE,
                BATCH.COMPANY_ID,
                BATCH.CONTRACTOR_ID,
                BATCH.DEFAULT_PREFERRED_AIRPORT_CODE,
                BATCH.HOTEL_CODE,
                BATCH.JOINT_CONTRACTOR_ID,
                BATCH.LATITUDE,
                BATCH.LOCATION_INFO_ID,
                BATCH.LONGITUDE,
                BATCH.SEND_SUMMARY,
                BATCH.TRIP_ADVISOR_RATINGS_IMAGE_URL,
                BATCH.VAT_EXCLUSIVE,
                BATCH.MAP_ZOOM_LEVEL,
                BATCH.DATASET_NAME,
                BATCH.DATASET_SOURCE,
                BATCH.SCHEDULE_INTERVAL,
                BATCH.SCHEDULE_TSTAMP,
                BATCH.RUN_TSTAMP,
                BATCH.LOADED_AT,
                BATCH.FILENAME,
                BATCH.FILE_ROW_NUMBER,
                BATCH.UPDATED_AT);


CREATE OR REPLACE TABLE RAW_VAULT_MVP_DEV_ROBIN.CMS_MYSQL.HOTEL CLONE RAW_VAULT_MVP.CMS_MYSQL.HOTEL;