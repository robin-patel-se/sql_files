USE WAREHOUSE PIPE_XLARGE;
USE SCHEMA SCRATCH.ROBINPATEL;

CREATE OR REPLACE TABLE MODULE_CURRENT_BASE_SALE
(
    SALE_ID                         VARCHAR,
    ID                              NUMBER,
    VERSION                         NUMBER,
    ACTIVE                          NUMBER,
    COMMISSION                      DOUBLE,
    COMMISSION_TYPE                 VARCHAR,
    CONTRACTOR_ID                   NUMBER,
    DATE_CREATED                    TIMESTAMPNTZ,
    DESTINATION_TYPE                VARCHAR,
    DISPLAY_ORDER                   NUMBER,
    EDITORS_PICK                    NUMBER,
    END_DATE                        TIMESTAMPNTZ,
    EXCLUDED_FROM_API               NUMBER,
    JOINT_CONTRACTOR_ID             NUMBER,
    LAST_UPDATED                    TIMESTAMPNTZ,
    MAIN_PHOTO_ID                   NUMBER,
    MYSTERIOUS                      NUMBER,
    SMART_STAY                      NUMBER,
    START_DATE                      TIMESTAMPNTZ,
    TERRITORY_ID                    NUMBER,
    CLASS                           VARCHAR,
    DEFAULT_HOTEL_OFFER_ID          NUMBER,
    SALESFORCE_OPPORTUNITY_ID       VARCHAR,
    SEND_SUMMARY                    NUMBER,
    "EXCLUSIVE"                     BOOLEAN,
    SALE_ANCILLARY_DETAILS_ID       NUMBER,
    TRAVEL_TYPE                     VARCHAR,
    DEFAULT_IHP_OFFER_ID            NUMBER,
    IHP_ID                          NUMBER,
    HAS_FLIGHTS_AVAILABLE           BOOLEAN,
    PREFERRED_DEPARTURE_ID          NUMBER,
    EXTERNAL_REFERENCE              VARCHAR,
    REDIRECT_URL                    VARCHAR,
    WEB_REDIRECT_ID                 NUMBER,
    EXTERNAL_BASE_CURRENCY          VARCHAR,
    EXTERNAL_MAX_NUMBER_OF_ADULTS   NUMBER,
    EXTERNAL_NUMBER_OF_HOTEL_NIGHTS NUMBER,
    EXTERNAL_PRICE                  DOUBLE,
    FILENAME                        VARCHAR,
    FILE_ROW_NUMBER                 NUMBER,
    SCHEDULE_TSTAMP                 TIMESTAMPNTZ,
    SCHEDULE                        VARCHAR,
    FLUX_PERIODS                    NUMBER,
    EXTRACTED_AT                    TIMESTAMPNTZ,
    DATASET_NAME                    VARCHAR,
    DATA_SOURCE                     VARCHAR,
    LOADED_AT                       TIMESTAMPNTZ,
    UPDATED_AT                      TIMESTAMPLTZ
)
    CLUSTER BY (ID, UPDATED_AT);



MERGE INTO MODULE_CURRENT_BASE_SALE AS TARGET
    USING (
        WITH row_number AS ( --create index based on import recency
            SELECT b.*,
                   ROW_NUMBER() OVER (PARTITION BY b.id ORDER BY b.LOADED_AT DESC) AS rn
            FROM BASE_SALE_STREAM b
--             WHERE UPDATED_AT >= TIMESTAMPADD('hour', -1, '{schedule_tstamp}'::TIMESTAMP) -- TODO: for batch incremental load

        )
        SELECT SALE_ID,
               ID,
               VERSION,
               ACTIVE,
               COMMISSION,
               COMMISSION_TYPE,
               CONTRACTOR_ID,
               DATE_CREATED,
               DESTINATION_TYPE,
               DISPLAY_ORDER,
               EDITORS_PICK,
               END_DATE,
               EXCLUDED_FROM_API,
               JOINT_CONTRACTOR_ID,
               LAST_UPDATED,
               MAIN_PHOTO_ID,
               MYSTERIOUS,
               SMART_STAY,
               START_DATE,
               TERRITORY_ID,
               CLASS,
               DEFAULT_HOTEL_OFFER_ID,
               SALESFORCE_OPPORTUNITY_ID,
               SEND_SUMMARY,
               "EXCLUSIVE",
               SALE_ANCILLARY_DETAILS_ID,
               TRAVEL_TYPE,
               DEFAULT_IHP_OFFER_ID,
               IHP_ID,
               HAS_FLIGHTS_AVAILABLE,
               PREFERRED_DEPARTURE_ID,
               EXTERNAL_REFERENCE,
               REDIRECT_URL,
               WEB_REDIRECT_ID,
               EXTERNAL_BASE_CURRENCY,
               EXTERNAL_MAX_NUMBER_OF_ADULTS,
               EXTERNAL_NUMBER_OF_HOTEL_NIGHTS,
               EXTERNAL_PRICE,
               FILENAME,
               FILE_ROW_NUMBER,
               SCHEDULE_TSTAMP,
               SCHEDULE,
               FLUX_PERIODS,
               EXTRACTED_AT,
               DATASET_NAME,
               DATA_SOURCE,
               LOADED_AT,
               CURRENT_TIMESTAMP AS UPDATED_AT
        FROM row_number
        WHERE rn = 1
    ) AS BATCH ON TARGET.ID = BATCH.ID
    WHEN NOT MATCHED
        THEN INSERT (
                     SALE_ID,
                     ID,
                     VERSION,
                     ACTIVE,
                     COMMISSION,
                     COMMISSION_TYPE,
                     CONTRACTOR_ID,
                     DATE_CREATED,
                     DESTINATION_TYPE,
                     DISPLAY_ORDER,
                     EDITORS_PICK,
                     END_DATE,
                     EXCLUDED_FROM_API,
                     JOINT_CONTRACTOR_ID,
                     LAST_UPDATED,
                     MAIN_PHOTO_ID,
                     MYSTERIOUS,
                     SMART_STAY,
                     START_DATE,
                     TERRITORY_ID,
                     CLASS,
                     DEFAULT_HOTEL_OFFER_ID,
                     SALESFORCE_OPPORTUNITY_ID,
                     SEND_SUMMARY,
                     "EXCLUSIVE",
                     SALE_ANCILLARY_DETAILS_ID,
                     TRAVEL_TYPE,
                     DEFAULT_IHP_OFFER_ID,
                     IHP_ID,
                     HAS_FLIGHTS_AVAILABLE,
                     PREFERRED_DEPARTURE_ID,
                     EXTERNAL_REFERENCE,
                     REDIRECT_URL,
                     WEB_REDIRECT_ID,
                     EXTERNAL_BASE_CURRENCY,
                     EXTERNAL_MAX_NUMBER_OF_ADULTS,
                     EXTERNAL_NUMBER_OF_HOTEL_NIGHTS,
                     EXTERNAL_PRICE,
                     FILENAME,
                     FILE_ROW_NUMBER,
                     SCHEDULE_TSTAMP,
                     SCHEDULE,
                     FLUX_PERIODS,
                     EXTRACTED_AT,
                     DATASET_NAME,
                     DATA_SOURCE,
                     LOADED_AT,
                     UPDATED_AT
        ) VALUES (BATCH.SALE_ID,
                  BATCH.ID,
                  BATCH.VERSION,
                  BATCH.ACTIVE,
                  BATCH.COMMISSION,
                  BATCH.COMMISSION_TYPE,
                  BATCH.CONTRACTOR_ID,
                  BATCH.DATE_CREATED,
                  BATCH.DESTINATION_TYPE,
                  BATCH.DISPLAY_ORDER,
                  BATCH.EDITORS_PICK,
                  BATCH.END_DATE,
                  BATCH.EXCLUDED_FROM_API,
                  BATCH.JOINT_CONTRACTOR_ID,
                  BATCH.LAST_UPDATED,
                  BATCH.MAIN_PHOTO_ID,
                  BATCH.MYSTERIOUS,
                  BATCH.SMART_STAY,
                  BATCH.START_DATE,
                  BATCH.TERRITORY_ID,
                  BATCH.CLASS,
                  BATCH.DEFAULT_HOTEL_OFFER_ID,
                  BATCH.SALESFORCE_OPPORTUNITY_ID,
                  BATCH.SEND_SUMMARY,
                  BATCH."EXCLUSIVE",
                  BATCH.SALE_ANCILLARY_DETAILS_ID,
                  BATCH.TRAVEL_TYPE,
                  BATCH.DEFAULT_IHP_OFFER_ID,
                  BATCH.IHP_ID,
                  BATCH.HAS_FLIGHTS_AVAILABLE,
                  BATCH.PREFERRED_DEPARTURE_ID,
                  BATCH.EXTERNAL_REFERENCE,
                  BATCH.REDIRECT_URL,
                  BATCH.WEB_REDIRECT_ID,
                  BATCH.EXTERNAL_BASE_CURRENCY,
                  BATCH.EXTERNAL_MAX_NUMBER_OF_ADULTS,
                  BATCH.EXTERNAL_NUMBER_OF_HOTEL_NIGHTS,
                  BATCH.EXTERNAL_PRICE,
                  BATCH.FILENAME,
                  BATCH.FILE_ROW_NUMBER,
                  BATCH.SCHEDULE_TSTAMP,
                  BATCH.SCHEDULE,
                  BATCH.FLUX_PERIODS,
                  BATCH.EXTRACTED_AT,
                  BATCH.DATASET_NAME,
                  BATCH.DATA_SOURCE,
                  BATCH.LOADED_AT,
                  BATCH.UPDATED_AT)
    WHEN MATCHED AND TARGET.LOADED_AT < BATCH.LOADED_AT
        THEN UPDATE SET
        TARGET.SALE_ID = BATCH.SALE_ID,
        TARGET.ID = BATCH.ID,
        TARGET.VERSION = BATCH.VERSION,
        TARGET.ACTIVE = BATCH.ACTIVE,
        TARGET.COMMISSION = BATCH.COMMISSION,
        TARGET.COMMISSION_TYPE = BATCH.COMMISSION_TYPE,
        TARGET.CONTRACTOR_ID = BATCH.CONTRACTOR_ID,
        TARGET.DATE_CREATED = BATCH.DATE_CREATED,
        TARGET.DESTINATION_TYPE = BATCH.DESTINATION_TYPE,
        TARGET.DISPLAY_ORDER = BATCH.DISPLAY_ORDER,
        TARGET.EDITORS_PICK = BATCH.EDITORS_PICK,
        TARGET.END_DATE = BATCH.END_DATE,
        TARGET.EXCLUDED_FROM_API = BATCH.EXCLUDED_FROM_API,
        TARGET.JOINT_CONTRACTOR_ID = BATCH.JOINT_CONTRACTOR_ID,
        TARGET.LAST_UPDATED = BATCH.LAST_UPDATED,
        TARGET.MAIN_PHOTO_ID = BATCH.MAIN_PHOTO_ID,
        TARGET.MYSTERIOUS = BATCH.MYSTERIOUS,
        TARGET.SMART_STAY = BATCH.SMART_STAY,
        TARGET.START_DATE = BATCH.START_DATE,
        TARGET.TERRITORY_ID = BATCH.TERRITORY_ID,
        TARGET.CLASS = BATCH.CLASS,
        TARGET.DEFAULT_HOTEL_OFFER_ID = BATCH.DEFAULT_HOTEL_OFFER_ID,
        TARGET.SALESFORCE_OPPORTUNITY_ID = BATCH.SALESFORCE_OPPORTUNITY_ID,
        TARGET.SEND_SUMMARY = BATCH.SEND_SUMMARY,
        TARGET."EXCLUSIVE" = BATCH."EXCLUSIVE",
        TARGET.SALE_ANCILLARY_DETAILS_ID = BATCH.SALE_ANCILLARY_DETAILS_ID,
        TARGET.TRAVEL_TYPE = BATCH.TRAVEL_TYPE,
        TARGET.DEFAULT_IHP_OFFER_ID = BATCH.DEFAULT_IHP_OFFER_ID,
        TARGET.IHP_ID = BATCH.IHP_ID,
        TARGET.HAS_FLIGHTS_AVAILABLE = BATCH.HAS_FLIGHTS_AVAILABLE,
        TARGET.PREFERRED_DEPARTURE_ID = BATCH.PREFERRED_DEPARTURE_ID,
        TARGET.EXTERNAL_REFERENCE = BATCH.EXTERNAL_REFERENCE,
        TARGET.REDIRECT_URL = BATCH.REDIRECT_URL,
        TARGET.WEB_REDIRECT_ID = BATCH.WEB_REDIRECT_ID,
        TARGET.EXTERNAL_BASE_CURRENCY = BATCH.EXTERNAL_BASE_CURRENCY,
        TARGET.EXTERNAL_MAX_NUMBER_OF_ADULTS = BATCH.EXTERNAL_MAX_NUMBER_OF_ADULTS,
        TARGET.EXTERNAL_NUMBER_OF_HOTEL_NIGHTS = BATCH.EXTERNAL_NUMBER_OF_HOTEL_NIGHTS,
        TARGET.EXTERNAL_PRICE = BATCH.EXTERNAL_PRICE,
        TARGET.FILENAME = BATCH.FILENAME,
        TARGET.FILE_ROW_NUMBER = BATCH.FILE_ROW_NUMBER,
        TARGET.SCHEDULE_TSTAMP = BATCH.SCHEDULE_TSTAMP,
        TARGET.SCHEDULE = BATCH.SCHEDULE,
        TARGET.FLUX_PERIODS = BATCH.FLUX_PERIODS,
        TARGET.EXTRACTED_AT = BATCH.EXTRACTED_AT,
        TARGET.DATASET_NAME = BATCH.DATASET_NAME,
        TARGET.DATA_SOURCE = BATCH.DATA_SOURCE,
        TARGET.LOADED_AT = BATCH.LOADED_AT,
        TARGET.UPDATED_AT = BATCH.UPDATED_AT;


------------------------------------------------------------------------------------------------------------------------
--assertions
SELECT CASE WHEN COUNT(*) > 0 THEN FALSE ELSE TRUE END AS UNIQUE_SALE_ID
FROM (
         SELECT SALE_ID
         FROM MODULE_CURRENT_BASE_SALE
         GROUP BY 1
         HAVING COUNT(*) > 1);
)