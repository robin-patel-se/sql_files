USE WAREHOUSE PIPE_XLARGE;
USE SCHEMA SCRATCH.ROBINPATEL;

CREATE OR REPLACE TABLE MODULE_CURRENT_SALE
(
    SALE_ID                    VARCHAR,
    ID                         NUMBER,
    VERSION                    NUMBER,
    ACTIVE                     NUMBER,
    DATE_CREATED               TIMESTAMPNTZ,
    DESTINATION_NAME           VARCHAR,
    END_DATE                   TIMESTAMPNTZ,
    LAST_UPDATED               TIMESTAMPNTZ,
    LOCATION                   VARCHAR,
    SLUG                       VARCHAR,
    START_DATE                 TIMESTAMPNTZ,
    TITLE                      VARCHAR,
    TOP_DISCOUNT               NUMBER,
    TYPE                       VARCHAR,
    PROMOTION                  VARCHAR,
    COMMISSION                 DOUBLE,
    DISCOUNT_NOTE              VARCHAR,
    BOARD_TYPE                 VARCHAR,
    DESTINATION_TYPE           VARCHAR,
    HALO                       NUMBER,
    PROMOTED                   NUMBER,
    TRAVEL_TYPE                VARCHAR,
    CONTRACTOR_ID              NUMBER,
    ROOM_DESCRIPTION           VARCHAR,
    VAT_EXCLUSIVE              NUMBER,
    REQUIRE_ADDRESS            NUMBER,
    REQUIRE_AGE                NUMBER,
    REQUIRE_PASSPORT           NUMBER,
    REQUIRE_TITLE              NUMBER,
    CUSTOM_URL_SLUG            VARCHAR,
    COMMISSION_TYPE            VARCHAR,
    DEFAULT_OFFER_ID           NUMBER,
    SHOW_DISCOUNT_PREFIX       NUMBER,
    ENABLE_HOLD                NUMBER,
    MYSTERIOUS                 NUMBER,
    MYSTERIOUS_TITLE           VARCHAR,
    PREMIUM                    DOUBLE,
    INSTANT                    NUMBER,
    INSTANT_DESTINATION        VARCHAR,
    INSTANT_TYPE               VARCHAR,
    BASE_CURRENCY              VARCHAR,
    DEPOSIT                    NUMBER,
    CLOSEST_AIRPORT_CODE       VARCHAR,
    REQUIRE_DATE_OF_BIRTH      NUMBER,
    TOP_DISCOUNT_EUR           NUMBER,
    TOP_DISCOUNT_GBP           NUMBER,
    TOP_DISCOUNT_SEK           NUMBER,
    MAIN_PHOTO_ID              NUMBER,
    COUNTY                     VARCHAR,
    DESTINATION_COUNTRY        VARCHAR,
    SHOW_PRICE                 NUMBER,
    REPEATED                   NUMBER,
    LOCATION_INFO_ID           NUMBER,
    CITY_DISTRICT_ID           NUMBER,
    JB_HOTEL_ID                NUMBER,
    TOP_DISCOUNT_USD           NUMBER,
    TOP_DISCOUNT_DKK           NUMBER,
    SEND_SUMMARY               NUMBER,
    TOP_DISCOUNT_NOK           NUMBER,
    TOP_DISCOUNT_CHF           NUMBER,
    WITH_SHARED_ALLOCATIONS    NUMBER,
    SALESFORCE_OPPORTUNITY_ID  VARCHAR,
    SALE_ANCILLARY_DETAILS_ID  NUMBER,
    SUPPLIER_ID                NUMBER,
    SMART_STAY                 NUMBER,
    HOTEL_CHAIN_LINK           VARCHAR,
    EXCLUDED_FROM_API          NUMBER,
    TOP_DISCOUNT_PLN           NUMBER,
    TOP_DISCOUNT_SGD           NUMBER,
    TOP_DISCOUNT_PHP           NUMBER,
    TOP_DISCOUNT_IDR           NUMBER,
    TOP_DISCOUNT_HKD           NUMBER,
    TOP_DISCOUNT_MYR           NUMBER,
    TRIP_ADVISOR_RATINGS_IMAGE VARCHAR,
    TOP_DISCOUNT_CZK           NUMBER,
    TOP_DISCOUNT_HUF           NUMBER,
    IS_EAN_SECRET_PRICE_SALE   NUMBER,
    IS_CEE_SALE                NUMBER,
    IS_ABLE_TO_SELL_FLIGHTS    NUMBER,
    JOINT_CONTRACTOR_ID        NUMBER,
    IS_TEAM20PACKAGE           NUMBER,
    IS_OVERNIGHT_FLIGHT        NUMBER,
    ZERO_DEPOSIT               NUMBER,
    SKI_INSURANCE              NUMBER,
    ADDITIONAL_TEXT            VARCHAR,
    MAIN_PARAGRAPH             VARCHAR,
    MAP_LOCATION               VARCHAR,
    NEED_TO_KNOW               VARCHAR,
    SECOND_OPINION             VARCHAR,
    WE_LIKE                    VARCHAR,
    HOTEL_DETAILS              VARCHAR,
    TRAVEL_DETAILS             VARCHAR,
    REASON_TO_LOVE             VARCHAR,
    EXPIRED_COPY               VARCHAR,
    REVIEWS                    VARCHAR,
    DEAL_INCLUDES              VARCHAR,
    PRICE_COMPARE              VARCHAR,
    NOTES                      VARCHAR,
    "EXCLUSIVE"                BOOLEAN,
    FILENAME                   VARCHAR,
    FILE_ROW_NUMBER            NUMBER,
    SCHEDULE_TSTAMP            TIMESTAMPNTZ,
    SCHEDULE                   VARCHAR,
    FLUX_PERIODS               NUMBER,
    EXTRACTED_AT               TIMESTAMPNTZ,
    DATASET_NAME               VARCHAR,
    DATA_SOURCE                VARCHAR,
    LOADED_AT                  TIMESTAMPNTZ,
    UPDATED_AT                 TIMESTAMPLTZ
)
    CLUSTER BY (ID, UPDATED_AT);

MERGE INTO MODULE_CURRENT_SALE AS TARGET
    USING (
        WITH row_number AS ( --create index based on import recency
            SELECT s.*,
                   ROW_NUMBER() OVER (PARTITION BY s.id ORDER BY s.LOADED_AT DESC) AS rn
            FROM SALE_STREAM s
--              WHERE s.UPDATED_AT >= TIMESTAMPADD('hour', -1, '{schedule_tstamp}'::TIMESTAMP) -- TODO: for batch incremental load
        )
        SELECT SALE_ID,
               ID,
               VERSION,
               ACTIVE,
               DATE_CREATED,
               DESTINATION_NAME,
               END_DATE,
               LAST_UPDATED,
               LOCATION,
               SLUG,
               START_DATE,
               TITLE,
               TOP_DISCOUNT,
               TYPE,
               PROMOTION,
               COMMISSION,
               DISCOUNT_NOTE,
               BOARD_TYPE,
               DESTINATION_TYPE,
               HALO,
               PROMOTED,
               TRAVEL_TYPE,
               CONTRACTOR_ID,
               ROOM_DESCRIPTION,
               VAT_EXCLUSIVE,
               REQUIRE_ADDRESS,
               REQUIRE_AGE,
               REQUIRE_PASSPORT,
               REQUIRE_TITLE,
               CUSTOM_URL_SLUG,
               COMMISSION_TYPE,
               DEFAULT_OFFER_ID,
               SHOW_DISCOUNT_PREFIX,
               ENABLE_HOLD,
               MYSTERIOUS,
               MYSTERIOUS_TITLE,
               PREMIUM,
               INSTANT,
               INSTANT_DESTINATION,
               INSTANT_TYPE,
               BASE_CURRENCY,
               DEPOSIT,
               CLOSEST_AIRPORT_CODE,
               REQUIRE_DATE_OF_BIRTH,
               TOP_DISCOUNT_EUR,
               TOP_DISCOUNT_GBP,
               TOP_DISCOUNT_SEK,
               MAIN_PHOTO_ID,
               COUNTY,
               DESTINATION_COUNTRY,
               SHOW_PRICE,
               REPEATED,
               LOCATION_INFO_ID,
               CITY_DISTRICT_ID,
               JB_HOTEL_ID,
               TOP_DISCOUNT_USD,
               TOP_DISCOUNT_DKK,
               SEND_SUMMARY,
               TOP_DISCOUNT_NOK,
               TOP_DISCOUNT_CHF,
               WITH_SHARED_ALLOCATIONS,
               SALESFORCE_OPPORTUNITY_ID,
               SALE_ANCILLARY_DETAILS_ID,
               SUPPLIER_ID,
               SMART_STAY,
               HOTEL_CHAIN_LINK,
               EXCLUDED_FROM_API,
               TOP_DISCOUNT_PLN,
               TOP_DISCOUNT_SGD,
               TOP_DISCOUNT_PHP,
               TOP_DISCOUNT_IDR,
               TOP_DISCOUNT_HKD,
               TOP_DISCOUNT_MYR,
               TRIP_ADVISOR_RATINGS_IMAGE,
               TOP_DISCOUNT_CZK,
               TOP_DISCOUNT_HUF,
               IS_EAN_SECRET_PRICE_SALE,
               IS_CEE_SALE,
               IS_ABLE_TO_SELL_FLIGHTS,
               JOINT_CONTRACTOR_ID,
               IS_TEAM20PACKAGE,
               IS_OVERNIGHT_FLIGHT,
               ZERO_DEPOSIT,
               SKI_INSURANCE,
               ADDITIONAL_TEXT,
               MAIN_PARAGRAPH,
               MAP_LOCATION,
               NEED_TO_KNOW,
               SECOND_OPINION,
               WE_LIKE,
               HOTEL_DETAILS,
               TRAVEL_DETAILS,
               REASON_TO_LOVE,
               EXPIRED_COPY,
               REVIEWS,
               DEAL_INCLUDES,
               PRICE_COMPARE,
               NOTES,
               "EXCLUSIVE",
               FILENAME,
               FILE_ROW_NUMBER,
               SCHEDULE_TSTAMP,
               SCHEDULE,
               FLUX_PERIODS,
               EXTRACTED_AT,
               DATASET_NAME,
               DATA_SOURCE,
               LOADED_AT,
               CURRENT_TIMESTAMP AS UPDATED_AT
        FROM row_number
        WHERE rn = 1
    ) AS BATCH ON TARGET.SALE_ID = BATCH.SALE_ID
    WHEN NOT MATCHED
        THEN INSERT (SALE_ID,
                     ID,
                     VERSION,
                     ACTIVE,
                     DATE_CREATED,
                     DESTINATION_NAME,
                     END_DATE,
                     LAST_UPDATED,
                     LOCATION,
                     SLUG,
                     START_DATE,
                     TITLE,
                     TOP_DISCOUNT,
                     TYPE,
                     PROMOTION,
                     COMMISSION,
                     DISCOUNT_NOTE,
                     BOARD_TYPE,
                     DESTINATION_TYPE,
                     HALO,
                     PROMOTED,
                     TRAVEL_TYPE,
                     CONTRACTOR_ID,
                     ROOM_DESCRIPTION,
                     VAT_EXCLUSIVE,
                     REQUIRE_ADDRESS,
                     REQUIRE_AGE,
                     REQUIRE_PASSPORT,
                     REQUIRE_TITLE,
                     CUSTOM_URL_SLUG,
                     COMMISSION_TYPE,
                     DEFAULT_OFFER_ID,
                     SHOW_DISCOUNT_PREFIX,
                     ENABLE_HOLD,
                     MYSTERIOUS,
                     MYSTERIOUS_TITLE,
                     PREMIUM,
                     INSTANT,
                     INSTANT_DESTINATION,
                     INSTANT_TYPE,
                     BASE_CURRENCY,
                     DEPOSIT,
                     CLOSEST_AIRPORT_CODE,
                     REQUIRE_DATE_OF_BIRTH,
                     TOP_DISCOUNT_EUR,
                     TOP_DISCOUNT_GBP,
                     TOP_DISCOUNT_SEK,
                     MAIN_PHOTO_ID,
                     COUNTY,
                     DESTINATION_COUNTRY,
                     SHOW_PRICE,
                     REPEATED,
                     LOCATION_INFO_ID,
                     CITY_DISTRICT_ID,
                     JB_HOTEL_ID,
                     TOP_DISCOUNT_USD,
                     TOP_DISCOUNT_DKK,
                     SEND_SUMMARY,
                     TOP_DISCOUNT_NOK,
                     TOP_DISCOUNT_CHF,
                     WITH_SHARED_ALLOCATIONS,
                     SALESFORCE_OPPORTUNITY_ID,
                     SALE_ANCILLARY_DETAILS_ID,
                     SUPPLIER_ID,
                     SMART_STAY,
                     HOTEL_CHAIN_LINK,
                     EXCLUDED_FROM_API,
                     TOP_DISCOUNT_PLN,
                     TOP_DISCOUNT_SGD,
                     TOP_DISCOUNT_PHP,
                     TOP_DISCOUNT_IDR,
                     TOP_DISCOUNT_HKD,
                     TOP_DISCOUNT_MYR,
                     TRIP_ADVISOR_RATINGS_IMAGE,
                     TOP_DISCOUNT_CZK,
                     TOP_DISCOUNT_HUF,
                     IS_EAN_SECRET_PRICE_SALE,
                     IS_CEE_SALE,
                     IS_ABLE_TO_SELL_FLIGHTS,
                     JOINT_CONTRACTOR_ID,
                     IS_TEAM20PACKAGE,
                     IS_OVERNIGHT_FLIGHT,
                     ZERO_DEPOSIT,
                     SKI_INSURANCE,
                     ADDITIONAL_TEXT,
                     MAIN_PARAGRAPH,
                     MAP_LOCATION,
                     NEED_TO_KNOW,
                     SECOND_OPINION,
                     WE_LIKE,
                     HOTEL_DETAILS,
                     TRAVEL_DETAILS,
                     REASON_TO_LOVE,
                     EXPIRED_COPY,
                     REVIEWS,
                     DEAL_INCLUDES,
                     PRICE_COMPARE,
                     NOTES,
                     "EXCLUSIVE",
                     FILENAME,
                     FILE_ROW_NUMBER,
                     SCHEDULE_TSTAMP,
                     SCHEDULE,
                     FLUX_PERIODS,
                     EXTRACTED_AT,
                     DATASET_NAME,
                     DATA_SOURCE,
                     LOADED_AT,
                     UPDATED_AT)
        VALUES (BATCH.SALE_ID,
                BATCH.ID,
                BATCH.VERSION,
                BATCH.ACTIVE,
                BATCH.DATE_CREATED,
                BATCH.DESTINATION_NAME,
                BATCH.END_DATE,
                BATCH.LAST_UPDATED,
                BATCH.LOCATION,
                BATCH.SLUG,
                BATCH.START_DATE,
                BATCH.TITLE,
                BATCH.TOP_DISCOUNT,
                BATCH.TYPE,
                BATCH.PROMOTION,
                BATCH.COMMISSION,
                BATCH.DISCOUNT_NOTE,
                BATCH.BOARD_TYPE,
                BATCH.DESTINATION_TYPE,
                BATCH.HALO,
                BATCH.PROMOTED,
                BATCH.TRAVEL_TYPE,
                BATCH.CONTRACTOR_ID,
                BATCH.ROOM_DESCRIPTION,
                BATCH.VAT_EXCLUSIVE,
                BATCH.REQUIRE_ADDRESS,
                BATCH.REQUIRE_AGE,
                BATCH.REQUIRE_PASSPORT,
                BATCH.REQUIRE_TITLE,
                BATCH.CUSTOM_URL_SLUG,
                BATCH.COMMISSION_TYPE,
                BATCH.DEFAULT_OFFER_ID,
                BATCH.SHOW_DISCOUNT_PREFIX,
                BATCH.ENABLE_HOLD,
                BATCH.MYSTERIOUS,
                BATCH.MYSTERIOUS_TITLE,
                BATCH.PREMIUM,
                BATCH.INSTANT,
                BATCH.INSTANT_DESTINATION,
                BATCH.INSTANT_TYPE,
                BATCH.BASE_CURRENCY,
                BATCH.DEPOSIT,
                BATCH.CLOSEST_AIRPORT_CODE,
                BATCH.REQUIRE_DATE_OF_BIRTH,
                BATCH.TOP_DISCOUNT_EUR,
                BATCH.TOP_DISCOUNT_GBP,
                BATCH.TOP_DISCOUNT_SEK,
                BATCH.MAIN_PHOTO_ID,
                BATCH.COUNTY,
                BATCH.DESTINATION_COUNTRY,
                BATCH.SHOW_PRICE,
                BATCH.REPEATED,
                BATCH.LOCATION_INFO_ID,
                BATCH.CITY_DISTRICT_ID,
                BATCH.JB_HOTEL_ID,
                BATCH.TOP_DISCOUNT_USD,
                BATCH.TOP_DISCOUNT_DKK,
                BATCH.SEND_SUMMARY,
                BATCH.TOP_DISCOUNT_NOK,
                BATCH.TOP_DISCOUNT_CHF,
                BATCH.WITH_SHARED_ALLOCATIONS,
                BATCH.SALESFORCE_OPPORTUNITY_ID,
                BATCH.SALE_ANCILLARY_DETAILS_ID,
                BATCH.SUPPLIER_ID,
                BATCH.SMART_STAY,
                BATCH.HOTEL_CHAIN_LINK,
                BATCH.EXCLUDED_FROM_API,
                BATCH.TOP_DISCOUNT_PLN,
                BATCH.TOP_DISCOUNT_SGD,
                BATCH.TOP_DISCOUNT_PHP,
                BATCH.TOP_DISCOUNT_IDR,
                BATCH.TOP_DISCOUNT_HKD,
                BATCH.TOP_DISCOUNT_MYR,
                BATCH.TRIP_ADVISOR_RATINGS_IMAGE,
                BATCH.TOP_DISCOUNT_CZK,
                BATCH.TOP_DISCOUNT_HUF,
                BATCH.IS_EAN_SECRET_PRICE_SALE,
                BATCH.IS_CEE_SALE,
                BATCH.IS_ABLE_TO_SELL_FLIGHTS,
                BATCH.JOINT_CONTRACTOR_ID,
                BATCH.IS_TEAM20PACKAGE,
                BATCH.IS_OVERNIGHT_FLIGHT,
                BATCH.ZERO_DEPOSIT,
                BATCH.SKI_INSURANCE,
                BATCH.ADDITIONAL_TEXT,
                BATCH.MAIN_PARAGRAPH,
                BATCH.MAP_LOCATION,
                BATCH.NEED_TO_KNOW,
                BATCH.SECOND_OPINION,
                BATCH.WE_LIKE,
                BATCH.HOTEL_DETAILS,
                BATCH.TRAVEL_DETAILS,
                BATCH.REASON_TO_LOVE,
                BATCH.EXPIRED_COPY,
                BATCH.REVIEWS,
                BATCH.DEAL_INCLUDES,
                BATCH.PRICE_COMPARE,
                BATCH.NOTES,
                BATCH."EXCLUSIVE",
                BATCH.FILENAME,
                BATCH.FILE_ROW_NUMBER,
                BATCH.SCHEDULE_TSTAMP,
                BATCH.SCHEDULE,
                BATCH.FLUX_PERIODS,
                BATCH.EXTRACTED_AT,
                BATCH.DATASET_NAME,
                BATCH.DATA_SOURCE,
                BATCH.LOADED_AT,
                BATCH.UPDATED_AT)
    WHEN MATCHED AND TARGET.LOADED_AT < BATCH.LOADED_AT
        THEN UPDATE SET
        TARGET.SALE_ID = BATCH.SALE_ID,
        TARGET.ID = BATCH.ID,
        TARGET.VERSION = BATCH.VERSION,
        TARGET.ACTIVE = BATCH.ACTIVE,
        TARGET.DATE_CREATED = BATCH.DATE_CREATED,
        TARGET.DESTINATION_NAME = BATCH.DESTINATION_NAME,
        TARGET.END_DATE = BATCH.END_DATE,
        TARGET.LAST_UPDATED = BATCH.LAST_UPDATED,
        TARGET.LOCATION = BATCH.LOCATION,
        TARGET.SLUG = BATCH.SLUG,
        TARGET.START_DATE = BATCH.START_DATE,
        TARGET.TITLE = BATCH.TITLE,
        TARGET.TOP_DISCOUNT = BATCH.TOP_DISCOUNT,
        TARGET.TYPE = BATCH.TYPE,
        TARGET.PROMOTION = BATCH.PROMOTION,
        TARGET.COMMISSION = BATCH.COMMISSION,
        TARGET.DISCOUNT_NOTE = BATCH.DISCOUNT_NOTE,
        TARGET.BOARD_TYPE = BATCH.BOARD_TYPE,
        TARGET.DESTINATION_TYPE = BATCH.DESTINATION_TYPE,
        TARGET.HALO = BATCH.HALO,
        TARGET.PROMOTED = BATCH.PROMOTED,
        TARGET.TRAVEL_TYPE = BATCH.TRAVEL_TYPE,
        TARGET.CONTRACTOR_ID = BATCH.CONTRACTOR_ID,
        TARGET.ROOM_DESCRIPTION = BATCH.ROOM_DESCRIPTION,
        TARGET.VAT_EXCLUSIVE = BATCH.VAT_EXCLUSIVE,
        TARGET.REQUIRE_ADDRESS = BATCH.REQUIRE_ADDRESS,
        TARGET.REQUIRE_AGE = BATCH.REQUIRE_AGE,
        TARGET.REQUIRE_PASSPORT = BATCH.REQUIRE_PASSPORT,
        TARGET.REQUIRE_TITLE = BATCH.REQUIRE_TITLE,
        TARGET.CUSTOM_URL_SLUG = BATCH.CUSTOM_URL_SLUG,
        TARGET.COMMISSION_TYPE = BATCH.COMMISSION_TYPE,
        TARGET.DEFAULT_OFFER_ID = BATCH.DEFAULT_OFFER_ID,
        TARGET.SHOW_DISCOUNT_PREFIX = BATCH.SHOW_DISCOUNT_PREFIX,
        TARGET.ENABLE_HOLD = BATCH.ENABLE_HOLD,
        TARGET.MYSTERIOUS = BATCH.MYSTERIOUS,
        TARGET.MYSTERIOUS_TITLE = BATCH.MYSTERIOUS_TITLE,
        TARGET.PREMIUM = BATCH.PREMIUM,
        TARGET.INSTANT = BATCH.INSTANT,
        TARGET.INSTANT_DESTINATION = BATCH.INSTANT_DESTINATION,
        TARGET.INSTANT_TYPE = BATCH.INSTANT_TYPE,
        TARGET.BASE_CURRENCY = BATCH.BASE_CURRENCY,
        TARGET.DEPOSIT = BATCH.DEPOSIT,
        TARGET.CLOSEST_AIRPORT_CODE = BATCH.CLOSEST_AIRPORT_CODE,
        TARGET.REQUIRE_DATE_OF_BIRTH = BATCH.REQUIRE_DATE_OF_BIRTH,
        TARGET.TOP_DISCOUNT_EUR = BATCH.TOP_DISCOUNT_EUR,
        TARGET.TOP_DISCOUNT_GBP = BATCH.TOP_DISCOUNT_GBP,
        TARGET.TOP_DISCOUNT_SEK = BATCH.TOP_DISCOUNT_SEK,
        TARGET.MAIN_PHOTO_ID = BATCH.MAIN_PHOTO_ID,
        TARGET.COUNTY = BATCH.COUNTY,
        TARGET.DESTINATION_COUNTRY = BATCH.DESTINATION_COUNTRY,
        TARGET.SHOW_PRICE = BATCH.SHOW_PRICE,
        TARGET.REPEATED = BATCH.REPEATED,
        TARGET.LOCATION_INFO_ID = BATCH.LOCATION_INFO_ID,
        TARGET.CITY_DISTRICT_ID = BATCH.CITY_DISTRICT_ID,
        TARGET.JB_HOTEL_ID = BATCH.JB_HOTEL_ID,
        TARGET.TOP_DISCOUNT_USD = BATCH.TOP_DISCOUNT_USD,
        TARGET.TOP_DISCOUNT_DKK = BATCH.TOP_DISCOUNT_DKK,
        TARGET.SEND_SUMMARY = BATCH.SEND_SUMMARY,
        TARGET.TOP_DISCOUNT_NOK = BATCH.TOP_DISCOUNT_NOK,
        TARGET.TOP_DISCOUNT_CHF = BATCH.TOP_DISCOUNT_CHF,
        TARGET.WITH_SHARED_ALLOCATIONS = BATCH.WITH_SHARED_ALLOCATIONS,
        TARGET.SALESFORCE_OPPORTUNITY_ID = BATCH.SALESFORCE_OPPORTUNITY_ID,
        TARGET.SALE_ANCILLARY_DETAILS_ID = BATCH.SALE_ANCILLARY_DETAILS_ID,
        TARGET.SUPPLIER_ID = BATCH.SUPPLIER_ID,
        TARGET.SMART_STAY = BATCH.SMART_STAY,
        TARGET.HOTEL_CHAIN_LINK = BATCH.HOTEL_CHAIN_LINK,
        TARGET.EXCLUDED_FROM_API = BATCH.EXCLUDED_FROM_API,
        TARGET.TOP_DISCOUNT_PLN = BATCH.TOP_DISCOUNT_PLN,
        TARGET.TOP_DISCOUNT_SGD = BATCH.TOP_DISCOUNT_SGD,
        TARGET.TOP_DISCOUNT_PHP = BATCH.TOP_DISCOUNT_PHP,
        TARGET.TOP_DISCOUNT_IDR = BATCH.TOP_DISCOUNT_IDR,
        TARGET.TOP_DISCOUNT_HKD = BATCH.TOP_DISCOUNT_HKD,
        TARGET.TOP_DISCOUNT_MYR = BATCH.TOP_DISCOUNT_MYR,
        TARGET.TRIP_ADVISOR_RATINGS_IMAGE = BATCH.TRIP_ADVISOR_RATINGS_IMAGE,
        TARGET.TOP_DISCOUNT_CZK = BATCH.TOP_DISCOUNT_CZK,
        TARGET.TOP_DISCOUNT_HUF = BATCH.TOP_DISCOUNT_HUF,
        TARGET.IS_EAN_SECRET_PRICE_SALE = BATCH.IS_EAN_SECRET_PRICE_SALE,
        TARGET.IS_CEE_SALE = BATCH.IS_CEE_SALE,
        TARGET.IS_ABLE_TO_SELL_FLIGHTS = BATCH.IS_ABLE_TO_SELL_FLIGHTS,
        TARGET.JOINT_CONTRACTOR_ID = BATCH.JOINT_CONTRACTOR_ID,
        TARGET.IS_TEAM20PACKAGE = BATCH.IS_TEAM20PACKAGE,
        TARGET.IS_OVERNIGHT_FLIGHT = BATCH.IS_OVERNIGHT_FLIGHT,
        TARGET.ZERO_DEPOSIT = BATCH.ZERO_DEPOSIT,
        TARGET.SKI_INSURANCE = BATCH.SKI_INSURANCE,
        TARGET.ADDITIONAL_TEXT = BATCH.ADDITIONAL_TEXT,
        TARGET.MAIN_PARAGRAPH = BATCH.MAIN_PARAGRAPH,
        TARGET.MAP_LOCATION = BATCH.MAP_LOCATION,
        TARGET.NEED_TO_KNOW = BATCH.NEED_TO_KNOW,
        TARGET.SECOND_OPINION = BATCH.SECOND_OPINION,
        TARGET.WE_LIKE = BATCH.WE_LIKE,
        TARGET.HOTEL_DETAILS = BATCH.HOTEL_DETAILS,
        TARGET.TRAVEL_DETAILS = BATCH.TRAVEL_DETAILS,
        TARGET.REASON_TO_LOVE = BATCH.REASON_TO_LOVE,
        TARGET.EXPIRED_COPY = BATCH.EXPIRED_COPY,
        TARGET.REVIEWS = BATCH.REVIEWS,
        TARGET.DEAL_INCLUDES = BATCH.DEAL_INCLUDES,
        TARGET.PRICE_COMPARE = BATCH.PRICE_COMPARE,
        TARGET.NOTES = BATCH.NOTES,
        TARGET."EXCLUSIVE" = BATCH."EXCLUSIVE",
        TARGET.FILENAME = BATCH.FILENAME,
        TARGET.FILE_ROW_NUMBER = BATCH.FILE_ROW_NUMBER,
        TARGET.SCHEDULE_TSTAMP = BATCH.SCHEDULE_TSTAMP,
        TARGET.SCHEDULE = BATCH.SCHEDULE,
        TARGET.FLUX_PERIODS = BATCH.FLUX_PERIODS,
        TARGET.EXTRACTED_AT = BATCH.EXTRACTED_AT,
        TARGET.DATASET_NAME = BATCH.DATASET_NAME,
        TARGET.DATA_SOURCE = BATCH.DATA_SOURCE,
        TARGET.LOADED_AT = BATCH.LOADED_AT,
        TARGET.UPDATED_AT = BATCH.UPDATED_AT;

------------------------------------------------------------------------------------------------------------------------
--assertions
SELECT CASE WHEN COUNT(*) > 0 THEN FALSE ELSE TRUE END AS UNIQUE_SALE_ID
FROM (
         SELECT SALE_ID
         FROM MODULE_CURRENT_SALE
         GROUP BY 1
         HAVING COUNT(*) > 1);