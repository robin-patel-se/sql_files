--example output tables for FP&A to review at the end of Q4 2019.

USE WAREHOUSE PIPE_XLARGE;
USE SCHEMA SCRATCH.ROBINPATELDEV35777;

DROP VIEW SCRATCH.ROBINPATELDEV35777.SPVS_BY_CUTTABLE_DIMENSIONS_W_USERID;

CREATE OR REPLACE TABLE SCRATCH.ROBINPATELDEV35777.SPVS_BY_CUTTABLE_DIMENSIONS_W_USERID AS (
    SELECT b.ATTRIBUTED_USER_ID,
           b.STITCHED_IDENTITY_TYPE,
           b.TOUCH_START_TSTAMP::DATE                   AS TOUCH_START_DATE,
           b.TOUCH_POSA_TERRITORY,
           b.TOUCH_EXPERIENCE,
           b.TOUCH_HOSTNAME,
           c.TOUCH_MKT_CHANNEL                          AS LAST_NON_DIRECT_MKT_CHANNEL,
           sa.PRODUCT_TYPE,
           sa.PRODUCT_CONFIGURATION,
           sa.PRODUCT_LINE,
           COUNT(distinct spv.TOUCH_ID)                 AS TOUCHES,
           COUNT(spv.EVENT_HASH)                        AS SPVs,
           COUNT(distinct spv.SE_SALE_ID, spv.TOUCH_ID) AS UNIQUE_SPVS
    FROM MODULE_TOUCH_BASIC_ATTRIBUTES b
             INNER JOIN MODULE_TOUCH_ATTRIBUTION a
                        ON b.TOUCH_ID = a.TOUCH_ID AND a.ATTRIBUTION_MODEL = 'last non direct'
             INNER JOIN MODULE_TOUCH_MARKETING_CHANNEL c ON a.ATTRIBUTED_TOUCH_ID = c.TOUCH_ID
             INNER JOIN MODULE_EVENTS_OF_INTEREST spv ON b.TOUCH_ID = spv.TOUCH_ID AND spv.EVENT_SUBCATEGORY = 'SPV'
             INNER JOIN MODULE_CURRENT_SALE_ATTRIBUTES sa ON spv.SE_SALE_ID = sa.SALE_ID
    GROUP BY 1, 2, 3, 4, 5, 6, 7, 8, 9, 10
    ORDER BY 3
);

SELECT *
FROM SCRATCH.ROBINPATELDEV35777.SPVS_BY_CUTTABLE_DIMENSIONS_W_USERID;


CREATE OR REPLACE TABLE SCRATCH.ROBINPATELDEV35777.SPVS_BY_CUTTABLE_DIMENSIONS AS (
    SELECT b.TOUCH_START_TSTAMP::DATE                   AS TOUCH_START_DATE,
           b.TOUCH_POSA_TERRITORY,
           b.TOUCH_EXPERIENCE,
           b.TOUCH_HOSTNAME,
           c.TOUCH_MKT_CHANNEL                          AS LAST_NON_DIRECT_MKT_CHANNEL,
           sa.PRODUCT_TYPE,
           sa.PRODUCT_CONFIGURATION,
           sa.PRODUCT_LINE,
           COUNT(distinct b.ATTRIBUTED_USER_ID)         AS USERS,
           COUNT(distinct spv.TOUCH_ID)                 AS TOUCHES,
           COUNT(spv.EVENT_HASH)                        AS SPVs,
           COUNT(distinct spv.SE_SALE_ID, spv.TOUCH_ID) AS UNIQUE_SPVS
    FROM MODULE_TOUCH_BASIC_ATTRIBUTES b
             INNER JOIN MODULE_TOUCH_ATTRIBUTION a
                        ON b.TOUCH_ID = a.TOUCH_ID AND a.ATTRIBUTION_MODEL = 'last non direct'
             INNER JOIN MODULE_TOUCH_MARKETING_CHANNEL c ON a.ATTRIBUTED_TOUCH_ID = c.TOUCH_ID
             INNER JOIN MODULE_EVENTS_OF_INTEREST spv ON b.TOUCH_ID = spv.TOUCH_ID AND spv.EVENT_SUBCATEGORY = 'SPV'
             INNER JOIN MODULE_CURRENT_SALE_ATTRIBUTES sa ON spv.SE_SALE_ID = sa.SALE_ID
    GROUP BY 1, 2, 3, 4, 5, 6, 7, 8
    ORDER BY 1
);

