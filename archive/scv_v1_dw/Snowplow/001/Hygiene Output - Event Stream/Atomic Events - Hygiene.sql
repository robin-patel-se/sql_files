USE WAREHOUSE PIPE_XLARGE;
USE SCHEMA SCRATCH.ROBINPATEL;

------------------------------------------------------------------------------------------------------------------------
--first run

CREATE TABLE IF NOT EXISTS EVENT_STREAM
(
    EVENT_HASH                                                              VARCHAR,
    IDENTITY_FRAGMENT                                                       VARCHAR,
    SE_USER_ID                                                              NUMBER,
    IS_ROBOT_SPIDER_EVENT                                                   BOOLEAN,
    EVENT_TSTAMP                                                            TIMESTAMPNTZ,
    POSA_TERRITORY                                                          VARCHAR,
    DEVICE_PLATFORM                                                         VARCHAR,
    DEVICE_CATEGORY                                                         VARCHAR,
    IS_INTERNAL_IP_ADDRESS_EVENT                                            BOOLEAN,
    IS_SERVER_SIDE_EVENT                                                    BOOLEAN,
    LOGIN_TYPE                                                              VARCHAR,
    SE_SALE_ID                                                              VARCHAR,
    SALE_TYPE                                                               VARCHAR,
    SALE_TRAVEL_TYPE_INFO                                                   VARCHAR,
    AFFILIATE_ID                                                            VARCHAR,
    AFFILIATE_NAME                                                          VARCHAR,
    ORIGINAL_AFFILIATE_ID                                                   VARCHAR,
    ORIGINAL_AFFILIATE_NAME                                                 VARCHAR,

    APP_ID                                                                  VARCHAR,
    PLATFORM                                                                VARCHAR,
    ETL_TSTAMP                                                              TIMESTAMPNTZ,
    COLLECTOR_TSTAMP                                                        TIMESTAMPNTZ,
    DVCE_CREATED_TSTAMP                                                     TIMESTAMPNTZ,
    EVENT                                                                   VARCHAR,
    EVENT_ID                                                                VARCHAR,
    TXN_ID                                                                  NUMBER,
    NAME_TRACKER                                                            VARCHAR,
    V_TRACKER                                                               VARCHAR,
    V_COLLECTOR                                                             VARCHAR,
    V_ETL                                                                   VARCHAR,
    USER_ID                                                                 VARCHAR,
    USER_IPADDRESS                                                          VARCHAR,
    USER_FINGERPRINT                                                        VARCHAR,
    DOMAIN_USERID                                                           VARCHAR,
    DOMAIN_SESSIONIDX                                                       NUMBER,
    NETWORK_USERID                                                          VARCHAR,
    GEO_COUNTRY                                                             VARCHAR,
    GEO_REGION                                                              VARCHAR,
    GEO_CITY                                                                VARCHAR,
    GEO_ZIPCODE                                                             VARCHAR,
    GEO_LATITUDE                                                            DOUBLE,
    GEO_LONGITUDE                                                           DOUBLE,
    GEO_REGION_NAME                                                         VARCHAR,
    IP_ISP                                                                  VARCHAR,
    IP_ORGANIZATION                                                         VARCHAR,
    IP_DOMAIN                                                               VARCHAR,
    IP_NETSPEED                                                             VARCHAR,
    PAGE_URL                                                                VARCHAR,
    PAGE_TITLE                                                              VARCHAR,
    PAGE_REFERRER                                                           VARCHAR,
    PAGE_URLSCHEME                                                          VARCHAR,
    PAGE_URLHOST                                                            VARCHAR,
    PAGE_URLPORT                                                            NUMBER,
    PAGE_URLPATH                                                            VARCHAR,
    PAGE_URLQUERY                                                           VARCHAR,
    PAGE_URLFRAGMENT                                                        VARCHAR,
    REFR_URLSCHEME                                                          VARCHAR,
    REFR_URLHOST                                                            VARCHAR,
    REFR_URLPORT                                                            NUMBER,
    REFR_URLPATH                                                            VARCHAR,
    REFR_URLQUERY                                                           VARCHAR,
    REFR_URLFRAGMENT                                                        VARCHAR,
    REFR_MEDIUM                                                             VARCHAR,
    REFR_SOURCE                                                             VARCHAR,
    REFR_TERM                                                               VARCHAR,
    MKT_MEDIUM                                                              VARCHAR,
    MKT_SOURCE                                                              VARCHAR,
    MKT_TERM                                                                VARCHAR,
    MKT_CONTENT                                                             VARCHAR,
    MKT_CAMPAIGN                                                            VARCHAR,
    SE_CATEGORY                                                             VARCHAR,
    SE_ACTION                                                               VARCHAR,
    SE_LABEL                                                                VARCHAR,
    SE_PROPERTY                                                             VARCHAR,
    SE_VALUE                                                                DOUBLE,
    TR_ORDERID                                                              VARCHAR,
    TR_AFFILIATION                                                          VARCHAR,
    TR_TOTAL                                                                NUMBER,
    TR_TAX                                                                  NUMBER,
    TR_SHIPPING                                                             NUMBER,
    TR_CITY                                                                 VARCHAR,
    TR_STATE                                                                VARCHAR,
    TR_COUNTRY                                                              VARCHAR,
    TI_ORDERID                                                              VARCHAR,
    TI_SKU                                                                  VARCHAR,
    TI_NAME                                                                 VARCHAR,
    TI_CATEGORY                                                             VARCHAR,
    TI_PRICE                                                                NUMBER,
    TI_QUANTITY                                                             NUMBER,
    PP_XOFFSET_MIN                                                          NUMBER,
    PP_XOFFSET_MAX                                                          NUMBER,
    PP_YOFFSET_MIN                                                          NUMBER,
    PP_YOFFSET_MAX                                                          NUMBER,
    USERAGENT                                                               VARCHAR,
    BR_NAME                                                                 VARCHAR,
    BR_FAMILY                                                               VARCHAR,
    BR_VERSION                                                              VARCHAR,
    BR_TYPE                                                                 VARCHAR,
    BR_RENDERENGINE                                                         VARCHAR,
    BR_LANG                                                                 VARCHAR,
    BR_FEATURES_PDF                                                         BOOLEAN,
    BR_FEATURES_FLASH                                                       BOOLEAN,
    BR_FEATURES_JAVA                                                        BOOLEAN,
    BR_FEATURES_DIRECTOR                                                    BOOLEAN,
    BR_FEATURES_QUICKTIME                                                   BOOLEAN,
    BR_FEATURES_REALPLAYER                                                  BOOLEAN,
    BR_FEATURES_WINDOWSMEDIA                                                BOOLEAN,
    BR_FEATURES_GEARS                                                       BOOLEAN,
    BR_FEATURES_SILVERLIGHT                                                 BOOLEAN,
    BR_COOKIES                                                              BOOLEAN,
    BR_COLORDEPTH                                                           VARCHAR,
    BR_VIEWWIDTH                                                            NUMBER,
    BR_VIEWHEIGHT                                                           NUMBER,
    OS_NAME                                                                 VARCHAR,
    OS_FAMILY                                                               VARCHAR,
    OS_MANUFACTURER                                                         VARCHAR,
    OS_TIMEZONE                                                             VARCHAR,
    DVCE_TYPE                                                               VARCHAR,
    DVCE_ISMOBILE                                                           BOOLEAN,
    DVCE_SCREENWIDTH                                                        NUMBER,
    DVCE_SCREENHEIGHT                                                       NUMBER,
    DOC_CHARSET                                                             VARCHAR,
    DOC_WIDTH                                                               NUMBER,
    DOC_HEIGHT                                                              NUMBER,
    TR_CURRENCY                                                             VARCHAR,
    TR_TOTAL_BASE                                                           NUMBER,
    TR_TAX_BASE                                                             NUMBER,
    TR_SHIPPING_BASE                                                        NUMBER,
    TI_CURRENCY                                                             VARCHAR,
    TI_PRICE_BASE                                                           NUMBER,
    BASE_CURRENCY                                                           VARCHAR,
    GEO_TIMEZONE                                                            VARCHAR,
    MKT_CLICKID                                                             VARCHAR,
    MKT_NETWORK                                                             VARCHAR,
    ETL_TAGS                                                                VARCHAR,
    DVCE_SENT_TSTAMP                                                        TIMESTAMPNTZ,
    REFR_DOMAIN_USERID                                                      VARCHAR,
    REFR_DVCE_TSTAMP                                                        TIMESTAMPNTZ,
    DOMAIN_SESSIONID                                                        VARCHAR,
    DERIVED_TSTAMP                                                          TIMESTAMPNTZ,
    EVENT_VENDOR                                                            VARCHAR,
    EVENT_NAME                                                              VARCHAR,
    EVENT_FORMAT                                                            VARCHAR,
    EVENT_VERSION                                                           VARCHAR,
    EVENT_FINGERPRINT                                                       VARCHAR,
    TRUE_TSTAMP                                                             TIMESTAMPNTZ,
    CONTEXTS_COM_OPTIMIZELY_SNOWPLOW_OPTIMIZELY_SUMMARY_1                   ARRAY,
    CONTEXTS_COM_SECRETESCAPES_ALL_PAGES_SESSION_LOGIN_TYPE_CONTEXT_1       ARRAY,
    CONTEXTS_COM_SECRETESCAPES_SALE_PAGE_CONTEXT_1                          ARRAY,
    CONTEXTS_COM_SECRETESCAPES_USER_STATE_CONTEXT_1                         ARRAY,
    CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_UA_PARSER_CONTEXT_1             ARRAY,
    CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_WEB_PAGE_1                      ARRAY,
    CONTEXTS_ORG_W3_PERFORMANCE_TIMING_1                                    ARRAY,
    UNSTRUCT_EVENT_COM_SNOWPLOWANALYTICS_SNOWPLOW_LINK_CLICK_1              OBJECT,
    CONTEXTS_COM_OPTIMIZELY_OPTIMIZELYX_SUMMARY_1                           ARRAY,
    CONTEXTS_COM_SECRETESCAPES_COLLECTION_CONTEXT_1                         ARRAY,
    CONTEXTS_COM_SECRETESCAPES_FILTER_CONTEXT_1                             ARRAY,
    CONTEXTS_COM_SECRETESCAPES_SCREEN_CONTEXT_1                             ARRAY,
    CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_APPLICATION_BACKGROUND_1        ARRAY,
    CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_APPLICATION_FOREGROUND_1        ARRAY,
    CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_CLIENT_SESSION_1                ARRAY,
    CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_MOBILE_CONTEXT_1                ARRAY,
    UNSTRUCT_EVENT_COM_SNOWPLOWANALYTICS_SNOWPLOW_SCREEN_VIEW_1             OBJECT,
    UNSTRUCT_EVENT_COM_SECRETESCAPES_SEARCHED_WITH_REFINEMENT_EVENT_1       OBJECT,
    CONTEXTS_COM_OPTIMIZELY_EXPERIMENT_1                                    ARRAY,
    CONTEXTS_COM_OPTIMIZELY_STATE_1                                         ARRAY,
    CONTEXTS_COM_OPTIMIZELY_VARIATION_1                                     ARRAY,
    CONTEXTS_COM_OPTIMIZELY_VISITOR_1                                       ARRAY,
    CONTEXTS_COM_OPTIMIZELY_VISITOR_AUDIENCE_1                              ARRAY,
    CONTEXTS_COM_OPTIMIZELY_VISITOR_DIMENSION_1                             ARRAY,
    UNSTRUCT_EVENT_COM_SNOWPLOWANALYTICS_MOBILE_SCREEN_VIEW_1               OBJECT,
    CONTEXTS_COM_SECRETESCAPES_BOOKING_CONTEXT_1                            ARRAY,
    CONTEXTS_COM_SECRETESCAPES_CONTENT_CONTEXT_1                            ARRAY,
    CONTEXTS_COM_SECRETESCAPES_ENVIRONMENT_CONTEXT_1                        ARRAY,
    CONTEXTS_COM_SECRETESCAPES_SECRET_ESCAPES_SALE_CONTEXT_1                ARRAY,
    CONTEXTS_COM_SECRETESCAPES_USER_CONTEXT_1                               ARRAY,
    CONTEXTS_COM_SECRETESCAPES_WHO_PUTS_PRODUCT_IN_FRONT_CUSTOMER_CONTEXT_1 ARRAY,
    UNSTRUCT_EVENT_COM_SECRETESCAPES_BOOKING_UPDATE_EVENT_1                 OBJECT,
    UPDATED_AT                                                              TIMESTAMPLTZ,
    CONSTRAINT PK_EVENT_HASH primary key (EVENT_HASH)
)
    CLUSTER BY (EVENT_NAME, EVENT_TSTAMP::DATE);

------------------------------------------------------------------------------------------------------------------------
--incremental

MERGE INTO EVENT_STREAM AS TARGET
    USING (
        SELECT
--event hash
SHA2(
            COALESCE(EVENT_ID, '') ||
            COALESCE(EVENT_FINGERPRINT, '') ||
            COALESCE(COLLECTOR_TSTAMP, '1970-01-01 00:00:00') || --coalesce to a tstamp incase of null to avoid errors
            COALESCE(DERIVED_TSTAMP, '1970-01-01 00:00:00') ||
            COALESCE(USER_IPADDRESS, '') ||
            COALESCE(DVCE_SENT_TSTAMP, '1970-01-01 00:00:00')
    )                                                                                               AS event_hash,
--identity fragment
COALESCE(
        DOMAIN_USERID,
        CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_CLIENT_SESSION_1[0]['userId']::varchar,
        CONTEXTS_COM_SECRETESCAPES_USER_CONTEXT_1[0]['email_address']::varchar,
        TI_ORDERID)
                                                                                                    AS identity_fragment,

--user id

TRY_TO_NUMBER(USER_ID)                                                                              AS se_user_id,


--robot spider
CASE
    WHEN BR_FAMILY = 'Robot/Spider'
        OR
         USERAGENT REGEXP
         '.*(bot|crawl|slurp|spider|archiv|spinn|sniff|seo|audit|survey|pingdom|worm|capture|(browser|screen)shots|analyz|index|thumb|check|facebook|PingdomBot|PhantomJS|YandexBot|Twitterbot|a_archiver|facebookexternalhit|Bingbot|BingPreview|Googlebot|Baiduspider|360(Spider|User-agent)|semalt).*'
        THEN TRUE
    ELSE FALSE END                                                                                  AS is_robot_spider_event,

--single tstamp
CASE
    WHEN DERIVED_TSTAMP > COLLECTOR_TSTAMP THEN COLLECTOR_TSTAMP
    --to correct for when the derived time is set in the future
    WHEN APP_ID LIKE 'ios_app%' AND DVCE_SENT_TSTAMP <= COLLECTOR_TSTAMP THEN DVCE_SENT_TSTAMP
    -- to correct for incorrect dvce_created_tstamp on all native app events
    WHEN DATEDIFF(day, DERIVED_TSTAMP, COLLECTOR_TSTAMP) > 1 AND DVCE_SENT_TSTAMP <= COLLECTOR_TSTAMP
        THEN DVCE_SENT_TSTAMP
    --to correct occurrences of the derived tstamp being so out due to the dvce created and dvce sent tstamp being so disparate
    WHEN DATEDIFF(day, DERIVED_TSTAMP, COLLECTOR_TSTAMP) > 1 AND DVCE_SENT_TSTAMP > dateadd(hour, 1, COLLECTOR_TSTAMP)
        THEN COLLECTOR_TSTAMP
    --to correct occurrences of the derived tstamp being so out due to the dvce created and dvce sent tstamp being so disparate AND dvce tstamps being in the future
    ELSE DERIVED_TSTAMP
    END                                                                                             as event_tstamp,

--territory
regexp_replace(APP_ID, 'ios_app ')                                                                  as posa_territory,

--device platform
CASE
    WHEN APP_ID LIKE 'ios_app%'-- native events
        OR
         USERAGENT like '%mobile_native_v3%' -- webkit wrapped forwarded via native app
        THEN 'native app'
    WHEN USERAGENT like '%mobile_wrap:{platform:ios%' THEN 'mobile wrap ios'
    WHEN USERAGENT like '%mobile_wrap: {"platform":"android"%' THEN 'mobile wrap android'
    WHEN DVCE_TYPE = 'Computer' THEN 'web'
    WHEN DVCE_TYPE = 'Mobile' THEN 'mobile web'
    WHEN DVCE_TYPE = 'Tablet' THEN 'tablet web'
    WHEN DVCE_TYPE != 'Unknown' THEN lower(DVCE_TYPE)
    ELSE 'not specified'
    END                                                                                             AS device_platform,

--device type
CASE
    WHEN APP_ID LIKE 'ios_app%' OR USERAGENT like '%mobile_native_v3%' THEN 'Mobile'
    WHEN DVCE_TYPE != 'Unknown' THEN DVCE_TYPE
    ELSE 'Unknown'
    END                                                                                             AS device_category,

-- SE ip addresses

CASE
    WHEN USER_IPADDRESS IN (
        '89.197.56.3'
        )
        THEN TRUE
    ELSE FALSE END                                                                                  AS is_internal_ip_address_event,
-- Server side event

CASE
--     WHEN CONTEXTS_COM_SECRETESCAPES_ENVIRONMENT_CONTEXT_1[0]['tracking_platform']::VARCHAR = 'server-side' THEN TRUE
    WHEN V_TRACKER LIKE 'py-%' OR V_TRACKER LIKE 'java-%' THEN TRUE
    ELSE FALSE END                                                                                  AS is_server_side_event,

--enrichment

CONTEXTS_COM_SECRETESCAPES_ALL_PAGES_SESSION_LOGIN_TYPE_CONTEXT_1[0]['session_login_type']::VARCHAR AS LOGIN_TYPE,            --SEMI_MANUAL_LOGIN, EMAIL_SEMI_LOGIN, REMEMBERED, LOGGED_OUT, REGISTERED, FB_LOGIN, UNKNOWN, MANUAL_LOGIN, GOOGLE_REGISTER, FB_REGISTER, GOOGLE_LOGIN, EMAIL
NULLIF(
        COALESCE(CONTEXTS_COM_SECRETESCAPES_SALE_PAGE_CONTEXT_1[0]['sale_id']::VARCHAR, -- prior to SS tracking
                 CONTEXTS_COM_SECRETESCAPES_SECRET_ESCAPES_SALE_CONTEXT_1[0]['id']::VARCHAR -- SS tracking
            ), '0') --null for when sale id is set to 0.
                                                                                                    AS SE_SALE_ID,
CONTEXTS_COM_SECRETESCAPES_SALE_PAGE_CONTEXT_1[0]['sale_type']::VARCHAR                             AS SALE_TYPE,             -- HOTEL, PACKAGE, FLASH, DAY, TRAVEL, HOTEL_PLUS, UNKNOWN
CONTEXTS_COM_SECRETESCAPES_SALE_PAGE_CONTEXT_1[0]['travel_type_info']::VARCHAR                      AS SALE_TRAVEL_TYPE_INFO, -- HOTEL, HOTEL_PLUS, STATIC_PACKAGE, IHP_CONNECTED, DYNAMIC_PACKAGE, UNSUPPORTED, VOUCHER, UNKNOWN
CONTEXTS_COM_SECRETESCAPES_USER_STATE_CONTEXT_1[0]['affiliate_id']::VARCHAR                         AS AFFILIATE_ID,
CONTEXTS_COM_SECRETESCAPES_USER_STATE_CONTEXT_1[0]['affiliate_name']::VARCHAR                       AS AFFILIATE_NAME,        -- Secret Escapes DE, ES magazine, Secret Escapes IT, Google CPL Germany - Brand, Secret Escapes SE, Secret Escapes FR, Google PPC Brand Sign-ups, Secret Escapes NL, Secret Escapes DE for mobile wrap, Brand PPC Members (CPA), Google CPL Germany - Non-Brand, Google CPL Italy - Brand
CONTEXTS_COM_SECRETESCAPES_USER_STATE_CONTEXT_1[0]['original_affiliate_id']::VARCHAR                AS ORIGINAL_AFFILIATE_ID,
CONTEXTS_COM_SECRETESCAPES_USER_STATE_CONTEXT_1[0]['original_affiliate_name']::VARCHAR              AS ORIGINAL_AFFILIATE_NAME,

--original columns
APP_ID,
PLATFORM,
ETL_TSTAMP,
COLLECTOR_TSTAMP,
DVCE_CREATED_TSTAMP,
EVENT,
EVENT_ID,
TXN_ID,
NAME_TRACKER,
V_TRACKER,
V_COLLECTOR,
V_ETL,
USER_ID,
USER_IPADDRESS,
USER_FINGERPRINT,
DOMAIN_USERID,
DOMAIN_SESSIONIDX,
NETWORK_USERID,
GEO_COUNTRY,
GEO_REGION,
GEO_CITY,
GEO_ZIPCODE,
GEO_LATITUDE,
GEO_LONGITUDE,
GEO_REGION_NAME,
IP_ISP,
IP_ORGANIZATION,
IP_DOMAIN,
IP_NETSPEED,
PAGE_URL,
PAGE_TITLE,
PAGE_REFERRER,
PAGE_URLSCHEME,
PAGE_URLHOST,
PAGE_URLPORT,
PAGE_URLPATH,
PAGE_URLQUERY,
PAGE_URLFRAGMENT,
REFR_URLSCHEME,
REFR_URLHOST,
REFR_URLPORT,
REFR_URLPATH,
REFR_URLQUERY,
REFR_URLFRAGMENT,
REFR_MEDIUM,
REFR_SOURCE,
REFR_TERM,
MKT_MEDIUM,
MKT_SOURCE,
MKT_TERM,
MKT_CONTENT,
MKT_CAMPAIGN,
SE_CATEGORY,
SE_ACTION,
SE_LABEL,
SE_PROPERTY,
SE_VALUE,
TR_ORDERID,
TR_AFFILIATION,
TR_TOTAL,
TR_TAX,
TR_SHIPPING,
TR_CITY,
TR_STATE,
TR_COUNTRY,
TI_ORDERID,
TI_SKU,
TI_NAME,
TI_CATEGORY,
TI_PRICE,
TI_QUANTITY,
PP_XOFFSET_MIN,
PP_XOFFSET_MAX,
PP_YOFFSET_MIN,
PP_YOFFSET_MAX,
USERAGENT,
BR_NAME,
BR_FAMILY,
BR_VERSION,
BR_TYPE,
BR_RENDERENGINE,
BR_LANG,
BR_FEATURES_PDF,
BR_FEATURES_FLASH,
BR_FEATURES_JAVA,
BR_FEATURES_DIRECTOR,
BR_FEATURES_QUICKTIME,
BR_FEATURES_REALPLAYER,
BR_FEATURES_WINDOWSMEDIA,
BR_FEATURES_GEARS,
BR_FEATURES_SILVERLIGHT,
BR_COOKIES,
BR_COLORDEPTH,
BR_VIEWWIDTH,
BR_VIEWHEIGHT,
OS_NAME,
OS_FAMILY,
OS_MANUFACTURER,
OS_TIMEZONE,
DVCE_TYPE,
DVCE_ISMOBILE,
DVCE_SCREENWIDTH,
DVCE_SCREENHEIGHT,
DOC_CHARSET,
DOC_WIDTH,
DOC_HEIGHT,
TR_CURRENCY,
TR_TOTAL_BASE,
TR_TAX_BASE,
TR_SHIPPING_BASE,
TI_CURRENCY,
TI_PRICE_BASE,
BASE_CURRENCY,
GEO_TIMEZONE,
MKT_CLICKID,
MKT_NETWORK,
ETL_TAGS,
DVCE_SENT_TSTAMP,
REFR_DOMAIN_USERID,
REFR_DVCE_TSTAMP,
DOMAIN_SESSIONID,
DERIVED_TSTAMP,
EVENT_VENDOR,
EVENT_NAME,
EVENT_FORMAT,
EVENT_VERSION,
EVENT_FINGERPRINT,
TRUE_TSTAMP,
CONTEXTS_COM_OPTIMIZELY_SNOWPLOW_OPTIMIZELY_SUMMARY_1,
CONTEXTS_COM_SECRETESCAPES_ALL_PAGES_SESSION_LOGIN_TYPE_CONTEXT_1,
CONTEXTS_COM_SECRETESCAPES_SALE_PAGE_CONTEXT_1,
CONTEXTS_COM_SECRETESCAPES_USER_STATE_CONTEXT_1,
CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_UA_PARSER_CONTEXT_1,
CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_WEB_PAGE_1,
CONTEXTS_ORG_W3_PERFORMANCE_TIMING_1,
UNSTRUCT_EVENT_COM_SNOWPLOWANALYTICS_SNOWPLOW_LINK_CLICK_1,
CONTEXTS_COM_OPTIMIZELY_OPTIMIZELYX_SUMMARY_1,
CONTEXTS_COM_SECRETESCAPES_COLLECTION_CONTEXT_1,
CONTEXTS_COM_SECRETESCAPES_FILTER_CONTEXT_1,
CONTEXTS_COM_SECRETESCAPES_SCREEN_CONTEXT_1,
CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_APPLICATION_BACKGROUND_1,
CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_APPLICATION_FOREGROUND_1,
CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_CLIENT_SESSION_1,
CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_MOBILE_CONTEXT_1,
UNSTRUCT_EVENT_COM_SNOWPLOWANALYTICS_SNOWPLOW_SCREEN_VIEW_1,
UNSTRUCT_EVENT_COM_SECRETESCAPES_SEARCHED_WITH_REFINEMENT_EVENT_1,
CONTEXTS_COM_OPTIMIZELY_EXPERIMENT_1,
CONTEXTS_COM_OPTIMIZELY_STATE_1,
CONTEXTS_COM_OPTIMIZELY_VARIATION_1,
CONTEXTS_COM_OPTIMIZELY_VISITOR_1,
CONTEXTS_COM_OPTIMIZELY_VISITOR_AUDIENCE_1,
CONTEXTS_COM_OPTIMIZELY_VISITOR_DIMENSION_1,
UNSTRUCT_EVENT_COM_SNOWPLOWANALYTICS_MOBILE_SCREEN_VIEW_1,
CONTEXTS_COM_SECRETESCAPES_BOOKING_CONTEXT_1,
CONTEXTS_COM_SECRETESCAPES_CONTENT_CONTEXT_1,
CONTEXTS_COM_SECRETESCAPES_ENVIRONMENT_CONTEXT_1,
CONTEXTS_COM_SECRETESCAPES_SECRET_ESCAPES_SALE_CONTEXT_1,
CONTEXTS_COM_SECRETESCAPES_USER_CONTEXT_1,
CONTEXTS_COM_SECRETESCAPES_WHO_PUTS_PRODUCT_IN_FRONT_CUSTOMER_CONTEXT_1,
UNSTRUCT_EVENT_COM_SECRETESCAPES_BOOKING_UPDATE_EVENT_1,

CURRENT_TIMESTAMP                                                                                   AS updated_at             --TODO: replace with '{schedule_tstamp}'
        FROM SNOWPLOW_SAMPLE_EVENTS e

--         WHERE e.ETL_TSTAMP > (SELECT MAX(ETL_TSTAMP) FROM EVENT_STREAM) -- TODO: Remove, just for testing
        WHERE e.ETL_TSTAMP::DATE IN ('2019-12-11') --TODO: Remove, just for incremental testing
--         WHERE e.ETL_TSTAMP >= TIMESTAMPADD('hour', -1, '{schedule_tstamp}'::TIMESTAMP) -- TODO: for batch incremental load

    ) AS BATCH ON TARGET.EVENT_HASH = BATCH.EVENT_HASH
    WHEN NOT MATCHED
        THEN INSERT (
                     EVENT_HASH,
                     identity_fragment,
                     SE_USER_ID,
                     IS_ROBOT_SPIDER_EVENT,
                     EVENT_TSTAMP,
                     POSA_TERRITORY,
                     DEVICE_PLATFORM,
                     DEVICE_CATEGORY,
                     IS_INTERNAL_IP_ADDRESS_EVENT,
                     IS_SERVER_SIDE_EVENT,
                     LOGIN_TYPE,
                     SE_SALE_ID,
                     SALE_TYPE,
                     SALE_TRAVEL_TYPE_INFO,
                     AFFILIATE_ID,
                     AFFILIATE_NAME,
                     ORIGINAL_AFFILIATE_ID,
                     ORIGINAL_AFFILIATE_NAME,
                     APP_ID,
                     PLATFORM,
                     ETL_TSTAMP,
                     COLLECTOR_TSTAMP,
                     DVCE_CREATED_TSTAMP,
                     EVENT,
                     EVENT_ID,
                     TXN_ID,
                     NAME_TRACKER,
                     V_TRACKER,
                     V_COLLECTOR,
                     V_ETL,
                     USER_ID,
                     USER_IPADDRESS,
                     USER_FINGERPRINT,
                     DOMAIN_USERID,
                     DOMAIN_SESSIONIDX,
                     NETWORK_USERID,
                     GEO_COUNTRY,
                     GEO_REGION,
                     GEO_CITY,
                     GEO_ZIPCODE,
                     GEO_LATITUDE,
                     GEO_LONGITUDE,
                     GEO_REGION_NAME,
                     IP_ISP,
                     IP_ORGANIZATION,
                     IP_DOMAIN,
                     IP_NETSPEED,
                     PAGE_URL,
                     PAGE_TITLE,
                     PAGE_REFERRER,
                     PAGE_URLSCHEME,
                     PAGE_URLHOST,
                     PAGE_URLPORT,
                     PAGE_URLPATH,
                     PAGE_URLQUERY,
                     PAGE_URLFRAGMENT,
                     REFR_URLSCHEME,
                     REFR_URLHOST,
                     REFR_URLPORT,
                     REFR_URLPATH,
                     REFR_URLQUERY,
                     REFR_URLFRAGMENT,
                     REFR_MEDIUM,
                     REFR_SOURCE,
                     REFR_TERM,
                     MKT_MEDIUM,
                     MKT_SOURCE,
                     MKT_TERM,
                     MKT_CONTENT,
                     MKT_CAMPAIGN,
                     SE_CATEGORY,
                     SE_ACTION,
                     SE_LABEL,
                     SE_PROPERTY,
                     SE_VALUE,
                     TR_ORDERID,
                     TR_AFFILIATION,
                     TR_TOTAL,
                     TR_TAX,
                     TR_SHIPPING,
                     TR_CITY,
                     TR_STATE,
                     TR_COUNTRY,
                     TI_ORDERID,
                     TI_SKU,
                     TI_NAME,
                     TI_CATEGORY,
                     TI_PRICE,
                     TI_QUANTITY,
                     PP_XOFFSET_MIN,
                     PP_XOFFSET_MAX,
                     PP_YOFFSET_MIN,
                     PP_YOFFSET_MAX,
                     USERAGENT,
                     BR_NAME,
                     BR_FAMILY,
                     BR_VERSION,
                     BR_TYPE,
                     BR_RENDERENGINE,
                     BR_LANG,
                     BR_FEATURES_PDF,
                     BR_FEATURES_FLASH,
                     BR_FEATURES_JAVA,
                     BR_FEATURES_DIRECTOR,
                     BR_FEATURES_QUICKTIME,
                     BR_FEATURES_REALPLAYER,
                     BR_FEATURES_WINDOWSMEDIA,
                     BR_FEATURES_GEARS,
                     BR_FEATURES_SILVERLIGHT,
                     BR_COOKIES,
                     BR_COLORDEPTH,
                     BR_VIEWWIDTH,
                     BR_VIEWHEIGHT,
                     OS_NAME,
                     OS_FAMILY,
                     OS_MANUFACTURER,
                     OS_TIMEZONE,
                     DVCE_TYPE,
                     DVCE_ISMOBILE,
                     DVCE_SCREENWIDTH,
                     DVCE_SCREENHEIGHT,
                     DOC_CHARSET,
                     DOC_WIDTH,
                     DOC_HEIGHT,
                     TR_CURRENCY,
                     TR_TOTAL_BASE,
                     TR_TAX_BASE,
                     TR_SHIPPING_BASE,
                     TI_CURRENCY,
                     TI_PRICE_BASE,
                     BASE_CURRENCY,
                     GEO_TIMEZONE,
                     MKT_CLICKID,
                     MKT_NETWORK,
                     ETL_TAGS,
                     DVCE_SENT_TSTAMP,
                     REFR_DOMAIN_USERID,
                     REFR_DVCE_TSTAMP,
                     DOMAIN_SESSIONID,
                     DERIVED_TSTAMP,
                     EVENT_VENDOR,
                     EVENT_NAME,
                     EVENT_FORMAT,
                     EVENT_VERSION,
                     EVENT_FINGERPRINT,
                     TRUE_TSTAMP,
                     CONTEXTS_COM_OPTIMIZELY_SNOWPLOW_OPTIMIZELY_SUMMARY_1,
                     CONTEXTS_COM_SECRETESCAPES_ALL_PAGES_SESSION_LOGIN_TYPE_CONTEXT_1,
                     CONTEXTS_COM_SECRETESCAPES_SALE_PAGE_CONTEXT_1,
                     CONTEXTS_COM_SECRETESCAPES_USER_STATE_CONTEXT_1,
                     CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_UA_PARSER_CONTEXT_1,
                     CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_WEB_PAGE_1,
                     CONTEXTS_ORG_W3_PERFORMANCE_TIMING_1,
                     UNSTRUCT_EVENT_COM_SNOWPLOWANALYTICS_SNOWPLOW_LINK_CLICK_1,
                     CONTEXTS_COM_OPTIMIZELY_OPTIMIZELYX_SUMMARY_1,
                     CONTEXTS_COM_SECRETESCAPES_COLLECTION_CONTEXT_1,
                     CONTEXTS_COM_SECRETESCAPES_FILTER_CONTEXT_1,
                     CONTEXTS_COM_SECRETESCAPES_SCREEN_CONTEXT_1,
                     CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_APPLICATION_BACKGROUND_1,
                     CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_APPLICATION_FOREGROUND_1,
                     CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_CLIENT_SESSION_1,
                     CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_MOBILE_CONTEXT_1,
                     UNSTRUCT_EVENT_COM_SNOWPLOWANALYTICS_SNOWPLOW_SCREEN_VIEW_1,
                     UNSTRUCT_EVENT_COM_SECRETESCAPES_SEARCHED_WITH_REFINEMENT_EVENT_1,
                     CONTEXTS_COM_OPTIMIZELY_EXPERIMENT_1,
                     CONTEXTS_COM_OPTIMIZELY_STATE_1,
                     CONTEXTS_COM_OPTIMIZELY_VARIATION_1,
                     CONTEXTS_COM_OPTIMIZELY_VISITOR_1,
                     CONTEXTS_COM_OPTIMIZELY_VISITOR_AUDIENCE_1,
                     CONTEXTS_COM_OPTIMIZELY_VISITOR_DIMENSION_1,
                     UNSTRUCT_EVENT_COM_SNOWPLOWANALYTICS_MOBILE_SCREEN_VIEW_1,
                     CONTEXTS_COM_SECRETESCAPES_BOOKING_CONTEXT_1,
                     CONTEXTS_COM_SECRETESCAPES_CONTENT_CONTEXT_1,
                     CONTEXTS_COM_SECRETESCAPES_ENVIRONMENT_CONTEXT_1,
                     CONTEXTS_COM_SECRETESCAPES_SECRET_ESCAPES_SALE_CONTEXT_1,
                     CONTEXTS_COM_SECRETESCAPES_USER_CONTEXT_1,
                     CONTEXTS_COM_SECRETESCAPES_WHO_PUTS_PRODUCT_IN_FRONT_CUSTOMER_CONTEXT_1,
                     UNSTRUCT_EVENT_COM_SECRETESCAPES_BOOKING_UPDATE_EVENT_1,
                     UPDATED_AT
        )
        VALUES (BATCH.EVENT_HASH,
                BATCH.identity_fragment,
                BATCH.SE_USER_ID,
                BATCH.IS_ROBOT_SPIDER_EVENT,
                BATCH.EVENT_TSTAMP,
                BATCH.POSA_TERRITORY,
                BATCH.DEVICE_PLATFORM,
                BATCH.DEVICE_CATEGORY,
                BATCH.IS_INTERNAL_IP_ADDRESS_EVENT,
                BATCH.IS_SERVER_SIDE_EVENT,
                BATCH.LOGIN_TYPE,
                BATCH.SE_SALE_ID,
                BATCH.SALE_TYPE,
                BATCH.SALE_TRAVEL_TYPE_INFO,
                BATCH.AFFILIATE_ID,
                BATCH.AFFILIATE_NAME,
                BATCH.ORIGINAL_AFFILIATE_ID,
                BATCH.ORIGINAL_AFFILIATE_NAME,
                BATCH.APP_ID,
                BATCH.PLATFORM,
                BATCH.ETL_TSTAMP,
                BATCH.COLLECTOR_TSTAMP,
                BATCH.DVCE_CREATED_TSTAMP,
                BATCH.EVENT,
                BATCH.EVENT_ID,
                BATCH.TXN_ID,
                BATCH.NAME_TRACKER,
                BATCH.V_TRACKER,
                BATCH.V_COLLECTOR,
                BATCH.V_ETL,
                BATCH.USER_ID,
                BATCH.USER_IPADDRESS,
                BATCH.USER_FINGERPRINT,
                BATCH.DOMAIN_USERID,
                BATCH.DOMAIN_SESSIONIDX,
                BATCH.NETWORK_USERID,
                BATCH.GEO_COUNTRY,
                BATCH.GEO_REGION,
                BATCH.GEO_CITY,
                BATCH.GEO_ZIPCODE,
                BATCH.GEO_LATITUDE,
                BATCH.GEO_LONGITUDE,
                BATCH.GEO_REGION_NAME,
                BATCH.IP_ISP,
                BATCH.IP_ORGANIZATION,
                BATCH.IP_DOMAIN,
                BATCH.IP_NETSPEED,
                BATCH.PAGE_URL,
                BATCH.PAGE_TITLE,
                BATCH.PAGE_REFERRER,
                BATCH.PAGE_URLSCHEME,
                BATCH.PAGE_URLHOST,
                BATCH.PAGE_URLPORT,
                BATCH.PAGE_URLPATH,
                BATCH.PAGE_URLQUERY,
                BATCH.PAGE_URLFRAGMENT,
                BATCH.REFR_URLSCHEME,
                BATCH.REFR_URLHOST,
                BATCH.REFR_URLPORT,
                BATCH.REFR_URLPATH,
                BATCH.REFR_URLQUERY,
                BATCH.REFR_URLFRAGMENT,
                BATCH.REFR_MEDIUM,
                BATCH.REFR_SOURCE,
                BATCH.REFR_TERM,
                BATCH.MKT_MEDIUM,
                BATCH.MKT_SOURCE,
                BATCH.MKT_TERM,
                BATCH.MKT_CONTENT,
                BATCH.MKT_CAMPAIGN,
                BATCH.SE_CATEGORY,
                BATCH.SE_ACTION,
                BATCH.SE_LABEL,
                BATCH.SE_PROPERTY,
                BATCH.SE_VALUE,
                BATCH.TR_ORDERID,
                BATCH.TR_AFFILIATION,
                BATCH.TR_TOTAL,
                BATCH.TR_TAX,
                BATCH.TR_SHIPPING,
                BATCH.TR_CITY,
                BATCH.TR_STATE,
                BATCH.TR_COUNTRY,
                BATCH.TI_ORDERID,
                BATCH.TI_SKU,
                BATCH.TI_NAME,
                BATCH.TI_CATEGORY,
                BATCH.TI_PRICE,
                BATCH.TI_QUANTITY,
                BATCH.PP_XOFFSET_MIN,
                BATCH.PP_XOFFSET_MAX,
                BATCH.PP_YOFFSET_MIN,
                BATCH.PP_YOFFSET_MAX,
                BATCH.USERAGENT,
                BATCH.BR_NAME,
                BATCH.BR_FAMILY,
                BATCH.BR_VERSION,
                BATCH.BR_TYPE,
                BATCH.BR_RENDERENGINE,
                BATCH.BR_LANG,
                BATCH.BR_FEATURES_PDF,
                BATCH.BR_FEATURES_FLASH,
                BATCH.BR_FEATURES_JAVA,
                BATCH.BR_FEATURES_DIRECTOR,
                BATCH.BR_FEATURES_QUICKTIME,
                BATCH.BR_FEATURES_REALPLAYER,
                BATCH.BR_FEATURES_WINDOWSMEDIA,
                BATCH.BR_FEATURES_GEARS,
                BATCH.BR_FEATURES_SILVERLIGHT,
                BATCH.BR_COOKIES,
                BATCH.BR_COLORDEPTH,
                BATCH.BR_VIEWWIDTH,
                BATCH.BR_VIEWHEIGHT,
                BATCH.OS_NAME,
                BATCH.OS_FAMILY,
                BATCH.OS_MANUFACTURER,
                BATCH.OS_TIMEZONE,
                BATCH.DVCE_TYPE,
                BATCH.DVCE_ISMOBILE,
                BATCH.DVCE_SCREENWIDTH,
                BATCH.DVCE_SCREENHEIGHT,
                BATCH.DOC_CHARSET,
                BATCH.DOC_WIDTH,
                BATCH.DOC_HEIGHT,
                BATCH.TR_CURRENCY,
                BATCH.TR_TOTAL_BASE,
                BATCH.TR_TAX_BASE,
                BATCH.TR_SHIPPING_BASE,
                BATCH.TI_CURRENCY,
                BATCH.TI_PRICE_BASE,
                BATCH.BASE_CURRENCY,
                BATCH.GEO_TIMEZONE,
                BATCH.MKT_CLICKID,
                BATCH.MKT_NETWORK,
                BATCH.ETL_TAGS,
                BATCH.DVCE_SENT_TSTAMP,
                BATCH.REFR_DOMAIN_USERID,
                BATCH.REFR_DVCE_TSTAMP,
                BATCH.DOMAIN_SESSIONID,
                BATCH.DERIVED_TSTAMP,
                BATCH.EVENT_VENDOR,
                BATCH.EVENT_NAME,
                BATCH.EVENT_FORMAT,
                BATCH.EVENT_VERSION,
                BATCH.EVENT_FINGERPRINT,
                BATCH.TRUE_TSTAMP,
                BATCH.CONTEXTS_COM_OPTIMIZELY_SNOWPLOW_OPTIMIZELY_SUMMARY_1,
                BATCH.CONTEXTS_COM_SECRETESCAPES_ALL_PAGES_SESSION_LOGIN_TYPE_CONTEXT_1,
                BATCH.CONTEXTS_COM_SECRETESCAPES_SALE_PAGE_CONTEXT_1,
                BATCH.CONTEXTS_COM_SECRETESCAPES_USER_STATE_CONTEXT_1,
                BATCH.CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_UA_PARSER_CONTEXT_1,
                BATCH.CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_WEB_PAGE_1,
                BATCH.CONTEXTS_ORG_W3_PERFORMANCE_TIMING_1,
                BATCH.UNSTRUCT_EVENT_COM_SNOWPLOWANALYTICS_SNOWPLOW_LINK_CLICK_1,
                BATCH.CONTEXTS_COM_OPTIMIZELY_OPTIMIZELYX_SUMMARY_1,
                BATCH.CONTEXTS_COM_SECRETESCAPES_COLLECTION_CONTEXT_1,
                BATCH.CONTEXTS_COM_SECRETESCAPES_FILTER_CONTEXT_1,
                BATCH.CONTEXTS_COM_SECRETESCAPES_SCREEN_CONTEXT_1,
                BATCH.CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_APPLICATION_BACKGROUND_1,
                BATCH.CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_APPLICATION_FOREGROUND_1,
                BATCH.CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_CLIENT_SESSION_1,
                BATCH.CONTEXTS_COM_SNOWPLOWANALYTICS_SNOWPLOW_MOBILE_CONTEXT_1,
                BATCH.UNSTRUCT_EVENT_COM_SNOWPLOWANALYTICS_SNOWPLOW_SCREEN_VIEW_1,
                BATCH.UNSTRUCT_EVENT_COM_SECRETESCAPES_SEARCHED_WITH_REFINEMENT_EVENT_1,
                BATCH.CONTEXTS_COM_OPTIMIZELY_EXPERIMENT_1,
                BATCH.CONTEXTS_COM_OPTIMIZELY_STATE_1,
                BATCH.CONTEXTS_COM_OPTIMIZELY_VARIATION_1,
                BATCH.CONTEXTS_COM_OPTIMIZELY_VISITOR_1,
                BATCH.CONTEXTS_COM_OPTIMIZELY_VISITOR_AUDIENCE_1,
                BATCH.CONTEXTS_COM_OPTIMIZELY_VISITOR_DIMENSION_1,
                BATCH.UNSTRUCT_EVENT_COM_SNOWPLOWANALYTICS_MOBILE_SCREEN_VIEW_1,
                BATCH.CONTEXTS_COM_SECRETESCAPES_BOOKING_CONTEXT_1,
                BATCH.CONTEXTS_COM_SECRETESCAPES_CONTENT_CONTEXT_1,
                BATCH.CONTEXTS_COM_SECRETESCAPES_ENVIRONMENT_CONTEXT_1,
                BATCH.CONTEXTS_COM_SECRETESCAPES_SECRET_ESCAPES_SALE_CONTEXT_1,
                BATCH.CONTEXTS_COM_SECRETESCAPES_USER_CONTEXT_1,
                BATCH.CONTEXTS_COM_SECRETESCAPES_WHO_PUTS_PRODUCT_IN_FRONT_CUSTOMER_CONTEXT_1,
                BATCH.UNSTRUCT_EVENT_COM_SECRETESCAPES_BOOKING_UPDATE_EVENT_1,
                BATCH.UPDATED_AT);

------------------------------------------------------------------------------------------------------------------------
--assertions

--Count of raw input matches that of the hygiene
SELECT (SELECT COUNT(*)
        FROM SNOWPLOW_SAMPLE_EVENTS)
           =
       (SELECT COUNT(*)
        FROm EVENT_STREAM) AS ROW_COUNT_MATCHES;


--event_hash is unique

SELECT CASE WHEN COUNT(*) > 0 THEN FALSE ELSE TRUE END UNIQUE_HASH
FROM (
         SELECT e.EVENT_HASH,
                COUNT(*)
         FROM EVENT_STREAM e
         GROUP BY 1
         HAVING COUNT(*) > 1
     );

--note if reprocess entire hygiene step, need to run deduplication step