WITH affiliate AS ( -- original affiliate
    SELECT
        DISTINCT
        ID::INT AS ID,
        LAST_VALUE(NAME) OVER(PARTITION BY id ORDER BY EXTRACTED_AT) AS CURRENT_NAME,
        LAST_VALUE(TERRITORY_ID) OVER(PARTITION BY id ORDER BY EXTRACTED_AT)::INT AS CURRENT_TERRITORY_ID
    FROM RAW_VAULT.CMS_MYSQL.AFFILIATE
),
territory AS ( -- original affiliate territory, distinctify to last value ingested per territory
    SELECT
        DISTINCT
        ID::INT AS ID,
        LAST_VALUE(NAME) OVER(PARTITION BY id ORDER BY EXTRACTED_AT) AS CURRENT_NAME
    FROM RAW_VAULT.CMS_MYSQL.TERRITORY
)

SELECT
    DISTINCT
        su.ID AS "USER_ID",
        DATE_TRUNC(day, su.DATE_CREATED)::DATE AS "SIGNUP_DATE",
        DATEDIFF(month, '2011-01-31', su.DATE_CREATED) AS "COHORT_ID",
        t.CURRENT_NAME AS "ORIGINAL_AFFILIATE_TERRITORY",
        a.CURRENT_NAME AS "ORIGINAL_AFFILIATE_NAME"


FROM RAW_VAULT.CMS_MYSQL.SHIRO_USER AS su
INNER JOIN affiliate AS a ON su.ORIGINAL_AFFILIATE_ID=a.ID
INNER JOIN territory AS t ON a.CURRENT_TERRITORY_ID=t.ID;ยบ