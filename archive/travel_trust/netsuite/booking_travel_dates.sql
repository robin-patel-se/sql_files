SELECT bs.schedule_tstamp,
       bs.run_tstamp,
       bs.operation_id,
       bs.created_at,
       bs.updated_at,
       bs.row_dataset_name,
       bs.row_dataset_source,
       bs.row_loaded_at,
       bs.row_schedule_tstamp,
       bs.row_run_tstamp,
       bs.row_filename,
       bs.row_file_row_number,
       bs.no_nights,
       bs.rooms,
       bs.adult_guests,
       bs.child_guests,
       bs.infant_guests,
       bs.rate_to_gbp,
       bs.cc_rate_to_sc,
       bs.gbp_rate_to_sc,
       bs.last_updated,
       bs.date_time_booked,
       bs.booking_date,
       bs.check_in_timestamp,
       bs.check_in_date,
       bs.check_out_timestamp,
       bs.check_out_date,
       bs.booking_lead_time_days,
       bs.flight_inbound_arrival_timestamp,
       bs.flight_inbound_arrival_date,
       bs.flight_outbound_departure_timestamp,
       bs.flight_outbound_departure_date,
       bs.margin_gross_of_toms_cc,
       bs.gross_revenue_cc,
       bs.customer_total_price_cc,
       bs.gross_booking_value_cc,
       bs.vat_on_commission_cc,
       bs.booking_fee_cc,
       bs.booking_fee_net_rate_cc,
       bs.payment_surcharge_cc,
       bs.payment_surcharge_net_rate_cc,
       bs.commission_ex_vat_cc,
       bs.insurance_commission_cc,
       bs.flight_amount_cc,
       bs.flight_commission_cc,
       bs.credits_used_cc,
       bs.total_custom_tax_cc,
       bs.atol_fee_cc,
       bs.total_sell_rate_cc,
       bs.insurance_price_cc,
       bs.non_cash_credits_used_cc,
       bs.flight_only_price_cc,
       bs.flight_vat_on_commission_cc,
       bs.margin_gross_of_toms_gbp,
       bs.gross_revenue_gbp,
       bs.customer_total_price_gbp,
       bs.gross_booking_value_gbp,
       bs.vat_on_commission_gbp,
       bs.booking_fee_gbp,
       bs.booking_fee_net_rate_gbp,
       bs.payment_surcharge_gbp,
       bs.payment_surcharge_net_rate_gbp,
       bs.commission_ex_vat_gbp,
       bs.insurance_commission_gbp,
       bs.flight_amount_gbp,
       bs.flight_commission_gbp,
       bs.credits_used_gbp,
       bs.total_custom_tax_gbp,
       bs.atol_fee_gbp,
       bs.total_sell_rate_gbp,
       bs.insurance_price_gbp,
       bs.non_cash_credits_used_gbp,
       bs.flight_only_price_gbp,
       bs.flight_vat_on_commission_gbp,
       bs.margin_gross_of_toms_sc,
       bs.gross_revenue_sc,
       bs.customer_total_price_sc,
       bs.gross_booking_value_sc,
       bs.vat_on_commission_sc,
       bs.booking_fee_sc,
       bs.booking_fee_net_rate_sc,
       bs.payment_surcharge_sc,
       bs.payment_surcharge_net_rate_sc,
       bs.commission_ex_vat_sc,
       bs.insurance_commission_sc,
       bs.flight_amount_sc,
       bs.flight_commission_sc,
       bs.credits_used_sc,
       bs.total_custom_tax_sc,
       bs.atol_fee_sc,
       bs.total_sell_rate_sc,
       bs.insurance_price_sc,
       bs.non_cash_credits_used_sc,
       bs.flight_only_price_sc,
       bs.flight_vat_on_commission_sc,
       bs.is_new_model_booking,
       bs.affiliate_user_id,
       bs.shiro_user_id,
       bs.device_platform,
       bs.booking_id,
       bs.customer_id,
       bs.currency,
       bs.sale_base_currency,
       bs.territory,
       bs.last_updated_v1,
       bs.last_updated_v2,
       bs.date_time_booked_v1,
       bs.date_time_booked_v2,
       bs.check_in_date_v1,
       bs.check_in_date_v2,
       bs.check_out_date_v1,
       bs.check_out_date_v2,
       bs.flight_inbound_arrival_date_v1,
       bs.flight_inbound_arrival_date_v2,
       bs.flight_outbound_departure_date_v1,
       bs.flight_outbound_departure_date_v2,
       bs.booking_type,
       bs.no_nights__o,
       bs.rooms__o,
       bs.adult_guests__o,
       bs.child_guests__o,
       bs.infant_guests__o,
       bs.vat_on_commission_cc_100,
       bs.customer_total_price_cc_100,
       bs.gross_booking_value_cc_100,
       bs.gross_booking_value_cc__o,
       bs.gross_booking_value_gbp__o,
       bs.gross_booking_value_sc__o,
       bs.commission_ex_vat_cc_100,
       bs.commission_ex_vat_sc_100,
       bs.booking_fee_cc_100,
       bs.booking_fee_net_rate_cc_100,
       bs.payment_surcharge_cc_100,
       bs.payment_surcharge_net_rate_cc_100,
       bs.insurance_commission_cc_100,
       bs.non_cash_credits_used_cc_100,
       bs.flight_only_price_cc_100,
       bs.flight_only_price_sc_100,
       bs.flight_vat_on_commission_cc_100,
       bs.flight_amount_cc_100,
       bs.flight_commission_cc_100,
       bs.rate_to_gbp_100000,
       bs.total_custom_tax_cc_100,
       bs.atol_fee_cc_100,
       bs.total_sell_rate_cc_100,
       bs.insurance_price_cc_100,
       bs.customer_email,
       bs.sale_product,
       bs.sale_type,
       bs.booking_status,
       bs.affiliate,
       bs.affiliate_domain,
       bs.booking_class,
       bs.affiliate_id,
       bs.sale_id,
       bs.offer_id,
       bs.offer_name,
       bs.transaction_id,
       bs.bundle_id,
       bs.unique_transaction_reference,
       bs.has_flights,
       bs.supplier,
       bs.platform_name__o,
       bs.credits_used_cc_100,
       bs.insurance_provider,
       bs.payment_type,
       bs.departure_airport_code,
       bs.sale_closest_airport_code,
       bs.vcc_reference,
       bs.flight_carrier,
       bs.flight_invoice_number,
       bs.record__o
FROM hygiene_snapshot_vault_mvp.cms_mongodb.booking_summary bs;

SELECT * FROM hygiene_snapshot_vault_mvp.cms_mysql.booking b;

CREATE OR REPLACE TRANSIENT TABLE hygiene_snapshot_vault_mvp_dev_robin.cms_mysql.booking CLONE hygiene_snapshot_vault_mvp.cms_mysql.booking;
CREATE OR REPLACE TRANSIENT TABLE hygiene_snapshot_vault_mvp_dev_robin.cms_mysql.product_reservation CLONE hygiene_snapshot_vault_mvp.cms_mysql.product_reservation;
CREATE OR REPLACE TRANSIENT TABLE hygiene_snapshot_vault_mvp_dev_robin.cms_mysql.reservation CLONE hygiene_snapshot_vault_mvp.cms_mysql.reservation;
CREATE OR REPLACE TRANSIENT TABLE hygiene_snapshot_vault_mvp_dev_robin.cms_mysql.reservation_exchange_rate CLONE hygiene_snapshot_vault_mvp.cms_mysql.reservation_exchange_rate;
CREATE OR REPLACE TRANSIENT TABLE hygiene_snapshot_vault_mvp_dev_robin.cms_mongodb.booking_summary CLONE hygiene_snapshot_vault_mvp.cms_mongodb.booking_summary;
CREATE OR REPLACE TRANSIENT TABLE hygiene_snapshot_vault_mvp_dev_robin.fpa_gsheets.constant_currency CLONE hygiene_snapshot_vault_mvp.fpa_gsheets.constant_currency;
CREATE OR REPLACE TRANSIENT TABLE data_vault_mvp_dev_robin.dwh.booking_cancellation CLONE data_vault_mvp.dwh.booking_cancellation;
CREATE OR REPLACE TRANSIENT TABLE data_vault_mvp_dev_robin.dwh.se_credit CLONE data_vault_mvp.dwh.se_credit;


python biapp/bau/hygiene/gen_hygiene_files.py \
    --data_source cms_mysql \
    --name amendment \
    --primary_key_cols id \
    --new_record_col date_created \

SELECT MIN(loaded_at) FROM raw_vault_mvp.cms_mysql.amendment a; --2020-06-24 11:10:06.458806000
CREATE OR REPLACE TRANSIENT TABLE raw_vault_mvp_dev_robin.cms_mysql.amendment CLONE raw_vault_mvp.cms_mysql.amendment;

self_describing_task --include 'staging/hygiene/cms_mysql/amendment.py'  --method 'run' --start '2020-06-24 00:00:00' --end '2020-06-24 00:00:00'
self_describing_task --include 'staging/hygiene_snapshots/cms_mysql/amendment.py'  --method 'run' --start '2021-08-15 00:00:00' --end '2021-08-15 00:00:00'
airflow backfill --start_date '2020-06-24 00:00:00' --end_date '2020-06-25 00:00:00' --task_regex '.*' hygiene_snapshots__cms_mysql__amendment__daily_at_01h00

SELECT * FROM data_vault_mvp.cms_mysql_snapshots.amendment_snapshot;

SELECT get_ddl('table', 'data_vault_mvp.cms_mysql_snapshots.amendment_snapshot');

CREATE OR REPLACE TRANSIENT TABLE raw_vault_mvp_dev_robin.cms_mysql.days_before_policy CLONE raw_vault_mvp.cms_mysql.days_before_policy;

python biapp/bau/hygiene/gen_hygiene_files.py \
    --data_source cms_mysql \
    --name days_before_policy \
    --primary_key_cols id \

SELECT MIN(LOADED_AT) FROm raw_vault_mvp.cms_mysql.days_before_policy dbp;--2020-10-19 13:41:50.165133000
self_describing_task --include 'staging/hygiene/cms_mysql/days_before_policy.py'  --method 'run' --start '2020-10-19 00:00:00' --end '2020-10-19 00:00:00'
self_describing_task --include 'staging/hygiene_snapshots/cms_mysql/days_before_policy.py'  --method 'run' --start '2020-10-19 00:00:00' --end '2020-10-19 00:00:00'
airflow backfill --start_date '2021-08-15 00:00:00' --end_date '2021-08-16 00:00:00' --task_regex '.*' hygiene_snapshots__cms_mysql__days_before_policy__daily_at_01h00

SELECT * FROM raw_vault_mvp.cms_mysql.days_before_policy;
SELECT * FROM hygiene_snapshot_vault_mvp_dev_robin.cms_mysql.days_before_policy;

DROP TABLE data_vault_mvp.cms_mysql_snapshots.days_before_policy_snapshot;

self_describing_task --include 'dv/dwh/transactional/se_booking.py'  --method 'run' --start '2021-08-15 00:00:00' --end '2021-08-15 00:00:00'
SELECT * FROM data_vault_mvp_dev_robin.dwh.se_booking sb WHERE sb.has_flights;
SELECT * FROM data_vault_mvp.dwh.tb_booking tb;

self_describing_task --include 'dv/dwh/transactional/fact_booking.py'  --method 'run' --start '2021-08-15 00:00:00' --end '2021-08-15 00:00:00'

CREATE OR REPLACE TRANSIENT TABLE data_vault_mvp_dev_robin.dwh.tb_booking CLONE data_vault_mvp.dwh.tb_booking;
CREATE OR REPLACE TRANSIENT TABLE data_vault_mvp_dev_robin.dwh.chiasma_external_booking CLONE data_vault_mvp.dwh.chiasma_external_booking;
CREATE OR REPLACE TRANSIENT TABLE data_vault_mvp_dev_robin.dwh.wrd_booking CLONE data_vault_mvp.dwh.wrd_booking;
CREATE OR REPLACE TRANSIENT TABLE data_vault_mvp_dev_robin.dwh.user_attributes CLONE data_vault_mvp.dwh.user_attributes;
CREATE OR REPLACE TRANSIENT TABLE data_vault_mvp_dev_robin.dwh.rebooking CLONE data_vault_mvp.dwh.rebooking;
CREATE OR REPLACE VIEW data_vault_mvp_dev_robin.dwh.dim_sale AS SELECT * FROM data_vault_mvp.dwh.dim_sale ds;

CREATE OR REPLACE TRANSIENT TABLE data_vault_mvp.cms_mysql_snapshots.amendment_snapshot_20210816 CLONE data_vault_mvp.cms_mysql_snapshots.amendment_snapshot;
CREATE OR REPLACE TRANSIENT TABLE data_vault_mvp.cms_mysql_snapshots.days_before_policy_snapshot_20210816 CLONE data_vault_mvp.cms_mysql_snapshots.days_before_policy_snapshot;

DROP TABLE data_vault_mvp.cms_mysql_snapshots.amendment_snapshot;
DROP TABLE data_vault_mvp.cms_mysql_snapshots.days_before_policy_snapshot;

airflow backfill --start_date '2021-08-15 00:00:00' --end_date '2021-08-16 00:00:00' --reset_dagruns --task_regex '.*' dwh__transactional__booking__daily_at_03h00


SELECT * FROM collab.information_schema.views
WHERE view_definition LIKE ('%data_vault_mvp.cms_mysql_snapshots.amendment_snapshot%')
OR
view_definition LIKE ('%data_vault_mvp.cms_mysql_snapshots.days_before_policy_snapshot%')


SELECT * FROM data_vault_mvp.dwh.se_booking sb;

self_describing_task --include 'se/data/dwh/se_booking.py'  --method 'run' --start '2021-08-16 00:00:00' --end '2021-08-16 00:00:00'

SELECT sb.schedule_tstamp,
       sb.run_tstamp,
       sb.operation_id,
       sb.created_at,
       sb.updated_at,
       sb.booking_id,
       sb.transaction_id,
       sb.unique_transaction_reference,
       sb.last_updated,
       sb.last_updated_booking_summary,
       sb.last_updated_bookings,
       sb.last_updated_reservations,
       sb.territory,
       sb.booking_status,
       sb.currency,
       sb.booking_completed_date,
       sb.booking_created_date,
       sb.booking_completed_timestamp,
       sb.booking_created_timestamp,
       sb.cs_agent_booking,
       sb.shiro_user_id,
       sb.affiliate_user_id,
       sb.device_platform,
       sb.cc_rate_to_gbp,
       sb.cc_rate_to_sc,
       sb.gbp_rate_to_sc,
       sb.gross_revenue_cc,
       sb.customer_total_price_cc,
       sb.gross_booking_value_cc,
       sb.margin_gross_of_toms_cc,
       sb.vat_on_commission_cc,
       sb.commission_ex_vat_cc,
       sb.booking_fee_cc,
       sb.booking_fee_net_rate_cc,
       sb.payment_surcharge_cc,
       sb.payment_surcharge_net_rate_cc,
       sb.insurance_commission_cc,
       sb.flight_amount_cc,
       sb.flight_commission_cc,
       sb.credits_used_cc,
       sb.total_custom_tax_cc,
       sb.atol_fee_cc,
       sb.total_sell_rate_cc,
       sb.insurance_price_cc,
       sb.gross_revenue_gbp,
       sb.gross_revenue_gbp_constant_currency,
       sb.customer_total_price_gbp,
       sb.customer_total_price_gbp_constant_currency,
       sb.gross_booking_value_gbp,
       sb.margin_gross_of_toms_gbp,
       sb.margin_gross_of_toms_gbp_constant_currency,
       sb.vat_on_commission_gbp,
       sb.commission_ex_vat_gbp,
       sb.booking_fee_gbp,
       sb.booking_fee_net_rate_gbp,
       sb.payment_surcharge_gbp,
       sb.payment_surcharge_net_rate_gbp,
       sb.insurance_commission_gbp,
       sb.flight_amount_gbp,
       sb.flight_commission_gbp,
       sb.credits_used_gbp,
       sb.total_custom_tax_gbp,
       sb.atol_fee_gbp,
       sb.total_sell_rate_gbp,
       sb.insurance_price_gbp,
       sb.gross_revenue_sc,
       sb.customer_total_price_sc,
       sb.gross_booking_value_sc,
       sb.margin_gross_of_toms_sc,
       sb.vat_on_commission_sc,
       sb.commission_ex_vat_sc,
       sb.booking_fee_sc,
       sb.booking_fee_net_rate_sc,
       sb.payment_surcharge_sc,
       sb.payment_surcharge_net_rate_sc,
       sb.insurance_commission_sc,
       sb.flight_amount_sc,
       sb.flight_commission_sc,
       sb.credits_used_sc,
       sb.total_custom_tax_sc,
       sb.atol_fee_sc,
       sb.total_sell_rate_sc,
       sb.insurance_price_sc,
       sb.gross_revenue_eur_constant_currency,
       sb.margin_gross_of_toms_eur_constant_currency,
       sb.sale_id,
       sb.sale_base_currency,
       sb.offer_id,
       sb.offer_name,
       sb.bundle_id,
       sb.check_in_date,
       sb.check_out_date,
       sb.outbound_flight_departure_date,
       sb.inbound_flight_arrival_date,
       sb.booking_lead_time_days,
       sb.booking_type,
       sb.no_nights,
       sb.rooms,
       sb.room_nights,
       sb.adult_guests,
       sb.child_guests,
       sb.infant_guests,
       sb.sale_product,
       sb.sale_type,
       sb.has_flights,
       sb.price_per_night,
       sb.price_per_person_per_night,
       sb.supplier_name,
       sb.rebooked,
       sb.date_of_rebooking,
       sb.original_check_in_date,
       sb.original_check_out_date,
       sb.voucher_stay_by_date,
       sb.is_new_model_booking,
       sb.is_staff_booking,
       sb.staff_booking_discount_type,
       sb.affiliate_id,
       sb.affiliate,
       sb.affiliate_domain,
       sb.agent_id,
       sb.payment_id,
       sb.hold_id,
       sb.insurance_provider,
       sb.payment_type,
       sb.supplier_to_user_currency_exchange_rate_id,
       sb.refund_type,
       sb.total_refunded_cc,
       sb.total_refunded_gbp,
       sb.total_refunded_sc,
       sb.cancellation_date,
       sb.cancellation_tstamp,
       sb.cancellation_fault,
       sb.cancellation_reason,
       sb.cancellation_refund_channel,
       sb.cancellation_status,
       sb.cancellation_requested_by,
       sb.cancellation_requested_by_domain,
       sb.cancellation_payment_provider_refund_status,
       sb.cancellation_policy_id,
       sb.cancellation_policy_number_of_days,
       sb.cancellation_policy_percentage
FROM data_vault_mvp_dev_robin.dwh.se_booking sb;

CREATE OR REPLACE TRANSIENT TABLE data_vault_mvp_dev_robin.dwh.se_booking clone data_vault_mvp.dwh.se_booking;

self_describing_task --include 'se/data_pii/dwh/se_booking.py'  --method 'run' --start '2021-08-16 00:00:00' --end '2021-08-16 00:00:00'

SELECT sb.booking_id,
       sb.transaction_id,
       sb.unique_transaction_reference,
       sb.last_updated,
       sb.territory,
       sb.booking_status,
       sb.currency,
       sb.booking_completed_date,
       sb.booking_created_date,
       sb.booking_completed_timestamp,
       sb.booking_created_timestamp,
       sb.cs_agent_booking,
       sb.shiro_user_id,
       sb.affiliate_user_id,
       sb.device_platform,
       sb.cc_rate_to_gbp,
       sb.cc_rate_to_sc,
       sb.gbp_rate_to_sc,
       sb.gross_revenue_cc,
       sb.customer_total_price_cc,
       sb.gross_booking_value_cc,
       sb.margin_gross_of_toms_cc,
       sb.vat_on_commission_cc,
       sb.commission_ex_vat_cc,
       sb.booking_fee_cc,
       sb.booking_fee_net_rate_cc,
       sb.payment_surcharge_cc,
       sb.payment_surcharge_net_rate_cc,
       sb.insurance_commission_cc,
       sb.flight_amount_cc,
       sb.flight_commission_cc,
       sb.credits_used_cc,
       sb.total_custom_tax_cc,
       sb.atol_fee_cc,
       sb.total_sell_rate_cc,
       sb.insurance_price_cc,
       sb.gross_revenue_gbp,
       sb.gross_revenue_gbp_constant_currency,
       sb.customer_total_price_gbp,
       sb.customer_total_price_gbp_constant_currency,
       sb.gross_booking_value_gbp,
       sb.margin_gross_of_toms_gbp,
       sb.margin_gross_of_toms_gbp_constant_currency,
       sb.vat_on_commission_gbp,
       sb.commission_ex_vat_gbp,
       sb.booking_fee_gbp,
       sb.booking_fee_net_rate_gbp,
       sb.payment_surcharge_gbp,
       sb.payment_surcharge_net_rate_gbp,
       sb.insurance_commission_gbp,
       sb.flight_amount_gbp,
       sb.flight_commission_gbp,
       sb.credits_used_gbp,
       sb.total_custom_tax_gbp,
       sb.atol_fee_gbp,
       sb.total_sell_rate_gbp,
       sb.insurance_price_gbp,
       sb.gross_revenue_sc,
       sb.customer_total_price_sc,
       sb.gross_booking_value_sc,
       sb.margin_gross_of_toms_sc,
       sb.vat_on_commission_sc,
       sb.commission_ex_vat_sc,
       sb.booking_fee_sc,
       sb.booking_fee_net_rate_sc,
       sb.payment_surcharge_sc,
       sb.payment_surcharge_net_rate_sc,
       sb.insurance_commission_sc,
       sb.flight_amount_sc,
       sb.flight_commission_sc,
       sb.credits_used_sc,
       sb.total_custom_tax_sc,
       sb.atol_fee_sc,
       sb.total_sell_rate_sc,
       sb.insurance_price_sc,
       sb.gross_revenue_eur_constant_currency,
       sb.margin_gross_of_toms_eur_constant_currency,
       sb.se_sale_id,
       sb.sale_id,
       sb.sale_base_currency,
       sb.offer_id,
       sb.offer_name,
       sb.bundle_id,
       sb.check_in_date,
       sb.check_out_date,
       sb.booking_lead_time_days,
       sb.booking_type,
       sb.no_nights,
       sb.rooms,
       sb.room_nights,
       sb.adult_guests,
       sb.child_guests,
       sb.infant_guests,
       sb.sale_product,
       sb.sale_type,
       sb.has_flights,
       sb.price_per_night,
       sb.price_per_person_per_night,
       sb.supplier_name,
       sb.rebooked,
       sb.date_of_rebooking,
       sb.original_check_in_date,
       sb.original_check_out_date,
       sb.voucher_stay_by_date,
       sb.is_new_model_booking,
       sb.is_staff_booking,
       sb.staff_booking_discount_type,
       sb.affiliate_id,
       sb.affiliate,
       sb.affiliate_domain,
       sb.agent_id,
       sb.payment_id,
       sb.hold_id,
       sb.insurance_provider,
       sb.payment_type,
       sb.is_affiliate_booking,
       sb.refund_type,
       sb.total_refunded_cc,
       sb.total_refunded_gbp,
       sb.total_refunded_sc,
       sb.cancellation_date,
       sb.cancellation_tstamp,
       sb.cancellation_fault,
       sb.cancellation_reason,
       sb.cancellation_refund_channel,
       sb.cancellation_status,
       sb.cancellation_requested_by_domain,
       sb.cancellation_payment_provider_refund_status,
       sb.cancellation_policy_id,
       sb.cancellation_policy_number_of_days,
       sb.cancellation_policy_percentage
FROM se.data.se_booking sb