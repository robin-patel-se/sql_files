name: CRM_ANALYSIS
description: |-
  This semantic view looks as CRM reporting from 2021 onwards, looking at email, push, in-app and web push. It'll automatically default to email, unless you explicitly ask for one of the other channel types in your question.

  You can access the following metrics: sends, opens, clicks, unique clicks, bookings and margin - it will default to 7d caps for sends over a week ago, if you want to change the cap please ask the analyst specifically to do so.
tables:
  - name: ITERABLE_CRM_REPORTING
    description: The table contains records of email marketing campaign activities and message delivery events. Each record represents a single email send event with associated campaign details, recipient information, and various categorization mappings including territory, objective, platform, and audience segment.
    base_table:
      database: SE
      schema: DATA
      table: ITERABLE_CRM_REPORTING
    dimensions:
      - name: AME_CALCULATED_CAMPAIGN_NAME
        description: The calculated campaign name generated by AME (Automated Marketing Engine).
        expr: AME_CALCULATED_CAMPAIGN_NAME
        data_type: VARCHAR(16777216)
        sample_values:
          - WedNewsletter
          - MonAthena
          - ThuAthena
      - name: CAMPAIGN_GROUP
        synonyms:
          - campaign
          - campaign group
        description: Category grouping of campaigns
        expr: |-
          case when (
                is_automated_campaign = true
                and email_type <> 'Newsletter'
              ) then lower(ame_calculated_campaign_name)
              else lower(mapped_platform) end
        data_type: VARCHAR(16777216)
        sample_values:
          - athena
          - newimproved
          - kronos
          - promotion
          - abandonbrowse
          - newandimproved
      - name: CAMPAIGN_ID
        description: Unique identifier for marketing campaigns in the Iterable customer relationship management system.
        expr: CAMPAIGN_ID
        data_type: NUMBER(38,0)
        sample_values:
          - '7676366'
          - '3236588'
          - '3399414'
      - name: COMBINED_EMAIL_NAME
        description: The combined name used for email identification purposes.
        expr: COMBINED_EMAIL_NAME
        data_type: VARCHAR(16777216)
        sample_values:
          - AMNE_NO_SatAthena_Athena_X_Inactive
          - 20250406_IT_CORE_SundayBest_X_X_X_base
          - 20220614_UK_PARTNER_ATHENA_PureAthena
      - name: CRM_CHANNEL_TYPE
        description: |-
          The type of customer relationship management (CRM) channel used for communication or engagement.

          If 'app' this can also be called 'push' so if push is asked for , use app filter.
        expr: CRM_CHANNEL_TYPE
        data_type: VARCHAR(16777216)
        sample_values:
          - in-app
          - email
          - app
      - name: CURRENT_AFFILIATE_TERRITORY
        description: The current affiliate territory designation.
        expr: CURRENT_AFFILIATE_TERRITORY
        data_type: VARCHAR(16777216)
        sample_values:
          - UK
          - SE
      - name: EMAIL_TYPE
        expr: EMAIL_TYPE
        data_type: VARCHAR(16777216)
        sample_values:
          - Lifecycle
          - Newsletter
          - Trigger
      - name: IS_AUTOMATED_CAMPAIGN
        description: Indicates whether the campaign was automated or manually created.
        expr: IS_AUTOMATED_CAMPAIGN
        data_type: BOOLEAN
        sample_values:
          - 'TRUE'
          - 'FALSE'
      - name: MAPPED_PLATFORM
        description: The platform that has been mapped or associated with the record.
        expr: MAPPED_PLATFORM
        data_type: VARCHAR(16777216)
        sample_values:
          - Athena
          - SundayBest
          - NewImproved
      - name: MESSAGE_ID
        description: Unique identifier for each message sent through the Iterable customer relationship management platform.
        expr: MESSAGE_ID
        data_type: VARCHAR(16777216)
        sample_values:
          - 878d8e55e1be4566b8c54df3d96cbd77
          - 86b8c5926e254db69b5d8b2d152bb5c9
          - d65c581a44c843c08e8b93cf29570337
      - name: RFV_SEGMENT
        description: RFV segment classification based on recency, frequency, and value metrics.
        expr: RFV_SEGMENT
        data_type: VARCHAR(16777216)
        sample_values:
          - Superhot Prospects
          - Mid-Term Lapsed
          - Dormant
      - name: SHIRO_USER_ID
        description: Unique identifier for a user in the Shiro security framework.
        expr: SHIRO_USER_ID
        data_type: NUMBER(38,0)
        sample_values:
          - '55923279'
          - '69332901'
      - name: TERRITORY_GROUP
        synonyms:
          - current affiliate territory group
        description: Category grouping of current_affiliate_territory
        expr: |-
          CASE WHEN CURRENT_AFFILIATE_TERRITORY IN ('DE', 'AT', 'CH') THEN 'DACH'
          WHEN CURRENT_AFFILIATE_TERRITORY IN ('UK' , 'Guardian - UK' ) THEN 'UK'
          ELSE 'ROW'
          END
        data_type: VARCHAR(4)
        sample_values:
          - UK
          - ROW
          - DACH
    time_dimensions:
      - name: SEND_EVENT_DATE
        description: The date when a send event occurred in the Iterable customer relationship management system.
        expr: SEND_EVENT_DATE
        data_type: DATE
        sample_values:
          - '2024-01-27'
          - '2024-06-05'
          - '2024-07-21'
    facts:
      - name: BOOKINGS_1D_LND
        expr: BOOKINGS_1D_LND
        data_type: NUMBER(38,0)
        access_modifier: public_access
      - name: BOOKINGS_7D_LND
        expr: BOOKINGS_7D_LND
        data_type: NUMBER(38,0)
        access_modifier: public_access
      - name: EMAIL_CLICKS_1D
        expr: EMAIL_CLICKS_1D
        data_type: NUMBER(38,0)
        access_modifier: public_access
      - name: EMAIL_CLICKS_7D
        expr: EMAIL_CLICKS_7D
        data_type: NUMBER(38,0)
        access_modifier: public_access
      - name: EMAIL_OPENS_1D
        expr: EMAIL_OPENS_1D
        data_type: NUMBER(38,0)
        access_modifier: public_access
      - name: EMAIL_OPENS_7D
        expr: EMAIL_OPENS_7D
        data_type: NUMBER(38,0)
        access_modifier: public_access
      - name: EMAIL_SENDS
        expr: EMAIL_SENDS
        data_type: NUMBER(38,0)
        access_modifier: public_access
      - name: MARGIN_GBP_1D_LND
        expr: MARGIN_GBP_1D_LND
        data_type: NUMBER(38,0)
        access_modifier: public_access
      - name: MARGIN_GBP_7D_LND
        expr: MARGIN_GBP_7D_LND
        data_type: NUMBER(38,0)
        access_modifier: public_access
      - name: UNIQUE_EMAIL_CLICKS_1D
        expr: UNIQUE_EMAIL_CLICKS_1D
        data_type: NUMBER(38,0)
        access_modifier: public_access
      - name: UNIQUE_EMAIL_CLICKS_7D
        expr: UNIQUE_EMAIL_CLICKS_7D
        data_type: NUMBER(38,0)
        access_modifier: public_access
      - name: UNIQUE_EMAIL_OPENS_1D
        expr: UNIQUE_EMAIL_OPENS_1D
        data_type: NUMBER(38,0)
        access_modifier: public_access
      - name: UNIQUE_EMAIL_OPENS_7D
        expr: UNIQUE_EMAIL_OPENS_7D
        data_type: NUMBER(38,0)
        access_modifier: public_access
    filters:
      - name: dach_territories
        description: Filters for users in Swiss and German affiliate territories only. Use when questions ask about 'Swiss and German markets', 'CH and DE performance', 'German-speaking markets', 'DACH' or 'DACH region subset'. Helps analyze performance in German-speaking European markets and regional marketing effectiveness.
        expr: current_affiliate_territory IN ('CH', 'DE')
      - name: de_uk_territories
        description: Filters for users in German and UK affiliate territories only. Use when questions ask about 'German and UK markets', 'DE and UK performance', 'non ROW' or 'primary European territories'. Helps analyze performance in key European markets and compare regional effectiveness.
        expr: current_affiliate_territory IN ('DE', 'UK')
      - name: email_channel_only
        description: |-
          Filters for email-based CRM communications only, excluding other channel types like web push or push notifications. Use when questions ask about email performance specificially - eg 'email campaigns', 'email performance', 'email marketing', or 'email communications'. Helps analyze email-specific marketing effectiveness and engagement metrics.

          Default to this filter if a crm_channel_type is not specified.
        expr: crm_channel_type = 'email'
      - name: kronos_campaigns
        description: Filters for Kronos-specific campaigns based on campaign group classification. Includes both automated campaigns (using AME calculated campaign name) and manual campaigns (using mapped platform) that are exactly 'kronos'. Use when questions ask about 'kronos campaigns', 'kronos performance', 'kronos sends', or 'kronos email performance'. Helps analyze the performance and effectiveness of the Kronos campaign type specifically.
        expr: LOWER(CASE WHEN (email_type <> 'Newsletter' AND is_automated_campaign = TRUE) THEN LOWER(ame_calculated_campaign_name) ELSE LOWER(mapped_platform) END) = 'kronos'
      - name: partner_campaigns
        description: Filters out campaigns that are partner or media sends, unless specifically asked to include them in results.
        expr: LOWER(combined_email_name) not like '%partner%' and lower(combined_email_name) not like '%media%'
      - name: push_channel_only
        synonyms:
          - app
          - push
        description: Filter for push-based CRM communications only, when specifically asked to.
        expr: crm_channel_type = 'push'
    metrics:
      - name: CLICK_THROUGH_RATE_1D
        synonyms:
          - click rate 1d
          - click through rate 1D
          - CTR 1D
        description: |-
          Calculates the click-through rate (CTR) for 1-day period, measuring clicks as a percentage of sends. Use when questions ask about 'ctr', 'click through rate', 'immediate click performance', or 'campaign click rate'. Helps measure overall email campaign effectiveness in driving immediate user actions.

          Always use this by default when looking at click through rates for weekly performance, or performance of campaigns with a send event date of less than 8 days ago
        expr: SUM(email_clicks_1d) / SUM(email_sends)
        access_modifier: public_access
      - name: CLICK_THROUGH_RATE_7D
        synonyms:
          - click rate 7d
          - click through rate 7d
          - ctr 7d
        description: |-
          Calculates the click-through rate (CTR) for 1-day period, measuring clicks as a percentage of sends. Use when questions ask about 'ctr', 'click through rate', 'immediate click performance', or 'campaign click rate'. Helps measure overall email campaign effectiveness in driving immediate user actions.

          Always use this by default when looking at click through rates for campaigns sent over a week ago, or by default when asked about monthly performance.
        expr: sum(email_clicks_7d)/sum(email_sends)
        access_modifier: public_access
      - name: CLICK_TO_OPEN_RATE_1D
        synonyms:
          - click to open 1d
          - cto 1d
        description: |-
          Calculates the click-to-open rate (CTO) for 1-day period, measuring clicks as a percentage of opens. Use when questions ask about 'cto', 'click to open rate', 'engagement quality', or 'how many who opened also clicked'. Helps evaluate email content effectiveness and user engagement quality among those who opened emails.

          Use by default if looking at a campaign with a send event date of less than 8 days ago, or if looking at weekly performance.
        expr: SUM(email_clicks_1d) / SUM(email_opens_1d)
        access_modifier: public_access
      - name: CLICK_TO_OPEN_RATE_7D
        synonyms:
          - click to open 7d
          - cto 7d
        description: |-
          Calculates the click-to-open rate (CTO) for 1-day period, measuring clicks as a percentage of opens. Use when questions ask about 'cto', 'click to open rate', 'engagement quality', or 'how many who opened also clicked'. Helps evaluate email content effectiveness and user engagement quality among those who opened emails.

          Use by default when asked about single campaign or email performance from longer than a week ago, use by default for monthly reporting.
        expr: sum(email_clicks_7d)/sum(email_opens_7d)
        access_modifier: public_access
      - name: CONVERSION_RATE_1D
        synonyms:
          - conversion rate 1d
          - convert 1d
          - cvr 1d
        description: |-
          Calculated conversion rate (CTR) with a 1-day cap, measuring bookings as a percentage of clicks. Use when asked about CVR, conversion rate, likelyhood to convert, or campaign conversion rate. Helps measure effectiveness of campaign.

          Always use this by default when looking at conversion rates for weekly performance, or performance of campaings with a send date of less than 8 days ago.
        expr: sum(bookings_1d_lnd)/sum(email_clicks_1d)
        access_modifier: public_access
      - name: CONVERSION_RATE_7D
        synonyms:
          - conversion rate
          - convert7d
          - cvr 7d
        description: |-
          Calculated conversion rate (CTR) with a 7-day cap, measuring bookings as a percentage of clicks. Use when asked about CVR, conversion rate, likelyhood to convert, or campaign conversion rate. Helps measure effectiveness of campaign.

          Always use this by default when looking at conversion rates for monthly performance, or performance of campaings with a send date of over a week ago.
        expr: sum(bookings_7d_lnd)/sum(email_clicks_7d)
        access_modifier: public_access
      - name: EMAIL_CLICKS_1D_TOTAL
        description: Calculates the total number of email clicks within 1 day of send. Use when questions ask about 'clicks', 'email clicks', 'click volume', or 'user interactions'. Helps measure email campaign engagement and the effectiveness of call-to-action elements in driving user actions.
        expr: SUM(email_clicks_1d)
        access_modifier: public_access
      - name: EMAIL_OPENS_1D_TOTAL
        description: Calculates the total number of email opens within 1 day of send. Use when questions ask about 'opens', 'email opens', 'how many people opened emails', or 'email engagement'. Helps measure immediate email campaign performance and user engagement with email content.
        expr: SUM(email_opens_1d)
        access_modifier: public_access
      - name: MARGIN_PER_BOOKING_1D
        synonyms:
          - margin per booking
          - mpb 1d
        description: |-
          Calculates margin per booking (MPB) with a 1d cap, measures how valuable each booking was.

          Default to this if looking at weekly peformance, or any campaigns with a send date of up to 8 days ago.
        expr: sum(margin_gbp_1d_lnd)/sum(bookings_1d_lnd)
        access_modifier: public_access
      - name: MARGIN_PER_BOOKING_7D
        synonyms:
          - margin per booking 7d
          - mpb 7d
        description: |-
          Calculates margin per booking (MPB) with a 7d cap, measures how valuable each booking was.

          Default to this if looking at monthly performance, or any campaigns with a send date of over a week ago.
        expr: sum(margin_gbp_7d_lnd)/sum(bookings_1d_lnd)
        access_modifier: public_access
      - name: OPEN_RATE_1D
        synonyms:
          - OR
        description: Calculates the open rate (orate) for 1-day period, measuring opens as a percentage of sends. Use when questions ask about 'orate', 'open rate', 'email performance', or 'how many opened emails'. Helps evaluate email deliverability, subject line effectiveness, and overall campaign reach.
        expr: SUM(email_opens_1d) / SUM(email_sends)
        access_modifier: public_access
      - name: OPEN_RATE_1D_ENHANCED
        description: Calculates the open rate for 1-day period with enhanced null handling, measuring email opens as a percentage of sends. Use when questions ask about 'open rate', 'email performance', 'how many opened emails', or 'immediate email engagement'. Helps evaluate email deliverability, subject line effectiveness, and overall campaign reach for recent campaigns or weekly performance analysis.
        expr: SUM(email_opens_1d) / NULLIF(NULLIF(NULLIF(SUM(email_sends), 0), 0), 0)
        access_modifier: public_access
      - name: OPEN_RATE_7D
        synonyms:
          - monthly open rate
          - Open rate 7d
          - OR 7d
          - Orate 7d
        description: |-
          Calculates the open rate (orate) for 7- day period, measuring opens as a percentage of sends. Use when questions ask about 'orate', 'open rate', 'email performance', or 'how many opened emails'. Helps evaluate email deliverability, subject line effectiveness, and overall campaign reach.

          default to this open rate when asked about monthly reporting specifcally
        expr: sum(email_opens_7d)/sum(email_sends)
        access_modifier: public_access
      - name: SEND_PROPORTION
        description: Calculates the proportion of email sends for a given segment relative to total sends across all segments. Use when questions ask about 'distribution', 'proportion', 'percentage breakdown', or 'share of sends'. Helps analyze how email volume is distributed across territories, campaigns, or other segments to understand marketing reach allocation.
        expr: SUM(email_sends) / NULLIF(SUM(SUM(email_sends)) OVER (), 0)
        access_modifier: public_access
      - name: TOTAL_EMAIL_SENDS
        description: Calculates the total number of emails sent across all campaigns. Use when questions ask about 'total sends', 'emails sent', 'send volume', or 'campaign reach'. Helps measure campaign scale, delivery performance, and overall email marketing activity volume.
        expr: SUM(email_sends)
        access_modifier: public_access
      - name: UNIQUE_CLICK_THROUGH_RATE_1D
        synonyms:
          - uctr 1d
          - unique click rate 1d
          - unique click through rate 1d
        description: |-
          Calculates the unique click-through rate (UCTR) for 1-day period, measuring clicks as a percentage of sends. Use when questions ask about 'uctr', 'unique click through rate', 'immediate click performance', or 'campaign unique click rate'. Helps measure overall email campaign effectiveness in driving immediate user actions.

          Always use this by default when looking at unique click through rates for weekly performance, or performance of campaigns with a send event date of less than 8 days ago
        expr: sum(unique_email_clicks_1d)/sum(email_sends)
        access_modifier: public_access
      - name: UNIQUE_CLICK_THROUGH_RATE_1D_ENHANCED
        description: Calculates the unique click-through rate (UCTR) for 1-day period with enhanced null handling, measuring unique email clicks as a percentage of sends. Use when questions ask about 'UCTR', 'unique click through rate', 'distinct clicks', or 'unique user click performance'. Helps measure email campaign effectiveness in driving actions from distinct users, providing a cleaner view of actual user engagement without duplicate counting.
        expr: SUM(unique_email_clicks_1d) / NULLIF(NULLIF(NULLIF(SUM(email_sends), 0), 0), 0)
        access_modifier: public_access
      - name: UNIQUE_CLICKS_THROUGH_RATE_7D
        description: |-
          Calculates the unique click-through rate (UCTR) for 7-day period, measuring clicks as a percentage of sends. Use when questions ask about 'uctr', 'unique click through rate', 'immediate click performance', or 'campaign unique click rate'. Helps measure overall email campaign effectiveness in driving immediate user actions.

          Always use this by default when looking at unique click through rates for monthly performance, or performance of campaigns with a send event date of over a week ago
        expr: sum(unique_email_clicks_7d)/sum(email_sends)
        access_modifier: public_access
      - name: UNIQUE_MEMBERS_CONTACTED
        description: Calculates the count of distinct users contacted via email campaigns. Use when questions ask about 'member sends', 'contactable users', 'distinct members contacted', 'unique recipients', or 'audience reach'. Helps measure campaign audience size, user base engagement, and the breadth of email marketing reach across the member base.
        expr: COUNT(DISTINCT shiro_user_id)
        access_modifier: public_access
      - name: UNIQUE_OPEN_RATE_1D_ENHANCED
        description: Calculates the unique open rate for 1-day period with enhanced null handling, measuring unique email opens as a percentage of sends. Use when questions ask about 'unique open rate', 'distinct opens', 'how many unique users opened', or 'deduplicated email engagement'. Helps evaluate email campaign reach and user engagement quality by counting each recipient only once, regardless of multiple opens.
        expr: SUM(unique_email_opens_1d) / NULLIF(NULLIF(NULLIF(SUM(email_sends), 0), 0), 0)
        access_modifier: public_access
  - name: SE_CALENDAR
    description: The table contains records of calendar dates with associated time period classifications and comparative date indicators. Each record represents a single date and includes temporal attributes such as year, month, week, and day information, along with year-over-year comparison flags and year-to-date indicators.
    base_table:
      database: SE
      schema: DATA
      table: SE_CALENDAR
    dimensions:
      - name: DAY_NAME
        description: The name of the day of the week.
        expr: DAY_NAME
        data_type: VARCHAR(3)
        sample_values:
          - Fri
          - Thu
          - Sat
      - name: DAY_OF_MONTH
        description: The day of the month as a numeric value from 1 to 31.
        expr: DAY_OF_MONTH
        data_type: NUMBER(2,0)
        sample_values:
          - '29'
          - '1'
          - '2'
      - name: DAY_OF_WEEK
        description: The day of the week represented as a numeric value.
        expr: DAY_OF_WEEK
        data_type: NUMBER(2,0)
        sample_values:
          - '4'
          - '6'
          - '5'
      - name: MONTH_NAME
        description: The abbreviated name of the month.
        expr: MONTH_NAME
        data_type: VARCHAR(3)
        sample_values:
          - Jan
          - Mar
          - Feb
      - name: SE_WEEK
        description: |-
          The week number within the school year or academic calendar.

          When a query asks for a week, always give the se_week number as well as week_start date value
        expr: SE_WEEK
        data_type: NUMBER(2,0)
        sample_values:
          - '29'
          - '1'
          - '2'
      - name: SE_YEAR
        description: The year associated with the calendar entry.
        expr: SE_YEAR
        data_type: NUMBER(5,0)
        sample_values:
          - '1972'
          - '1971'
          - '1970'
      - name: YEAR
        description: The calendar year represented as a four-digit number.
        expr: YEAR
        data_type: NUMBER(4,0)
        sample_values:
          - '1972'
          - '1971'
          - '1970'
    time_dimensions:
      - name: DATE_VALUE
        description: Calendar dates used for scheduling and time-based operations.
        expr: DATE_VALUE
        data_type: DATE
        sample_values:
          - '1970-04-09'
          - '1970-01-30'
          - '1970-01-02'
      - name: WEEK_START
        description: The start date of each week.
        expr: WEEK_START
        data_type: DATE
        sample_values:
          - '1970-01-05'
          - '1970-06-22'
          - '1970-05-18'
    primary_key:
      columns:
        - DATE_VALUE
  - name: SE_TERRITORY
    description: The table contains records of sales territories with their operational configurations and settings. Each record includes territory identification, localization details, referral reward structures, affiliate program parameters, and marketing system integrations.
    base_table:
      database: SE
      schema: DATA
      table: SE_TERRITORY
    dimensions:
      - name: COUNTRY_NAME
        description: The name of the country within the sales territory.
        expr: COUNTRY_NAME
        data_type: VARCHAR(16777216)
        sample_values:
          - SE_TEMP
          - Ireland
          - Switzerland
      - name: NAME
        description: The name of the sales territory.
        expr: NAME
        data_type: VARCHAR(16777216)
        sample_values:
          - CZ
          - SE_TEMP
          - HK
    primary_key:
      columns:
        - NAME
  - name: SE_USER_ATTRIBUTES
    description: The table contains records of user attributes and their affiliate relationships. Each record includes geographic information and details about original, current, and main affiliate associations including territories, brands, and domains.
    base_table:
      database: SE
      schema: DATA
      table: SE_USER_ATTRIBUTES
    dimensions:
      - name: APP_PUSH_OPT_IN_STATUS
        description: The opt-in status for application push notifications.
        expr: APP_PUSH_OPT_IN_STATUS
        data_type: VARCHAR(16777216)
        sample_values:
          - opted in
          - opted out
      - name: EMAIL_OPT_IN_STATUS
        description: Email subscription opt-in status indicating whether the user has consented to receive email communications.
        expr: EMAIL_OPT_IN_STATUS
        data_type: VARCHAR(16777216)
        sample_values:
          - weekly
          - opted out
          - daily
      - name: HAS_APP_INSTALLED
        description: Indicates whether the user has the application installed.
        expr: HAS_APP_INSTALLED
        data_type: BOOLEAN
        sample_values:
          - 'TRUE'
          - 'FALSE'
      - name: IS_TEST_USER
        description: Indicates whether the user is designated as a test user.
        expr: IS_TEST_USER
        data_type: BOOLEAN
        sample_values:
          - 'TRUE'
          - 'FALSE'
      - name: MAIN_AFFILIATE_BRAND
        description: The primary affiliate brand associated with the user.
        expr: MAIN_AFFILIATE_BRAND
        data_type: VARCHAR(16777216)
        sample_values:
          - Travelist
          - LateLuxury.com
          - Secret Escapes
      - name: MEMBERSHIP_ACCOUNT_STATUS
        description: The status of a user's membership account.
        expr: MEMBERSHIP_ACCOUNT_STATUS
        data_type: VARCHAR(16777216)
        sample_values:
          - BLOCKED
          - DELETED
          - FULL_ACCOUNT
      - name: SHIRO_USER_ID
        description: Unique identifier for a user in the Apache Shiro security framework.
        expr: SHIRO_USER_ID
        data_type: NUMBER(38,0)
        sample_values:
          - '47630051'
          - '85337089'
          - '20349919'
    time_dimensions:
      - name: SIGNUP_TSTAMP
        description: The timestamp when the user signed up for the service.
        expr: SIGNUP_TSTAMP
        data_type: TIMESTAMP_NTZ(9)
        sample_values:
          - 2018-10-01T12:02:43.000+0000
          - 2013-12-14T05:46:50.000+0000
          - 2017-08-08T13:16:51.000+0000
    filters:
      - name: se_brand_users
        description: Always apply this filter to iterable_crm_reporting queries by left joining it to get main affiliate brand for the user_id in every row. The only time this cortext analyst should not apply this filter to a query is when the prompt specifically asks for all brands or another brand specifically like travelbird or pigsback.
        expr: main_affiliate_brand = 'Secret Escapes'
    primary_key:
      columns:
        - SHIRO_USER_ID
relationships:
  - name: ITERABLE_TO_COUNTRY_NAMES
    left_table: ITERABLE_CRM_REPORTING
    right_table: SE_TERRITORY
    relationship_columns:
      - left_column: CURRENT_AFFILIATE_TERRITORY
        right_column: NAME
  - name: ITERABLE_TO_SE_CALENDAR
    left_table: ITERABLE_CRM_REPORTING
    right_table: SE_CALENDAR
    relationship_columns:
      - left_column: SEND_EVENT_DATE
        right_column: DATE_VALUE
  - name: ITERABLE_TO_USER_ATTRIBUTES
    left_table: ITERABLE_CRM_REPORTING
    right_table: SE_USER_ATTRIBUTES
    relationship_columns:
      - left_column: SHIRO_USER_ID
        right_column: SHIRO_USER_ID
verified_queries:
  - name: '"How has email marketing performance in the UK and Germany evolved monthly since January 2023 in terms of member reach, engagement, bookings, and revenue?"'
    sql: |-
      SELECT
        DATE_TRUNC('MONTH', send_event_date) AS send_month,
        current_affiliate_territory,
        COUNT(DISTINCT icr.shiro_user_id) AS distinct_members_contacted,
        SUM(email_clicks_7d) AS total_clicks_7d,
        SUM(unique_email_clicks_7d) AS total_unique_clicks_7d,
        SUM(bookings_7d_lnd) AS total_bookings_lnd_7d,
        SUM(margin_gbp_7d_lnd) AS total_margin_lnd_7d
      FROM
        iterable_crm_reporting icr
      left join se_user_attributes sua
          on icr.shiro_user_id = sua.shiro_user_id
      WHERE
        crm_channel_type = 'email'
        AND current_affiliate_territory IN ('UK', 'DE')
        AND send_event_date >= '2023-01-01'
        and sua.main_affiliate_brand = 'Secret Escapes'
      GROUP BY
        1,
        2
    question: How has email marketing performance in the UK and Germany evolved monthly since January 2023 in terms of member reach, engagement, bookings, and revenue?
    verified_at: 1765460737
    verified_by: daisy anderson
    use_as_onboarding_question: false
  - name: '"What are today''s email campaign bookings by affiliate territory?"'
    sql: |-
      SELECT
        current_affiliate_territory,
        SUM(bookings_1d_lnd)
      FROM
        iterable_crm_reporting
      WHERE
        crm_channel_type = 'email'
        AND send_event_date = CURRENT_DATE
      GROUP BY
        1
    question: What are today's email campaign bookings by affiliate territory?
    verified_at: 1765453065
    verified_by: daisy anderson
    use_as_onboarding_question: false
  - name: '"How many email sends were delivered to core versus other territories for contacts without assigned affiliate territories over the past 30 days?"'
    sql: |-
      SELECT
        SPLIT_PART(combined_email_name, '_', 2) AS territory_from_email_name,
        CASE
          WHEN territory_from_email_name IN (
            'BE',
            'CH',
            'DE',
            'DK',
            'IE',
            'IT',
            'NL',
            'NO',
            'SE',
            'UK'
          ) THEN 'CORE'
          ELSE 'OTHER'
        END AS contact_group,
        SUM(icr.email_sends) AS total_sends
      FROM
        iterable_crm_reporting AS icr
      WHERE
        crm_channel_type = 'email'
        AND current_affiliate_territory IS NULL
        AND icr.send_event_date <= CURRENT_DATE
        AND icr.send_event_date >= DATEADD(DAY, 29 * -1, CURRENT_DATE)
        OR current_affiliate_territory = 'None'
      GROUP BY
        ALL
      ORDER BY
        2,
        1
    question: How many email sends were delivered to core versus other territories for contacts without assigned affiliate territories over the past 30 days?
    verified_at: 1765453104
    verified_by: daisy anderson
    use_as_onboarding_question: false
  - name: '"How have email campaign performance metrics including member reach, clicks, bookings, and revenue evolved monthly across UK and Germany markets since January 2023?"'
    sql: |-
      WITH sends AS (
        SELECT
          DATE_TRUNC('MONTH', send_event_date) AS send_month,
          current_affiliate_territory,
          COUNT(DISTINCT shiro_user_id) AS distinct_members_contacted,
          SUM(email_clicks_7d) AS total_clicks_7d,
          SUM(unique_email_clicks_7d) AS total_unique_clicks_7d,
          SUM(bookings_7d_lnd) AS total_bookings_lnd_7d,
          SUM(margin_gbp_7d_lnd) AS total_margin_lnd_7d
        FROM
          iterable_crm_reporting
        WHERE
          crm_channel_type = 'email'
          AND current_affiliate_territory IN ('UK', 'DE')
          AND send_event_date >= '2023-01-01'
        GROUP BY
          1,
          2
      )
      SELECT
        *
      FROM
        sends
    question: How have email campaign performance metrics including member reach, clicks, bookings, and revenue evolved monthly across UK and Germany markets since January 2023?
    verified_at: 1765453115
    verified_by: daisy anderson
    use_as_onboarding_question: false
  - name: '"What are the monthly email campaign performance metrics by user for UK and Germany since January 2023?"'
    sql: |-
      WITH sends AS (
        SELECT
          DATE_TRUNC('MONTH', send_event_date) AS send_month,
          icr.shiro_user_id,
          SUM(email_sends) AS total_sends,
          SUM(email_clicks_7d) AS total_clicks_7d,
          SUM(unique_email_clicks_7d) AS total_unique_clicks_7d,
          SUM(bookings_7d_lnd) AS total_bookings_lnd_7d,
          SUM(margin_gbp_7d_lnd) AS total_margin_lnd_7d
        FROM
          iterable_crm_reporting AS icr
        WHERE
          crm_channel_type = 'email'
          AND icr.current_affiliate_territory IN ('UK', 'DE')
          AND send_event_date >= '2023-01-01'
        GROUP BY
          1,
          2
      )
      SELECT
        *
      FROM
        sends
    question: What are the monthly email campaign performance metrics by user for UK and Germany since January 2023?
    verified_at: 1765453536
    verified_by: daisy anderson
    use_as_onboarding_question: false
  - name: '"How did ''in-app'' sends perform last week"'
    sql: |-
      SELECT
        SUM(icr.email_sends) AS total_sends,
        SUM(icr.email_opens_1d) / NULLIF(NULLIF(SUM(icr.email_sends), 0), 0) AS open_rate_1d,
        SUM(icr.email_clicks_1d) / NULLIF(NULLIF(SUM(icr.email_sends), 0), 0) AS click_through_rate_1d,
        SUM(icr.unique_email_opens_1d) / NULLIF(NULLIF(SUM(icr.email_sends), 0), 0) AS unique_open_rate_1d,
        SUM(icr.unique_email_clicks_1d) / NULLIF(NULLIF(SUM(icr.email_sends), 0), 0) AS unique_click_through_rate_1d
      FROM
        iterable_crm_reporting AS icr
      WHERE
        icr.crm_channel_type = 'in-app'
        AND icr.send_event_date >= DATE_TRUNC('WEEK', CURRENT_DATE - INTERVAL '1 WEEK')
        AND icr.send_event_date < DATE_TRUNC('WEEK', CURRENT_DATE)
    question: How did 'in-app' sends perform last week
    verified_at: 1765453663
    verified_by: daisy anderson
    use_as_onboarding_question: false
  - name: '"How did web push do last week, not push"'
    sql: |-
      SELECT
        SUM(icr.email_sends) AS total_sends,
        SUM(icr.email_opens_1d) / NULLIF(NULLIF(SUM(icr.email_sends), 0), 0) AS open_rate_1d,
        SUM(icr.email_clicks_1d) / NULLIF(NULLIF(SUM(icr.email_sends), 0), 0) AS click_through_rate_1d,
        SUM(icr.unique_email_opens_1d) / NULLIF(NULLIF(SUM(icr.email_sends), 0), 0) AS unique_open_rate_1d,
        SUM(icr.unique_email_clicks_1d) / NULLIF(NULLIF(SUM(icr.email_sends), 0), 0) AS unique_click_through_rate_1d
      FROM
        iterable_crm_reporting AS icr
      WHERE
        icr.crm_channel_type = 'web-push'
        AND icr.send_event_date >= DATE_TRUNC('WEEK', CURRENT_DATE - INTERVAL '1 WEEK')
        AND icr.send_event_date < DATE_TRUNC('WEEK', CURRENT_DATE)
    question: |
      How did web-push do last week
    verified_at: 1765453804
    verified_by: daisy anderson
    use_as_onboarding_question: false
  - name: '"what was the ctr for campaigns sent last week, can you split by campaign grou"'
    sql: |-
      SELECT
        case when lower(combined_email_name) like '%media%' then 'media'
              when lower(combined_email_name) like '%partner%' then 'partner'
              when (is_automated_campaign = true and combined_email_name not like 'AMN%')     then lower(ame_calculated_campaign_name)
              else lower(mapped_platform)
          end as campaign_group,
        SUM(icr.email_clicks_1d) / NULLIF(NULLIF(SUM(icr.email_sends), 0), 0) AS click_through_rate_1d
      FROM
        iterable_crm_reporting AS icr
      WHERE
        icr.crm_channel_type = 'email'
        AND NOT LOWER(icr.combined_email_name) LIKE '%partner%'
        AND NOT LOWER(icr.combined_email_name) LIKE '%media%'
        AND icr.send_event_date >= DATE_TRUNC('WEEK', CURRENT_DATE - INTERVAL '1 WEEK')
        AND icr.send_event_date < DATE_TRUNC('WEEK', CURRENT_DATE)
      GROUP BY
        1
      ORDER BY
        click_through_rate_1d DESC NULLS LAST
    question: what was the ctr for campaigns sent last week, can you split by campaign group
    verified_at: 1765455419
    verified_by: daisy anderson
    use_as_onboarding_question: false
  - name: '"what email campaigns were sent yesterday"'
    sql: |-
      SELECT
        case when lower(combined_email_name) like '%media%' then 'media'
              when lower(combined_email_name) like '%partner%' then 'partner'
              when (is_automated_campaign = true and email_type <> 'Newsletter') then lower(ame_calculated_campaign_name)
              else lower(mapped_platform)
          end as campaign_group,
        SUM(icr.email_sends) AS total_sends
      FROM
        iterable_crm_reporting AS icr
      WHERE
        icr.crm_channel_type = 'email'
        AND icr.send_event_date = CURRENT_DATE - INTERVAL '1 DAY'
      GROUP BY
        1
      ORDER BY
        total_sends DESC NULLS LAST
    question: what email campaigns were sent yesterday
    verified_at: 1765455721
    verified_by: daisy anderson
    use_as_onboarding_question: false
  - name: '"How did push do yesterday?"'
    sql: |-
      SELECT
        SUM(icr.email_sends) AS total_sends,
        SUM(icr.email_opens_1d) / NULLIF(NULLIF(SUM(icr.email_sends), 0), 0) AS open_rate_1d,
        SUM(icr.email_clicks_1d) / NULLIF(NULLIF(SUM(icr.email_sends), 0), 0) AS click_through_rate_1d,
        SUM(icr.unique_email_opens_1d) / NULLIF(NULLIF(SUM(icr.email_sends), 0), 0) AS unique_open_rate_1d,
        SUM(icr.unique_email_clicks_1d) / NULLIF(NULLIF(SUM(icr.email_sends), 0), 0) AS unique_click_through_rate_1d
      FROM
        iterable_crm_reporting AS icr
      WHERE
        icr.crm_channel_type = 'app'
        AND icr.send_event_date = CURRENT_DATE - INTERVAL '1 DAY'
    question: How did push do yesterday?
    verified_at: 1765456028
    verified_by: daisy anderson
    use_as_onboarding_question: false
  - name: '"How did push do last week? "'
    sql: |-
      SELECT
        SUM(icr.email_sends) AS total_sends,
        SUM(icr.email_opens_1d) / NULLIF(NULLIF(NULLIF(SUM(icr.email_sends), 0), 0), 0) AS open_rate_1d,
        SUM(icr.email_clicks_1d) / NULLIF(NULLIF(NULLIF(SUM(icr.email_sends), 0), 0), 0) AS click_through_rate_1d,
        SUM(icr.unique_email_opens_1d) / NULLIF(NULLIF(NULLIF(SUM(icr.email_sends), 0), 0), 0) AS unique_open_rate_1d,
        SUM(icr.unique_email_clicks_1d) / NULLIF(NULLIF(NULLIF(SUM(icr.email_sends), 0), 0), 0) AS unique_click_through_rate_1d
      FROM
        iterable_crm_reporting AS icr
      WHERE
        icr.crm_channel_type = 'app'
        AND icr.send_event_date >= DATE_TRUNC('WEEK', CURRENT_DATE - INTERVAL '1 WEEK')
        AND icr.send_event_date < DATE_TRUNC('WEEK', CURRENT_DATE)
    question: 'How did push do last week? '
    verified_at: 1765456125
    verified_by: daisy anderson
    use_as_onboarding_question: false
  - name: '"Can you compare performance by email type, for the last week compared to the same se_week last year?"'
    sql: |-
      WITH last_week_data AS (
        SELECT
          icr.email_type,
          SUM(icr.email_sends) AS email_sends,
          SUM(icr.email_opens_1d) AS email_opens_1d,
          SUM(icr.email_clicks_1d) AS email_clicks_1d,
          SUM(icr.bookings_1d_lnd) AS bookings_1d_lnd
        FROM
          iterable_crm_reporting AS icr
          LEFT OUTER JOIN se_calendar AS cal ON icr.send_event_date = cal.date_value
        WHERE
          icr.crm_channel_type = 'email'
          AND NOT LOWER(icr.combined_email_name) LIKE '%partner%'
          AND NOT LOWER(icr.combined_email_name) LIKE '%media%'
          AND icr.send_event_date >= DATE_TRUNC('WEEK', CURRENT_DATE - INTERVAL '1 WEEK')
          AND icr.send_event_date < DATE_TRUNC('WEEK', CURRENT_DATE)
        GROUP BY
          icr.email_type
      ),
      prev_year_data AS (
        SELECT
          icr.email_type,
          SUM(icr.email_sends) AS email_sends,
          SUM(icr.email_opens_1d) AS email_opens_1d,
          SUM(icr.email_clicks_1d) AS email_clicks_1d,
          SUM(icr.bookings_1d_lnd) AS bookings_1d_lnd
        FROM
          iterable_crm_reporting AS icr
          LEFT OUTER JOIN se_calendar AS cal ON icr.send_event_date = cal.date_value
        WHERE
          icr.crm_channel_type = 'email'
          AND NOT LOWER(icr.combined_email_name) LIKE '%partner%'
          AND NOT LOWER(icr.combined_email_name) LIKE '%media%'
          AND cal.se_week = (
            SELECT
              DISTINCT cal2.se_week
            FROM
              se_calendar AS cal2
            WHERE
              cal2.date_value >= DATE_TRUNC('WEEK', CURRENT_DATE - INTERVAL '1 WEEK')
              AND cal2.date_value < DATE_TRUNC('WEEK', CURRENT_DATE)
            LIMIT
              1
          )
          AND cal.se_year = (
            SELECT
              DISTINCT cal2.se_year
            FROM
              se_calendar AS cal2
            WHERE
              cal2.date_value >= DATE_TRUNC('WEEK', CURRENT_DATE - INTERVAL '1 WEEK')
              AND cal2.date_value < DATE_TRUNC('WEEK', CURRENT_DATE)
            LIMIT
              1
          ) - 1
        GROUP BY
          icr.email_type
      )
      SELECT
        COALESCE(curr.email_type, prev.email_type) AS email_type,
        curr.email_sends AS curr_email_sends,
        prev.email_sends AS prev_email_sends,
        curr.email_sends - prev.email_sends AS sends_yoy_chg,
        CASE
          WHEN prev.email_sends <> 0 THEN (curr.email_sends - prev.email_sends) / NULLIF(prev.email_sends, 0)
        END AS sends_yoy_pct_chg,
        curr.email_opens_1d / NULLIF(NULLIF(curr.email_sends, 0), 0) AS curr_open_rate_1d,
        prev.email_opens_1d / NULLIF(NULLIF(prev.email_sends, 0), 0) AS prev_open_rate_1d,
        (
          curr.email_opens_1d / NULLIF(NULLIF(curr.email_sends, 0), 0)
        ) - (
          prev.email_opens_1d / NULLIF(NULLIF(prev.email_sends, 0), 0)
        ) AS open_rate_yoy_chg,
        CASE
          WHEN (
            prev.email_opens_1d / NULLIF(NULLIF(prev.email_sends, 0), 0)
          ) <> 0 THEN (
            (
              curr.email_opens_1d / NULLIF(NULLIF(curr.email_sends, 0), 0)
            ) - (
              prev.email_opens_1d / NULLIF(NULLIF(prev.email_sends, 0), 0)
            )
          ) / NULLIF(
            (
              prev.email_opens_1d / NULLIF(NULLIF(prev.email_sends, 0), 0)
            ),
            0
          )
        END AS open_rate_yoy_pct_chg,
        curr.email_clicks_1d / NULLIF(NULLIF(curr.email_sends, 0), 0) AS curr_ctr_1d,
        prev.email_clicks_1d / NULLIF(NULLIF(prev.email_sends, 0), 0) AS prev_ctr_1d,
        (
          curr.email_clicks_1d / NULLIF(NULLIF(curr.email_sends, 0), 0)
        ) - (
          prev.email_clicks_1d / NULLIF(NULLIF(prev.email_sends, 0), 0)
        ) AS ctr_yoy_chg,
        CASE
          WHEN (
            prev.email_clicks_1d / NULLIF(NULLIF(prev.email_sends, 0), 0)
          ) <> 0 THEN (
            (
              curr.email_clicks_1d / NULLIF(NULLIF(curr.email_sends, 0), 0)
            ) - (
              prev.email_clicks_1d / NULLIF(NULLIF(prev.email_sends, 0), 0)
            )
          ) / NULLIF(
            (
              prev.email_clicks_1d / NULLIF(NULLIF(prev.email_sends, 0), 0)
            ),
            0
          )
        END AS ctr_yoy_pct_chg,
        curr.bookings_1d_lnd / NULLIF(NULLIF(curr.email_clicks_1d, 0), 0) AS curr_conversion_rate_1d,
        prev.bookings_1d_lnd / NULLIF(NULLIF(prev.email_clicks_1d, 0), 0) AS prev_conversion_rate_1d,
        (
          curr.bookings_1d_lnd / NULLIF(NULLIF(curr.email_clicks_1d, 0), 0)
        ) - (
          prev.bookings_1d_lnd / NULLIF(NULLIF(prev.email_clicks_1d, 0), 0)
        ) AS conversion_rate_yoy_chg,
        CASE
          WHEN (
            prev.bookings_1d_lnd / NULLIF(NULLIF(prev.email_clicks_1d, 0), 0)
          ) <> 0 THEN (
            (
              curr.bookings_1d_lnd / NULLIF(NULLIF(curr.email_clicks_1d, 0), 0)
            ) - (
              prev.bookings_1d_lnd / NULLIF(NULLIF(prev.email_clicks_1d, 0), 0)
            )
          ) / NULLIF(
            (
              prev.bookings_1d_lnd / NULLIF(NULLIF(prev.email_clicks_1d, 0), 0)
            ),
            0
          )
        END AS conversion_rate_yoy_pct_chg
      FROM
        last_week_data AS curr FULL
        OUTER JOIN prev_year_data AS prev ON curr.email_type = prev.email_type
      ORDER BY
        curr_email_sends DESC NULLS LAST
    question: |
      Can you compare YoY performance by email type, for last week? - using the same se_week in the previous year as the comparison period
    verified_at: 1765458458
    verified_by: daisy anderson
    use_as_onboarding_question: false
  - name: '"Can you split campaign groups sent last week?"'
    sql: |-
      SELECT
        CASE
          WHEN LOWER(combined_email_name) LIKE '%media%' THEN 'media'
          WHEN LOWER(combined_email_name) LIKE '%partner%' THEN 'partner'
          WHEN (
            is_automated_campaign = TRUE
            and email_type <> 'Newsletter'
          ) THEN LOWER(ame_calculated_campaign_name)
          ELSE LOWER(mapped_platform)
        END AS campaign_group,
        SUM(icr.email_sends) AS total_sends
      FROM
        iterable_crm_reporting AS icr
      WHERE
        icr.crm_channel_type = 'email'
        AND icr.send_event_date >= DATE_TRUNC('WEEK', CURRENT_DATE - INTERVAL '1 WEEK')
        AND icr.send_event_date < DATE_TRUNC('WEEK', CURRENT_DATE)
      GROUP BY
        1
      ORDER BY
        total_sends DESC NULLS LAST
    question: Can you split campaign groups sent last week?
    verified_at: 1765532139
    verified_by: daisy anderson
    use_as_onboarding_question: false
  - name: '"What campaigns did we send via push last week?"'
    sql: |-
      SELECT
        CASE
          WHEN LOWER(combined_email_name) LIKE '%media%' THEN 'media'
          WHEN LOWER(combined_email_name) LIKE '%partner%' THEN 'partner'
          WHEN (
            is_automated_campaign = TRUE
            AND email_type <> 'Newsletter'
          ) THEN LOWER(ame_calculated_campaign_name)
          ELSE LOWER(mapped_platform)
        END AS campaign_group,
        SUM(icr.email_sends) AS total_sends
      FROM
        iterable_crm_reporting AS icr
      WHERE
        icr.crm_channel_type = 'app'
        AND icr.send_event_date >= DATE_TRUNC('WEEK', CURRENT_DATE - INTERVAL '1 WEEK')
        AND icr.send_event_date < DATE_TRUNC('WEEK', CURRENT_DATE)
      GROUP BY
        1
      ORDER BY
        total_sends DESC NULLS LAST
    question: What campaigns did we send via push last week?
    verified_at: 1765532191
    verified_by: daisy anderson
    use_as_onboarding_question: false
  - name: '"Can you compare promo performance in nov 2025 to the previous year"'
    sql: |-
      SELECT
          sum(case when date_trunc(month, send_event_date) = '2025-11-01' then email_sends else null end)  AS sends_2025,
          sum(case when date_trunc(month, send_event_date) = '2024-11-01' then email_sends else null end)  AS sends_2024,
          sum(case when date_trunc(month, send_event_date) = '2025-11-01' then email_clicks_7d else null end)  AS clicks_2025,
          sum(case when date_trunc(month, send_event_date) = '2024-11-01' then email_clicks_7d else null end)  AS clicks_2024,
          clicks_2025/sends_2025 as ctr_2025,
          clicks_2024/sends_2024 as ctr_2024,
          (ctr_2025 - ctr_2024) / NULLIF(NULLIF(ctr_2024, 0), 0) AS ctr_percentage_change
      FROM se.data.iterable_crm_reporting 
      where 1=1
      AND crm_channel_type = 'email'
      AND LOWER(combined_email_name) not LIKE '%partner%'
      AND NOT LOWER(combined_email_name) LIKE '%media%'
      AND LOWER( CASE WHEN (is_automated_campaign = TRUE AND email_type <> 'Newsletter') THEN  LOWER(ame_calculated_campaign_name)
                      ELSE LOWER(mapped_platform)
                  END) LIKE '%promo%'
      AND date_trunc(month, send_event_date) in ('2024-11-01','2025-11-01')
    question: Can you compare promo performance in nov 2025 to the previous year
    verified_at: 1765536547
    verified_by: daisy anderson
    use_as_onboarding_question: false
  - name: '"Can you compare performance for kronos sends in nov and oct this year"'
    sql: |-
      SELECT
        'November 2025' AS month_period,
        SUM(icr.email_sends) AS total_sends,
        SUM(icr.email_clicks_7d) / NULLIF(NULLIF(SUM(icr.email_sends), 0), 0) AS click_through_rate_7d,
        SUM(icr.email_opens_7d) / NULLIF(NULLIF(SUM(icr.email_sends), 0), 0) AS open_rate_7d,
        SUM(icr.bookings_7d_lnd) AS total_bookings,
        SUM(icr.margin_gbp_7d_lnd) AS total_margin
      FROM
        iterable_crm_reporting AS icr
        LEFT OUTER JOIN se_user_attributes AS sua ON icr.shiro_user_id = sua.shiro_user_id
      WHERE
        icr.crm_channel_type = 'email'
        AND NOT LOWER(icr.combined_email_name) LIKE '%partner%'
        AND NOT LOWER(icr.combined_email_name) LIKE '%media%'
        AND sua.main_affiliate_brand = 'Secret Escapes'
        AND LOWER(
          CASE
            WHEN (
              icr.is_automated_campaign = TRUE
              AND icr.email_type <> 'Newsletter'
            ) THEN LOWER(icr.ame_calculated_campaign_name)
            ELSE LOWER(icr.mapped_platform)
          END
        ) = 'kronos'
        AND DATE_TRUNC('MONTH', icr.send_event_date) = '2025-11-01'
      UNION ALL
      SELECT
        'October 2025' AS month_period,
        SUM(icr.email_sends) AS total_sends,
        SUM(icr.email_clicks_7d) / NULLIF(NULLIF(SUM(icr.email_sends), 0), 0) AS click_through_rate_7d,
        SUM(icr.email_opens_7d) / NULLIF(NULLIF(SUM(icr.email_sends), 0), 0) AS open_rate_7d,
        SUM(icr.bookings_7d_lnd) AS total_bookings,
        SUM(icr.margin_gbp_7d_lnd) AS total_margin
      FROM
        iterable_crm_reporting AS icr
        LEFT OUTER JOIN se_user_attributes AS sua ON icr.shiro_user_id = sua.shiro_user_id
      WHERE
        icr.crm_channel_type = 'email'
        AND NOT LOWER(icr.combined_email_name) LIKE '%partner%'
        AND NOT LOWER(icr.combined_email_name) LIKE '%media%'
        AND sua.main_affiliate_brand = 'Secret Escapes'
        AND LOWER(
          CASE
            WHEN (
              icr.is_automated_campaign = TRUE
              AND icr.email_type <> 'Newsletter'
            ) THEN LOWER(icr.ame_calculated_campaign_name)
            ELSE LOWER(icr.mapped_platform)
          END
        ) = 'kronos'
        AND DATE_TRUNC('MONTH', icr.send_event_date) = '2025-10-01'
      ORDER BY
        month_period DESC NULLS LAST
    question: Can you compare performance for kronos sends in nov and oct this year, using the campaign group to filter for kronos
    verified_at: 1765536864
    verified_by: daisy anderson
    use_as_onboarding_question: false
  - name: '"How did push do last week"'
    sql: |-
      SELECT
        SUM(icr.email_sends) AS total_sends,
        SUM(icr.email_opens_1d) / NULLIF(NULLIF(SUM(icr.email_sends), 0), 0) AS open_rate_1d,
        SUM(icr.email_clicks_1d) / NULLIF(NULLIF(SUM(icr.email_sends), 0), 0) AS click_through_rate_1d,
        SUM(icr.unique_email_opens_1d) / NULLIF(NULLIF(SUM(icr.email_sends), 0), 0) AS unique_open_rate_1d,
        SUM(icr.unique_email_clicks_1d) / NULLIF(NULLIF(SUM(icr.email_sends), 0), 0) AS unique_click_through_rate_1d
      FROM
        iterable_crm_reporting AS icr
        LEFT OUTER JOIN se_user_attributes AS sua ON icr.shiro_user_id = sua.shiro_user_id
      WHERE
        icr.crm_channel_type = 'app'
        AND sua.main_affiliate_brand = 'Secret Escapes'
        AND icr.send_event_date >= DATE_TRUNC('WEEK', CURRENT_DATE - INTERVAL '1 WEEK')
        AND icr.send_event_date < DATE_TRUNC('WEEK', CURRENT_DATE)
    question: How did push do last week
    verified_at: 1765536918
    verified_by: daisy anderson
    use_as_onboarding_question: false
  - name: '"Can you compare email performance last week to the same se week last year"'
    sql: |-
      WITH last_week_data AS (
        SELECT
          SUM(icr.email_sends) AS email_sends,
          SUM(icr.email_opens_1d) AS email_opens_1d,
          SUM(icr.email_clicks_1d) AS email_clicks_1d,
          SUM(icr.bookings_1d_lnd) AS bookings_1d_lnd
        FROM
          iterable_crm_reporting AS icr
          LEFT OUTER JOIN se_calendar AS cal ON icr.send_event_date = cal.date_value
          LEFT OUTER JOIN se_user_attributes AS sua ON icr.shiro_user_id = sua.shiro_user_id
        WHERE
          icr.crm_channel_type = 'email'
          AND NOT LOWER(icr.combined_email_name) LIKE '%partner%'
          AND NOT LOWER(icr.combined_email_name) LIKE '%media%'
          AND sua.main_affiliate_brand = 'Secret Escapes'
          AND icr.send_event_date >= DATE_TRUNC('WEEK', CURRENT_DATE - INTERVAL '1 WEEK')
          AND icr.send_event_date < DATE_TRUNC('WEEK', CURRENT_DATE)
      ),
      prev_year_data AS (
        SELECT
          SUM(icr.email_sends) AS email_sends,
          SUM(icr.email_opens_1d) AS email_opens_1d,
          SUM(icr.email_clicks_1d) AS email_clicks_1d,
          SUM(icr.bookings_1d_lnd) AS bookings_1d_lnd
        FROM
          iterable_crm_reporting AS icr
          LEFT OUTER JOIN se_calendar AS cal ON icr.send_event_date = cal.date_value
          LEFT OUTER JOIN se_user_attributes AS sua ON icr.shiro_user_id = sua.shiro_user_id
        WHERE
          icr.crm_channel_type = 'email'
          AND NOT LOWER(icr.combined_email_name) LIKE '%partner%'
          AND NOT LOWER(icr.combined_email_name) LIKE '%media%'
          AND sua.main_affiliate_brand = 'Secret Escapes'
          AND cal.se_week = (
            SELECT
              DISTINCT cal2.se_week
            FROM
              se_calendar AS cal2
            WHERE
              cal2.date_value >= DATE_TRUNC('WEEK', CURRENT_DATE - INTERVAL '1 WEEK')
              AND cal2.date_value < DATE_TRUNC('WEEK', CURRENT_DATE)
            LIMIT
              1
          )
          AND cal.se_year = (
            SELECT
              DISTINCT cal2.se_year
            FROM
              se_calendar AS cal2
            WHERE
              cal2.date_value >= DATE_TRUNC('WEEK', CURRENT_DATE - INTERVAL '1 WEEK')
              AND cal2.date_value < DATE_TRUNC('WEEK', CURRENT_DATE)
            LIMIT
              1
          ) - 1
      )
      SELECT
        curr.email_sends AS curr_email_sends,
        prev.email_sends AS prev_email_sends,
        curr.email_sends - prev.email_sends AS sends_yoy_chg,
        CASE
          WHEN prev.email_sends <> 0 THEN (curr.email_sends - prev.email_sends) / NULLIF(NULLIF(prev.email_sends, 0), 0)
        END AS sends_yoy_pct_chg,
        curr.email_opens_1d / NULLIF(NULLIF(curr.email_sends, 0), 0) AS curr_open_rate_1d,
        prev.email_opens_1d / NULLIF(NULLIF(prev.email_sends, 0), 0) AS prev_open_rate_1d,
        (
          curr.email_opens_1d / NULLIF(NULLIF(curr.email_sends, 0), 0)
        ) - (
          prev.email_opens_1d / NULLIF(NULLIF(prev.email_sends, 0), 0)
        ) AS open_rate_yoy_chg,
        CASE
          WHEN (
            prev.email_opens_1d / NULLIF(NULLIF(prev.email_sends, 0), 0)
          ) <> 0 THEN (
            (
              curr.email_opens_1d / NULLIF(NULLIF(curr.email_sends, 0), 0)
            ) - (
              prev.email_opens_1d / NULLIF(NULLIF(prev.email_sends, 0), 0)
            )
          ) / NULLIF(
            NULLIF(
              (
                prev.email_opens_1d / NULLIF(NULLIF(prev.email_sends, 0), 0)
              ),
              0
            ),
            0
          )
        END AS open_rate_yoy_pct_chg,
        curr.email_clicks_1d / NULLIF(NULLIF(curr.email_sends, 0), 0) AS curr_ctr_1d,
        prev.email_clicks_1d / NULLIF(NULLIF(prev.email_sends, 0), 0) AS prev_ctr_1d,
        (
          curr.email_clicks_1d / NULLIF(NULLIF(curr.email_sends, 0), 0)
        ) - (
          prev.email_clicks_1d / NULLIF(NULLIF(prev.email_sends, 0), 0)
        ) AS ctr_yoy_chg,
        CASE
          WHEN (
            prev.email_clicks_1d / NULLIF(NULLIF(prev.email_sends, 0), 0)
          ) <> 0 THEN (
            (
              curr.email_clicks_1d / NULLIF(NULLIF(curr.email_sends, 0), 0)
            ) - (
              prev.email_clicks_1d / NULLIF(NULLIF(prev.email_sends, 0), 0)
            )
          ) / NULLIF(
            NULLIF(
              (
                prev.email_clicks_1d / NULLIF(NULLIF(prev.email_sends, 0), 0)
              ),
              0
            ),
            0
          )
        END AS ctr_yoy_pct_chg,
        curr.bookings_1d_lnd / NULLIF(NULLIF(curr.email_clicks_1d, 0), 0) AS curr_conversion_rate_1d,
        prev.bookings_1d_lnd / NULLIF(NULLIF(prev.email_clicks_1d, 0), 0) AS prev_conversion_rate_1d,
        (
          curr.bookings_1d_lnd / NULLIF(NULLIF(curr.email_clicks_1d, 0), 0)
        ) - (
          prev.bookings_1d_lnd / NULLIF(NULLIF(prev.email_clicks_1d, 0), 0)
        ) AS conversion_rate_yoy_chg,
        CASE
          WHEN (
            prev.bookings_1d_lnd / NULLIF(NULLIF(prev.email_clicks_1d, 0), 0)
          ) <> 0 THEN (
            (
              curr.bookings_1d_lnd / NULLIF(NULLIF(curr.email_clicks_1d, 0), 0)
            ) - (
              prev.bookings_1d_lnd / NULLIF(NULLIF(prev.email_clicks_1d, 0), 0)
            )
          ) / NULLIF(
            NULLIF(
              (
                prev.bookings_1d_lnd / NULLIF(NULLIF(prev.email_clicks_1d, 0), 0)
              ),
              0
            ),
            0
          )
        END AS conversion_rate_yoy_pct_chg
      FROM
        last_week_data AS curr
        CROSS JOIN prev_year_data AS prev
    question: Can you compare email performance last week to the same week last year
    verified_at: 1765537054
    verified_by: daisy anderson
    use_as_onboarding_question: false
  - name: '"What was the week number last week"'
    sql: |-
      SELECT
        DISTINCT sc.se_week AS week_number
      FROM
        se_calendar AS sc
      WHERE
        sc.date_value >= DATE_TRUNC('WEEK', CURRENT_DATE - INTERVAL '1 WEEK')
        AND sc.date_value < DATE_TRUNC('WEEK', CURRENT_DATE)
    question: What was the week number last week
    verified_at: 1765537412
    verified_by: daisy anderson
    use_as_onboarding_question: false
  - name: '"What has been the strongest week for clicks this year, accross each of the crm types & what campaign made the biggest contribution"'
    sql: |-
      WITH weekly_ctr AS (
        SELECT
          sc.se_week,
          sc.week_start,
          icr.crm_channel_type,
          SUM(icr.email_clicks_1d) / NULLIF(NULLIF(SUM(icr.email_sends), 0), 0) AS click_through_rate_1d
        FROM
          iterable_crm_reporting AS icr
          LEFT OUTER JOIN se_calendar AS sc ON icr.send_event_date = sc.date_value
          LEFT OUTER JOIN se_user_attributes AS sua ON icr.shiro_user_id = sua.shiro_user_id
        WHERE
          sc.year = 2025
          AND sua.main_affiliate_brand = 'Secret Escapes'
        GROUP BY
          sc.se_week,
          sc.week_start,
          icr.crm_channel_type
      ),
      best_weeks AS (
        SELECT
          crm_channel_type,
          se_week,
          week_start,
          click_through_rate_1d,
          ROW_NUMBER() OVER (
            PARTITION BY crm_channel_type
            ORDER BY
              click_through_rate_1d DESC NULLS LAST
          ) AS rn
        FROM
          weekly_ctr
      ),
      campaign_contributions AS (
        SELECT
          icr.crm_channel_type,
          sc.se_week,
          icr.combined_email_name,
          SUM(icr.email_clicks_1d) AS campaign_clicks,
          SUM(icr.email_sends) AS campaign_sends,
          SUM(icr.email_clicks_1d) / NULLIF(NULLIF(SUM(icr.email_sends), 0), 0) AS campaign_ctr
        FROM
          iterable_crm_reporting AS icr
          LEFT OUTER JOIN se_calendar AS sc ON icr.send_event_date = sc.date_value
          LEFT OUTER JOIN se_user_attributes AS sua ON icr.shiro_user_id = sua.shiro_user_id
        WHERE
          sc.year = 2025
          AND sua.main_affiliate_brand = 'Secret Escapes'
        GROUP BY
          icr.crm_channel_type,
          sc.se_week,
          icr.combined_email_name
      ),
      top_campaigns AS (
        SELECT
          crm_channel_type,
          se_week,
          combined_email_name,
          campaign_clicks,
          campaign_sends,
          campaign_ctr,
          ROW_NUMBER() OVER (
            PARTITION BY crm_channel_type,
            se_week
            ORDER BY
              campaign_clicks DESC NULLS LAST
          ) AS campaign_rn
        FROM
          campaign_contributions
      )
      SELECT
        bw.crm_channel_type,
        bw.se_week,
        bw.week_start,
        bw.click_through_rate_1d AS best_week_ctr,
        tc.combined_email_name AS top_contributing_campaign,
        tc.campaign_clicks,
        tc.campaign_sends,
        tc.campaign_ctr
      FROM
        best_weeks AS bw
        LEFT OUTER JOIN top_campaigns AS tc ON bw.crm_channel_type = tc.crm_channel_type
        AND bw.se_week = tc.se_week
        AND tc.campaign_rn = 1
      WHERE
        bw.rn = 1
      ORDER BY
        bw.click_through_rate_1d DESC NULLS LAST
    question: What has been the strongest week for ctr this year, across each of the crm types & what campaign made the biggest contribution
    verified_at: 1765539235
    verified_by: daisy anderson
    use_as_onboarding_question: false
  - name: '"Which email campaigns had the highest volume yesterday and what are their key characteristics?"'
    sql: |-
      SELECT
        CASE
          WHEN LOWER(icr.combined_email_name) LIKE '%media%' THEN 'media'
          WHEN LOWER(icr.combined_email_name) LIKE '%partner%' THEN 'partner'
          WHEN (
            icr.is_automated_campaign = TRUE
            AND icr.email_type <> 'Newsletter'
          ) THEN LOWER(icr.ame_calculated_campaign_name)
          ELSE LOWER(icr.mapped_platform)
        END AS campaign_group,
        SUM(icr.email_sends) AS total_sends,
        SUM(icr.email_opens_1d) / NULLIF(NULLIF(SUM(icr.email_sends), 0), 0) AS open_rate_1d,
        SUM(icr.email_clicks_1d) / NULLIF(NULLIF(SUM(icr.email_sends), 0), 0) AS click_through_rate_1d,
        SUM(icr.email_clicks_1d) / NULLIF(NULLIF(SUM(icr.email_opens_1d), 0), 0) AS click_to_open_rate_1d,
        SUM(icr.bookings_1d_lnd) / NULLIF(NULLIF(SUM(icr.email_clicks_1d), 0), 0) AS conversion_rate_1d,
        SUM(icr.margin_gbp_1d_lnd) / NULLIF(NULLIF(SUM(icr.bookings_1d_lnd), 0), 0) AS margin_per_booking_1d,
        COUNT(DISTINCT icr.shiro_user_id) AS unique_members_contacted
      FROM
        iterable_crm_reporting AS icr
        LEFT OUTER JOIN se_user_attributes AS sua ON icr.shiro_user_id = sua.shiro_user_id
      WHERE
        icr.crm_channel_type = 'email'
        AND icr.send_event_date = CURRENT_DATE - INTERVAL '1 DAY'
        AND sua.main_affiliate_brand = 'Secret Escapes'
      GROUP BY
        1
      ORDER BY
        total_sends DESC NULLS LAST
    question: Which email campaigns, using campaign groupings, had the highest volume yesterday and what are their key characteristics?
    verified_at: 1765539365
    verified_by: daisy anderson
    use_as_onboarding_question: false
  - name: '"How many email campaigns were sent last week excluding partner and media campaigns?"'
    sql: |-
      SELECT
        SUM(icr.email_sends) AS total_sends
      FROM
        iterable_crm_reporting AS icr
        LEFT OUTER JOIN se_user_attributes AS sua ON icr.shiro_user_id = sua.shiro_user_id
      WHERE
        icr.crm_channel_type = 'email'
        AND NOT LOWER(icr.combined_email_name) LIKE '%partner%'
        AND NOT LOWER(icr.combined_email_name) LIKE '%media%'
        AND sua.main_affiliate_brand = 'Secret Escapes'
        AND icr.send_event_date >= DATE_TRUNC('WEEK', CURRENT_DATE - INTERVAL '1 WEEK')
        AND icr.send_event_date < DATE_TRUNC('WEEK', CURRENT_DATE)
    question: How many emails were sent last week ?
    verified_at: 1765540473
    verified_by: daisy anderson
    use_as_onboarding_question: false
  - name: '"Which week had the highest click volume for each CRM channel this year and what was the top performing campaign during that peak week?"'
    sql: |-
      WITH weekly_clicks AS (
        SELECT
          DATE_TRUNC('WEEK', icr.send_event_date) AS week_start,
          icr.crm_channel_type,
          SUM(icr.email_clicks_1d) AS total_clicks
        FROM
          iterable_crm_reporting AS icr
          LEFT OUTER JOIN se_user_attributes AS sua ON icr.shiro_user_id = sua.shiro_user_id
        WHERE
          icr.send_event_date >= DATE_TRUNC('YEAR', CURRENT_DATE)
          AND sua.main_affiliate_brand = 'Secret Escapes'
        GROUP BY
          1,
          2
      ),
      best_weeks AS (
        SELECT
          crm_channel_type,
          week_start,
          total_clicks,
          ROW_NUMBER() OVER (
            PARTITION BY crm_channel_type
            ORDER BY
              total_clicks DESC NULLS LAST
          ) AS rn
        FROM
          weekly_clicks
      ),
      top_campaigns AS (
        SELECT
          bw.crm_channel_type,
          bw.week_start,
          bw.total_clicks AS week_total_clicks,
          icr.combined_email_name,
          SUM(icr.email_clicks_1d) AS campaign_clicks,
          ROW_NUMBER() OVER (
            PARTITION BY bw.crm_channel_type
            ORDER BY
              SUM(icr.email_clicks_1d) DESC NULLS LAST
          ) AS campaign_rn
        FROM
          best_weeks AS bw
          JOIN iterable_crm_reporting AS icr ON bw.crm_channel_type = icr.crm_channel_type
          AND bw.week_start = DATE_TRUNC('WEEK', icr.send_event_date)
          LEFT OUTER JOIN se_user_attributes AS sua ON icr.shiro_user_id = sua.shiro_user_id
        WHERE
          bw.rn = 1
          AND sua.main_affiliate_brand = 'Secret Escapes'
        GROUP BY
          1,
          2,
          3,
          4
      )
      SELECT
        crm_channel_type,
        week_start,
        week_total_clicks,
        combined_email_name AS top_campaign,
        campaign_clicks
      FROM
        top_campaigns
      WHERE
        campaign_rn = 1
      ORDER BY
        week_total_clicks DESC NULLS LAST
    question: Which week had the highest click volume for each CRM channel this year and what was the top performing campaign during that peak week?
    verified_at: 1765972768
    verified_by: daisy anderson
    use_as_onboarding_question: false
  - name: '"What was the strongest performing campaign per crm channel yesterday?"'
    sql: |-
      WITH campaign_performance AS (
        SELECT
          icr.crm_channel_type,
          CASE
            WHEN (
              icr.is_automated_campaign = TRUE
              AND icr.email_type <> 'Newsletter'
            ) THEN LOWER(icr.ame_calculated_campaign_name)
            ELSE LOWER(icr.mapped_platform)
          END AS campaign_group,
          ROUND(
            SUM(icr.email_clicks_1d) / NULLIF(NULLIF(SUM(icr.email_sends), 0), 0),
            4
          ) AS click_through_rate_1d,
          SUM(icr.email_sends) AS total_sends,
          SUM(icr.email_clicks_1d) AS total_clicks
        FROM
          iterable_crm_reporting AS icr
          LEFT OUTER JOIN se_user_attributes AS sua ON icr.shiro_user_id = sua.shiro_user_id
        WHERE
          icr.send_event_date = CURRENT_DATE - INTERVAL '1 DAY'
          AND sua.main_affiliate_brand = 'Secret Escapes'
        GROUP BY
          icr.crm_channel_type,
          CASE
            WHEN (
              icr.is_automated_campaign = TRUE
              AND icr.email_type <> 'Newsletter'
            ) THEN LOWER(icr.ame_calculated_campaign_name)
            ELSE LOWER(icr.mapped_platform)
          END
      ),
      ranked_campaigns AS (
        SELECT
          crm_channel_type,
          campaign_group,
          click_through_rate_1d,
          total_sends,
          total_clicks,
          ROW_NUMBER() OVER (
            PARTITION BY crm_channel_type
            ORDER BY
              click_through_rate_1d DESC NULLS LAST
          ) AS rn
        FROM
          campaign_performance
      )
      SELECT
        crm_channel_type,
        campaign_group,
        click_through_rate_1d,
        total_sends,
        total_clicks
      FROM
        ranked_campaigns
      WHERE
        rn = 1
      ORDER BY
        click_through_rate_1d DESC NULLS LAST
    question: What was the strongest performing campaign per crm channel yesterday?
    verified_at: 1765973235
    verified_by: daisy anderson
    use_as_onboarding_question: false
  - name: '"What campaigns sent out yesterday, and how was it different to last week?"'
    sql: |-
      WITH yesterday_campaigns AS (
        SELECT
          CASE
            WHEN (
              icr.is_automated_campaign = TRUE
              AND icr.email_type <> 'Newsletter'
            ) THEN LOWER(icr.ame_calculated_campaign_name)
            ELSE LOWER(icr.mapped_platform)
          END AS campaign_group,
          SUM(icr.email_sends) AS yesterday_sends,
          ROUND(
            SUM(icr.email_opens_1d) / NULLIF(NULLIF(SUM(icr.email_sends), 0), 0),
            4
          ) AS yesterday_open_rate,
          ROUND(
            SUM(icr.email_clicks_1d) / NULLIF(NULLIF(SUM(icr.email_sends), 0), 0),
            4
          ) AS yesterday_ctr
        FROM
          iterable_crm_reporting AS icr
          LEFT OUTER JOIN se_user_attributes AS sua ON icr.shiro_user_id = sua.shiro_user_id
        WHERE
          icr.crm_channel_type = 'email'
          AND NOT LOWER(icr.combined_email_name) LIKE '%partner%'
          AND NOT LOWER(icr.combined_email_name) LIKE '%media%'
          AND icr.send_event_date = CURRENT_DATE - INTERVAL '1 DAY'
          AND sua.main_affiliate_brand = 'Secret Escapes'
        GROUP BY
          1
      ),
      last_week_campaigns AS (
        SELECT
          CASE
            WHEN (
              icr.is_automated_campaign = TRUE
              AND icr.email_type <> 'Newsletter'
            ) THEN LOWER(icr.ame_calculated_campaign_name)
            ELSE LOWER(icr.mapped_platform)
          END AS campaign_group,
          SUM(icr.email_sends) AS last_week_sends,
          ROUND(
            SUM(icr.email_opens_1d) / NULLIF(NULLIF(SUM(icr.email_sends), 0), 0),
            4
          ) AS last_week_open_rate,
          ROUND(
            SUM(icr.email_clicks_1d) / NULLIF(NULLIF(SUM(icr.email_sends), 0), 0),
            4
          ) AS last_week_ctr
        FROM
          iterable_crm_reporting AS icr
          LEFT OUTER JOIN se_user_attributes AS sua ON icr.shiro_user_id = sua.shiro_user_id
        WHERE
          icr.crm_channel_type = 'email'
          AND NOT LOWER(icr.combined_email_name) LIKE '%partner%'
          AND NOT LOWER(icr.combined_email_name) LIKE '%media%'
          AND icr.send_event_date = CURRENT_DATE - INTERVAL '8 DAYS'
          AND sua.main_affiliate_brand = 'Secret Escapes'
        GROUP BY
          1
      )
      SELECT
        COALESCE(y.campaign_group, lw.campaign_group) AS campaign_group,
        COALESCE(y.yesterday_sends, 0) AS yesterday_sends,
        COALESCE(lw.last_week_sends, 0) AS last_week_sends,
        COALESCE(y.yesterday_sends, 0) - COALESCE(lw.last_week_sends, 0) AS sends_difference,
        y.yesterday_open_rate,
        lw.last_week_open_rate,
        y.yesterday_ctr,
        lw.last_week_ctr
      FROM
        yesterday_campaigns AS y FULL
        OUTER JOIN last_week_campaigns AS lw ON y.campaign_group = lw.campaign_group
      ORDER BY
        yesterday_sends DESC NULLS LAST
    question: What campaigns sent out yesterday, and how was it different to last week?
    verified_at: 1765973312
    verified_by: daisy anderson
    use_as_onboarding_question: false
  - name: '"What was the main campaign sent yesterday in each territory group?"'
    sql: |-
      WITH territory_campaigns AS (
        SELECT
          CASE
            WHEN icr.current_affiliate_territory IN ('DE', 'AT', 'CH') THEN 'DACH'
            WHEN icr.current_affiliate_territory IN ('UK', 'Guardian - UK') THEN 'UK'
            ELSE 'ROW'
          END AS territory_group,
          CASE
            WHEN (
              icr.is_automated_campaign = TRUE
              AND icr.email_type <> 'Newsletter'
            ) THEN LOWER(icr.ame_calculated_campaign_name)
            ELSE LOWER(icr.mapped_platform)
          END AS campaign_group,
          SUM(icr.email_sends) AS total_sends
        FROM
          iterable_crm_reporting AS icr
          LEFT OUTER JOIN se_user_attributes AS sua ON icr.shiro_user_id = sua.shiro_user_id
        WHERE
          icr.crm_channel_type = 'email'
          AND NOT LOWER(icr.combined_email_name) LIKE '%partner%'
          AND NOT LOWER(icr.combined_email_name) LIKE '%media%'
          AND icr.send_event_date = CURRENT_DATE - INTERVAL '1 DAY'
          AND sua.main_affiliate_brand = 'Secret Escapes'
        GROUP BY
          CASE
            WHEN icr.current_affiliate_territory IN ('DE', 'AT', 'CH') THEN 'DACH'
            WHEN icr.current_affiliate_territory IN ('UK', 'Guardian - UK') THEN 'UK'
            ELSE 'ROW'
          END,
          CASE
            WHEN (
              icr.is_automated_campaign = TRUE
              AND icr.email_type <> 'Newsletter'
            ) THEN LOWER(icr.ame_calculated_campaign_name)
            ELSE LOWER(icr.mapped_platform)
          END
      ),
      ranked_campaigns AS (
        SELECT
          territory_group,
          campaign_group,
          total_sends,
          ROW_NUMBER() OVER (
            PARTITION BY territory_group
            ORDER BY
              total_sends DESC NULLS LAST
          ) AS rn
        FROM
          territory_campaigns
      )
      SELECT
        territory_group,
        campaign_group,
        total_sends
      FROM
        ranked_campaigns
      WHERE
        rn = 1
      ORDER BY
        total_sends DESC NULLS LAST
    question: What was the main campaign sent yesterday in each territory group?
    verified_at: 1765973363
    verified_by: daisy anderson
    use_as_onboarding_question: false
  - name: '"What campaign had the biggest impact on overall bookings in DACH on sunday?"'
    sql: |-
      SELECT
        CASE
          WHEN (
            icr.is_automated_campaign = TRUE
            AND icr.email_type <> 'Newsletter'
          ) THEN LOWER(icr.ame_calculated_campaign_name)
          ELSE LOWER(icr.mapped_platform)
        END AS campaign_group,
        SUM(icr.bookings_7d_lnd) AS total_bookings,
        SUM(icr.email_sends) AS total_sends,
        ROUND(
          SUM(icr.bookings_7d_lnd) / NULLIF(NULLIF(SUM(icr.email_clicks_7d), 0), 0),
          4
        ) AS conversion_rate_7d
      FROM
        iterable_crm_reporting AS icr
        LEFT OUTER JOIN se_calendar AS sc ON icr.send_event_date = sc.date_value
        LEFT OUTER JOIN se_user_attributes AS sua ON icr.shiro_user_id = sua.shiro_user_id
      WHERE
        icr.crm_channel_type = 'email'
        AND NOT LOWER(icr.combined_email_name) LIKE '%partner%'
        AND NOT LOWER(icr.combined_email_name) LIKE '%media%'
        AND icr.current_affiliate_territory IN ('DE', 'AT', 'CH')
        AND sc.day_name = 'Sun'
        AND send_event_date > current_date()-7
        AND sua.main_affiliate_brand = 'Secret Escapes'
      GROUP BY
        CASE
          WHEN (
            icr.is_automated_campaign = TRUE
            AND icr.email_type <> 'Newsletter'
          ) THEN LOWER(icr.ame_calculated_campaign_name)
          ELSE LOWER(icr.mapped_platform)
        END
      ORDER BY
        total_bookings DESC NULLS LAST
      LIMIT
        1
    question: What campaign had the biggest impact on overall bookings in DACH on sunday?
    verified_at: 1765973717
    verified_by: daisy anderson
    use_as_onboarding_question: false
  - name: '"What we''re the top 3 campaigns last sunday in each territory group for bookings?"'
    sql: |-
      WITH territory_campaigns AS (
        SELECT
          CASE
            WHEN icr.current_affiliate_territory IN ('DE', 'AT', 'CH') THEN 'DACH'
            WHEN icr.current_affiliate_territory IN ('UK', 'Guardian - UK') THEN 'UK'
            ELSE 'ROW'
          END AS territory_group,
          CASE
            WHEN (
              icr.is_automated_campaign = TRUE
              AND icr.email_type <> 'Newsletter'
            ) THEN LOWER(icr.ame_calculated_campaign_name)
            ELSE LOWER(icr.mapped_platform)
          END AS campaign_group,
          SUM(icr.bookings_1d_lnd) AS total_bookings
        FROM
          iterable_crm_reporting AS icr
          LEFT OUTER JOIN se_calendar AS sc ON icr.send_event_date = sc.date_value
          LEFT OUTER JOIN se_user_attributes AS sua ON icr.shiro_user_id = sua.shiro_user_id
        WHERE
          icr.crm_channel_type = 'email'
          AND NOT LOWER(icr.combined_email_name) LIKE '%partner%'
          AND NOT LOWER(icr.combined_email_name) LIKE '%media%'
          AND sc.day_name = 'Sun'
          AND icr.send_event_date = DATE_TRUNC('WEEK', CURRENT_DATE - INTERVAL '1 WEEK') + INTERVAL '6 DAYS'
          AND sua.main_affiliate_brand = 'Secret Escapes'
        GROUP BY
          CASE
            WHEN icr.current_affiliate_territory IN ('DE', 'AT', 'CH') THEN 'DACH'
            WHEN icr.current_affiliate_territory IN ('UK', 'Guardian - UK') THEN 'UK'
            ELSE 'ROW'
          END,
          CASE
            WHEN (
              icr.is_automated_campaign = TRUE
              AND icr.email_type <> 'Newsletter'
            ) THEN LOWER(icr.ame_calculated_campaign_name)
            ELSE LOWER(icr.mapped_platform)
          END
      ),
      ranked_campaigns AS (
        SELECT
          territory_group,
          campaign_group,
          total_bookings,
          ROW_NUMBER() OVER (
            PARTITION BY territory_group
            ORDER BY
              total_bookings DESC NULLS LAST
          ) AS rn
        FROM
          territory_campaigns
      )
      SELECT
        territory_group,
        campaign_group,
        ROUND(total_bookings, 4) AS total_bookings
      FROM
        ranked_campaigns
      WHERE
        rn <= 3
      ORDER BY
        territory_group,
        rn
    question: What we're the top 3 campaigns last sunday in each territory group for bookings?
    verified_at: 1765973973
    verified_by: daisy anderson
    use_as_onboarding_question: false
  - name: '"How many newsletter clicks happened last week, compared to the week before?"'
    sql: |-
      WITH last_week_clicks AS (
        SELECT
          SUM(icr.email_clicks_1d) AS last_week_clicks
        FROM
          iterable_crm_reporting AS icr
          LEFT OUTER JOIN se_user_attributes AS sua ON icr.shiro_user_id = sua.shiro_user_id
        WHERE
          icr.crm_channel_type = 'email'
          AND NOT LOWER(icr.combined_email_name) LIKE '%partner%'
          AND NOT LOWER(icr.combined_email_name) LIKE '%media%'
          AND sua.main_affiliate_brand = 'Secret Escapes'
          AND icr.email_type = 'Newsletter'
          AND icr.send_event_date >= DATE_TRUNC('WEEK', CURRENT_DATE - INTERVAL '1 WEEK')
          AND icr.send_event_date < DATE_TRUNC('WEEK', CURRENT_DATE)
      ),
      week_before_clicks AS (
        SELECT
          SUM(icr.email_clicks_1d) AS week_before_clicks
        FROM
          iterable_crm_reporting AS icr
          LEFT OUTER JOIN se_user_attributes AS sua ON icr.shiro_user_id = sua.shiro_user_id
        WHERE
          icr.crm_channel_type = 'email'
          AND NOT LOWER(icr.combined_email_name) LIKE '%partner%'
          AND NOT LOWER(icr.combined_email_name) LIKE '%media%'
          AND sua.main_affiliate_brand = 'Secret Escapes'
          AND icr.email_type = 'Newsletter'
          AND icr.send_event_date >= DATE_TRUNC('WEEK', CURRENT_DATE - INTERVAL '2 WEEKS')
          AND icr.send_event_date < DATE_TRUNC('WEEK', CURRENT_DATE - INTERVAL '1 WEEK')
      )
      SELECT
        COALESCE(lw.last_week_clicks, 0) AS last_week_clicks,
        COALESCE(wb.week_before_clicks, 0) AS week_before_clicks,
        COALESCE(lw.last_week_clicks, 0) - COALESCE(wb.week_before_clicks, 0) AS clicks_difference,
        CASE
          WHEN COALESCE(wb.week_before_clicks, 0) <> 0 THEN ROUND(
            (
              COALESCE(lw.last_week_clicks, 0) - COALESCE(wb.week_before_clicks, 0)
            ) / NULLIF(wb.week_before_clicks, 0),
            4
          )
        END AS clicks_pct_change
      FROM
        last_week_clicks AS lw
        CROSS JOIN week_before_clicks AS wb
    question: How many newsletter clicks happened last week, compared to the week before?
    verified_at: 1765985836
    verified_by: daisy anderson
    use_as_onboarding_question: false
  - name: '"What was the distribution of email sends across different territories last week?"'
    sql: |-
      SELECT
        icr.current_affiliate_territory,
        CASE
          WHEN icr.current_affiliate_territory IN ('DE', 'AT', 'CH') THEN 'DACH'
          WHEN icr.current_affiliate_territory IN ('UK', 'Guardian - UK') THEN 'UK'
          ELSE 'ROW'
        END AS territory_group,
        SUM(icr.email_sends) AS total_sends,
        ROUND(
          SUM(icr.email_sends) / NULLIF(NULLIF(SUM(SUM(icr.email_sends)) OVER (), 0), 0),
          4
        ) AS send_proportion
      FROM
        iterable_crm_reporting AS icr
        LEFT OUTER JOIN se_user_attributes AS sua ON icr.shiro_user_id = sua.shiro_user_id
      WHERE
        icr.crm_channel_type = 'email'
        AND NOT LOWER(icr.combined_email_name) LIKE '%partner%'
        AND NOT LOWER(icr.combined_email_name) LIKE '%media%'
        AND sua.main_affiliate_brand = 'Secret Escapes'
        AND icr.send_event_date >= DATE_TRUNC('WEEK', CURRENT_DATE - INTERVAL '1 WEEK')
        AND icr.send_event_date < DATE_TRUNC('WEEK', CURRENT_DATE)
      GROUP BY
        icr.current_affiliate_territory,
        territory_group
      ORDER BY
        total_sends DESC NULLS LAST
    question: What was the distribution of email sends across different territories last week?
    verified_at: 1765987223
    verified_by: robin patel
    use_as_onboarding_question: false
  - name: '"What was the overall CTR by territory group and email type last week"'
    sql: |-
      SELECT
        CASE
          WHEN icr.current_affiliate_territory IN ('DE', 'AT', 'CH') THEN 'DACH'
          WHEN icr.current_affiliate_territory IN ('UK', 'Guardian - UK') THEN 'UK'
          ELSE 'ROW'
        END AS territory_group,
        icr.email_type,
        ROUND(
          SUM(icr.email_clicks_1d) / NULLIF(NULLIF(SUM(icr.email_sends), 0), 0),
          4
        ) AS click_through_rate_1d
      FROM
        iterable_crm_reporting AS icr
        LEFT OUTER JOIN se_user_attributes AS sua ON icr.shiro_user_id = sua.shiro_user_id
      WHERE
        icr.crm_channel_type = 'email'
        AND NOT LOWER(icr.combined_email_name) LIKE '%partner%'
        AND NOT LOWER(icr.combined_email_name) LIKE '%media%'
        AND icr.send_event_date >= DATE_TRUNC('WEEK', CURRENT_DATE - INTERVAL '1 WEEK')
        AND icr.send_event_date < DATE_TRUNC('WEEK', CURRENT_DATE)
        AND sua.main_affiliate_brand = 'Secret Escapes'
      GROUP BY
        CASE
          WHEN icr.current_affiliate_territory IN ('DE', 'AT', 'CH') THEN 'DACH'
          WHEN icr.current_affiliate_territory IN ('UK', 'Guardian - UK') THEN 'UK'
          ELSE 'ROW'
        END,
        icr.email_type
      ORDER BY
        territory_group,
        click_through_rate_1d DESC NULLS LAST
    question: What was the overall CTR by territory group and email type last week
    verified_at: 1765987300
    verified_by: robin patel
    use_as_onboarding_question: false
module_custom_instructions:
  sql_generation: |-
    # --- SECTION 1: IDENTITY & SCOPE ---
    - You are an expert analyst for CRM Analysis and SQL generation.
    - Use ILIKE for all string comparisons to ensure case-insensitivity.
    - Never sum ID columns (e.g., `user_id`, `campaign_id`, or columns ending in _ID).
    - Always apply a filter for the main affiliate brand by LEFT JOINING `iterable_crm_reporting` to `se_user_attributes` on `user_id`.
    - EXCEPTION: Do not apply the brand filter if the user specifically asks for "all brands" or a specific brand (e.g., 'travelbird' or 'pigsback').

    # --- SECTION 2: BUSINESS VOCABULARY ---
    - "Campaigns" refers to the `campaign_group` field by default.
    - "Performance" for Email, Web Push, or In-App refers to CTR (Click-Through Rate) and CVR (Conversion Rate).
    - "Performance" for App or Push notifications refers to OR (Open Rate) and CVR.
    - If asked why App/Push uses OR: Explain that push notifications do not have clicks, so opens are the primary engagement metric.
    - "DACH" territory group includes affiliate territories 'DE', 'AT', or 'CH'.
    - "UK" territory group includes 'UK' or 'Guardian - UK'.
    - "ROW" (Rest of World) includes all other affiliate territories.

    # --- SECTION 3: METRIC LOGIC & MATH SAFETY ---
    - Use `NULLIF(denominator, 0)` for all ratios to prevent division by zero errors.
    - Use "7 day cap" metrics for YoY reporting or monthly reporting.
    - Use "1 day cap" metrics for WoW reporting or campaigns sent less than 7 days ago.
    - For YoY (Year-on-Year) on a single day or week: Join with `se_calendar` to match the same `se_week` or `se_week` and day name from the previous `se_year`.

    # --- SECTION 4: DEFAULT BEHAVIORS ---
    - Default Date Range: Filter `send_date` to the last 12 months unless specified otherwise.
    - Default Campaign Filter: Always exclude 'media' and 'partner' from `campaign_group` unless specifically requested.
    - If the user asks for "Top" items, default to Top 5 unless specified.
    - Always limit raw row queries to 100 rows unless "all" is explicitly requested.

    # --- SECTION 5: PRESENTATION ---
    - Format all decimal columns and currency to 4 decimal places.
    - Format ratios (CTR, CVR, OR) as percentages (multiply by 100 and add '%').
    - Always return the `campaign_group` or `user_id` name/label when an entity is requested.